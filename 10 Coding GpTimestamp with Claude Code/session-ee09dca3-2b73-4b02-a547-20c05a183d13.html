<!DOCTYPE html>
<!-- Generated by claude-code-log v0.8.0 -->
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>GpDelphiUnits: Hi! I think we should extend HasElapsed function s...</title>
    
    <style>
/* Global styles shared across all templates */

/* CSS Variables for shared colors and consistent theming */
:root {
    /* Base colors */
    --code-bg-color: #f5f1e8;
    --tool-param-sep-color: #4b494822;

    /* Dimmed/transparent variants (66 = ~40% opacity) */
    --white-dimmed: #ffffff66;
    --highlight-dimmed: #e3f2fd66;
    --assistant-dimmed: #9c27b066;
    --info-dimmed: #2196f366;
    --warning-dimmed: #d9810066;
    --success-dimmed: #4caf5066;
    --error-dimmed: #f4433666;
    --neutral-dimmed: #f8f9fa66;
    --tool-input-dimmed: #fff3cd66;
    --thinking-dimmed: #f0f0f066;
    --tool-result-dimmed: #e8f5e866;
    --session-bg-dimmed: #e8f4fd66;
    --ide-notification-dimmed: #d2d6d966;

    /* Fully transparent variants (88 = ~53% opacity) */
    --highlight-semi: #e3f2fd88;
    --error-semi: #ffebee88;
    --neutral-semi: #f8f9fa88;

    /* Slightly transparent variants (55 = ~33% opacity) */
    --highlight-light: #e3f2fd55;

    /* Solid colors for text and accents */
    --text-muted: #666;
    --text-secondary: #495057;

    /* Font families */
    --font-monospace: 'Fira Code', 'Monaco', 'Consolas', 'SF Mono', 'Inconsolata', 'Droid Sans Mono', 'Source Code Pro', 'Ubuntu Mono', 'Cascadia Code', 'Menlo', monospace;
    --font-ui: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

body {
    font-family: var(--font-monospace);
    line-height: 1.5;
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
    background: linear-gradient(90deg, #f3d6d2, #f1dcce, #f0e4ca, #eeecc7, #e3ecc3, #d5eac0, #c6e8bd, #b9e6bc, #b6e3c5, #b3e1cf);
    color: #333;
}

h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 1.8em;
}

/* Common typography */

code {
    background-color: var(--code-bg-color);
    padding: 2px 4px;
    border-radius: 3px;
    font-family: var(--font-monospace);
    line-height: 1.5;
}


pre {
    background-color: #12121212;
    padding: 10px;
    border-radius: 5px;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-word;
    font-family: var(--font-monospace);
    line-height: 1.5;
}

/* Common card styling */
.card-base {
    background-color: #ffffff66;
    border-radius: 8px;
    padding: 16px;
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-left: #ffffff66 1px solid;
    border-top: #ffffff66 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
}

.card-base:hover {
    box-shadow: -10px -10px 15px #eeeeee66, 10px 10px 15px #00000022;
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Common header styling */
.header {
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
}

.header > span:first-child {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

/* Tool summary in header */
.tool-summary {
    font-weight: normal;
    color: var(--text-muted);
    font-size: 0.95em;
    word-break: break-all;
    overflow-wrap: anywhere;
    display: inline;
}

/* Timestamps */
.timestamp {
    font-size: 0.85em;
    color: #666;
    font-weight: normal;
}

/* Floating action buttons */
.floating-btn {
    position: fixed;
    right: 20px;
    background-color: #e8f4fd66;
    color: #666;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 1.2em;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s, transform 0.2s;
    z-index: 1000;
    text-decoration: none;
}

.floating-btn:hover {
    background-color: #e8f4fdcc;
    transform: translateY(-2px);
}

.floating-btn:visited {
    color: #666;
}

/* Floating buttons positioning */
.scroll-top.floating-btn {
    bottom: 20px;
}

.toggle-details.floating-btn {
    bottom: 80px;
}

.filter-messages.floating-btn {
    bottom: 140px;
}

.timeline-toggle.floating-btn {
    bottom: 200px;
}
/* Message and content styles */
.message {
    margin-bottom: 1em;
    margin-left: 1em;
    padding: 1em;
    border-radius: 8px;
    border-left: var(--white-dimmed) 2px solid;
    background-color: var(--highlight-light);
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-top: var(--white-dimmed) 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
}

/* Message header info styling */
.header-info {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
}

.timestamp-row {
    display: flex;
    flex-direction: row;
    align-items: normal;
    gap: 8px;
}

.pair-duration {
    font-size: 80%;
    color: #666;
    font-style: italic;
}

.token-usage {
    font-size: 0.75em;
    color: #888;
}

/* Paired message styling */
.message.paired-message {
    margin-bottom: 0;
}

.message.paired-message.pair_first {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    border-bottom: none;
}

.message.paired-message.pair_last {
    margin-top: 0;
    margin-bottom: 1em;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    border-top: 1px solid #00000011;
}

.message.paired-message.pair_middle {
    margin-top: 0;
    border-radius: 0;
    border-top: 1px solid #00000011;
    border-bottom: none;
}

.session-divider {
    margin: 70px 0;
    border-top: 2px solid #fff;
}

/* Message type styling */
.user {
    border-left-color: #ff9800;
    margin-left: 0;
}

.assistant {
    border-left-color: #9c27b0;
}

/* Dimmed assistant when paired with thinking */
.assistant.paired-message {
    border-left-color: var(--assistant-dimmed);
}

.system {
    border-left-color: #d98100;
    margin-left: 0;
}

.system-warning {
    border-left-color: #2196f3;
    background-color: var(--highlight-semi);
    margin-left: 2em; /* Extra indent - assistant-initiated */
}

.system-error {
    border-left-color: #f44336;
    background-color: var(--error-semi);
    margin-left: 0;
}

.system-info {
    border-left-color: var(--info-dimmed);
    background-color: var(--highlight-dimmed);
    margin-left: 2em; /* Extra indent - assistant-initiated */
    font-size: 80%;
}

/* Command output styling */
.command-output {
    background-color: #1e1e1e11;
    border-left-color: var(--warning-dimmed);
}

.command-output-content {
    background-color: #1e1e1e08;
    padding: 12px;
    border-radius: 4px;
    border: 1px solid #00000011;
    margin-top: 8px;
    font-family: var(--font-monospace);
    font-size: 0.9em;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #333;
    overflow-x: auto;
}

/* Bash command styling */
.bash-input {
    background-color: #1e1e1e08;
    border-left-color: #4caf50;
}

.bash-prompt {
    color: #4caf50;
    font-weight: bold;
    font-size: 1.1em;
    margin-right: 8px;
}

.bash-command {
    font-family: var(--font-monospace);
    font-size: 0.95em;
    color: #2c3e50;
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
}

/* Bash output styling */
.bash-output {
    background-color: var(--neutral-dimmed);
    border-left-color: #607d8b;
}

.bash-stdout {
    background-color: #1e1e1e05;
    padding: 12px;
    border-radius: 4px;
    border: 1px solid #00000011;
    margin: 8px 0;
    font-family: var(--font-monospace);
    font-size: 0.9em;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #333;
    overflow-x: auto;
}

.bash-stderr {
    background-color: #ffebee;
    padding: 12px;
    border-radius: 4px;
    border: 1px solid #ffcdd2;
    margin: 8px 0;
    font-family: var(--font-monospace);
    font-size: 0.9em;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #c62828;
    overflow-x: auto;
}

.bash-empty {
    color: #999;
    font-style: italic;
}

/* Bash tool content styling (Tool Use message) */
.bash-tool-content {
    margin: 8px 0;
}

.bash-tool-description {
    color: var(--text-muted);
    font-size: 0.95em;
    margin-bottom: 8px;
    line-height: 1.4;
}

.content pre.bash-tool-command {
    background-color: var(--code-bg-color);
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid var(--tool-param-sep-color);
    font-family: var(--font-monospace);
    font-size: 0.9em;
    color: #2c3e50;
    margin: 0;
    overflow-x: auto;
}

.tool_use {
    border-left-color: #4caf50;
    margin-left: 2em; /* Extra indent - assistant-initiated */
}

.tool_result {
    border-left-color: var(--success-dimmed);
    margin-left: 2em; /* Extra indent - assistant-initiated */
}

.tool_result.error {
    border-left-color: var(--error-dimmed);
    background-color: var(--error-semi);
}

.message.tool_use pre, .message.tool_result pre {
    font-size: 80%;
}

/* Sidechain message styling */
.sidechain {
    opacity: 0.85;
    background-color: var(--neutral-semi);
    border-left-width: 2px;
    border-left-style: dashed;
}

/* Sidechain indentation hierarchy */
.sidechain.user {
    margin-left: 3em; /* Sub-assistant Prompt - nested below Task tool use (2em) */
}

.sidechain.assistant {
    margin-left: 4em; /* Sub-assistant - nested below prompt (3em) */
}

.sidechain.tool_use,
.sidechain.tool_result {
    margin-left: 5em; /* Sub-assistant tools - nested below assistant (4em) */
}

.sidechain .sidechain-indicator {
    color: var(--text-muted);
    font-size: 0.9em;
    margin-bottom: 5px;
    padding: 2px 6px;
    background-color: #e9ecef88;
    border-radius: 3px;
    display: inline-block;
}

.thinking {
    border-left-color: var(--assistant-dimmed);
}

/* Full purple when thinking is paired (as pair_first) */
.thinking.paired-message.pair_first {
    border-left-color: #9c27b0;
}

.image {
    border-left-color: #d48a5e;
    margin-left: 0; /* Align with user messages */
}

/* Session header styling */
.session-header {
    background-color: var(--session-bg-dimmed);
    border-radius: 8px;
    padding: 16px;
    margin: 30px 0 20px 0;
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-left: var(--white-dimmed) 1px solid;
    border-top: var(--white-dimmed) 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
}

.session-header .header {
    margin-bottom: 8px;
    font-size: 1.2em;
}

/* IDE notification styling */
.ide-notification {
    background-color: var(--ide-notification-dimmed);
    border-left: #9c27b0 2px solid;
    padding: 8px 12px;
    margin: 8px 0;
    border-radius: 4px;
    font-size: 80%;
    font-style: italic;
}

/* IDE selection styling */
.ide-selection-collapsible {
    margin-top: 4px;
}

.ide-selection-collapsible summary {
    cursor: pointer;
    color: var(--text-muted);
    user-select: none;
}

.ide-selection-collapsible summary:hover {
    color: #333;
}

.ide-selection-content {
    margin-top: 8px;
    padding: 8px;
    background-color: #f8f9fa;
    border-radius: 3px;
    border: 1px solid #dee2e6;
    font-family: var(--font-monospace);
    font-size: 0.85em;
    line-height: 1.4;
    white-space: pre-wrap;
    overflow-x: auto;
}

/* Content styling */
.content {
    word-wrap: break-word;
}

.content>pre {
    background-color: transparent;
    padding: 0;
    border-radius: 0;
}

.header:has(+ .content > details) {
    margin-left: 1em;
}

/* Assistant and Thinking content styling */
.assistant .content,
.thinking-text,
.user.compacted .content {
    font-family: var(--font-ui);
}

/* Code block styling */
pre > code {
    display: block;
}

/* Tool content styling */
.tool-content {
    background-color: var(--neutral-dimmed);
    border-radius: 4px;
    padding: 8px;
    margin: 8px 0;
    overflow-x: auto;
    box-shadow: -4px -4px 10px #eeeeee33, 4px 4px 10px #00000007;
    border-left: var(--white-dimmed) 1px solid;
    border-top: var(--white-dimmed) 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
}

/* Tool parameter table styling */
.tool-params-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 80%;
}

.tool-params-table tr {
    border-bottom: 1px solid var(--tool-param-sep-color);
}

.tool-param-key {
    padding: 4px;
    font-weight: 600;
    color: var(--text-secondary);
    vertical-align: top;
    width: 8em;
}

.tool-param-value {
    padding: 4px;
    color: #212529;
    vertical-align: top;
}

.tool-param-structured {
    margin: 0;
    background-color: #f8f9fa;
    padding: 4px;
    border-radius: 3px;
}

.tool-param-collapsible {
    margin: 0;
}

.tool-param-collapsible summary {
    cursor: pointer;
    color: var(--text-muted);
}

.tool-param-collapsible summary:hover {
    color: #333;
}

.tool-param-full {
    margin-top: 4px;
    word-break: break-all;
}

.tool-params-empty {
    color: #999;
    font-style: italic;
}

.tool-result {
    background-color: var(--tool-result-dimmed);
    border-left: #4caf5088 1px solid;
}

.tool-use {
    background-color: var(--highlight-dimmed);
    border-left: #2196f388 1px solid;
}

.thinking-content {
    background-color: var(--thinking-dimmed);
    border-left: #66666688 1px solid;
}

.thinking-text {
    font-family: var(--font-ui);
    font-size: 90%;
    word-wrap: break-word;
    color: #555;
}

.tool-input {
    background-color: var(--tool-input-dimmed);
    border-radius: 4px;
    padding: 6px;
    margin: 4px 0;
    font-size: 0.9em;
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-left: var(--white-dimmed) 1px solid;
    border-top: var(--white-dimmed) 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
}

/* Session summary styling */
.session-summary {
    background-color: var(--white-dimmed);
    border-left: #4caf5088 4px solid;
    padding: 12px;
    margin: 8px 0;
    border-radius: 0 4px 4px 0;
    font-style: italic;
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-top: var(--white-dimmed) 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
}

/* Collapsible details styling */
details summary {
    cursor: pointer;
    color: var(--text-muted);
}

.collapsible-details {
    margin-top: -2em;
}

.collapsible-details summary {
    position: relative;
    cursor: pointer;
}

/* Collapsible code blocks (Read/Edit/Write tools) */
.tool_result .collapsible-code {
    margin-top: -2.5em;
}

.tool_result .collapsible-code summary {
    cursor: pointer;
    padding-top: 0.5em;
    background: var(--color-bg-secondary);
    border-radius: 4px;
}

.tool_result .collapsible-code summary:hover {
    background: var(--color-bg-tertiary);
}

/* Preview content styling - shown when closed */
.collapsible-details:not([open]) .preview-content {
    margin-top: 4px;
}

/* Tool result preview content with gradient fade */
.tool_result .preview-content {
    opacity: 0.7;
    mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
}

/* Hide preview content when details/collapsible is open */
.collapsible-details[open] .preview-content,
.collapsible-code[open] .preview-content {
    display: none;
}

/* Style the full details content */
.details-content {
    margin-top: 4px;
}

/* Hide details content when closed */
.collapsible-details:not([open]) .details-content {
    display: none;
}

/* Style pre and other elements within details content */
.content pre {
    background-color: transparent;
    padding: 0;
    margin: 0;
    color: #555;
    line-height: 1.3;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Message filtering */
.message.filtered-hidden {
    display: none;
}

/* ANSI color classes */
/* Standard colors */
.ansi-black { color: #000000; }
.ansi-red { color: #cd3131; }
.ansi-green { color: #0dbc79; }
.ansi-yellow { color: #e5e510; }
.ansi-blue { color: #2472c8; }
.ansi-magenta { color: #bc3fbc; }
.ansi-cyan { color: #11a8cd; }
.ansi-white { color: #e5e5e5; }

/* Bright colors */
.ansi-bright-black { color: #666666; }
.ansi-bright-red { color: #f14c4c; }
.ansi-bright-green { color: #23d18b; }
.ansi-bright-yellow { color: #f5f543; }
.ansi-bright-blue { color: #3b8eea; }
.ansi-bright-magenta { color: #d670d6; }
.ansi-bright-cyan { color: #29b8db; }
.ansi-bright-white { color: #ffffff; }

/* Background colors */
.ansi-bg-black { background-color: #000000; }
.ansi-bg-red { background-color: #cd3131; }
.ansi-bg-green { background-color: #0dbc79; }
.ansi-bg-yellow { background-color: #e5e510; }
.ansi-bg-blue { background-color: #2472c8; }
.ansi-bg-magenta { background-color: #bc3fbc; }
.ansi-bg-cyan { background-color: #11a8cd; }
.ansi-bg-white { background-color: #e5e5e5; }

/* Bright background colors */
.ansi-bg-bright-black { background-color: #666666; }
.ansi-bg-bright-red { background-color: #f14c4c; }
.ansi-bg-bright-green { background-color: #23d18b; }
.ansi-bg-bright-yellow { background-color: #f5f543; }
.ansi-bg-bright-blue { background-color: #3b8eea; }
.ansi-bg-bright-magenta { background-color: #d670d6; }
.ansi-bg-bright-cyan { background-color: #29b8db; }
.ansi-bg-bright-white { background-color: #ffffff; }

/* Text styles */
.ansi-bold { font-weight: bold; }
.ansi-dim { opacity: 0.7; }
.ansi-italic { font-style: italic; }
.ansi-underline { text-decoration: underline; }
/* Session navigation styles */
.navigation {
    background-color: #f8f9fa66;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-left: #ffffff66 1px solid;
    border-top: #ffffff66 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
}

.navigation h2 {
    margin: 0 0 12px 0;
    font-size: 1.2em;
    color: #495057;
}

.session-nav {
    margin-top: 1em;
    display: grid;
    gap: 8px;
}

.session-link {
    padding: 8px 12px;
    background-color: #ffffff66;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-decoration: none;
    color: #495057;
    transition: background-color 0.2s;
}

.session-link:hover {
    background-color: #ffffff99;
}

.session-link-title {
    font-weight: 600;
    font-size: 0.9em;
}

.session-link-meta {
    font-size: 0.8em;
    color: #6c757d;
    margin-top: 2px;
}

/* Project-specific session navigation */
.project-sessions {
    margin-top: 15px;
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.project-sessions h4 {
    margin: 0 0 10px 0;
    font-size: 0.9em;
    color: #495057;
    font-weight: 600;
}

.project-sessions .session-link {
    padding: 6px 8px;
    font-size: 0.8em;
    margin-bottom: 4px;
}

.project-sessions .session-link-title {
    font-size: 0.85em;
}

.project-sessions .session-link-meta {
    font-size: 0.75em;
}

/* Combined transcript link */
.combined-transcript-link {
    display: inline-block;
    padding: 8px 12px;
    background-color: #ffffff66;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-decoration: none;
    color: #495057;
    font-weight: 500;
    transition: background-color 0.2s;
}

.combined-transcript-link:hover {
    background-color: #ffffff99;
    text-decoration: none;
}
/* Filter toolbar and controls */
.filter-toolbar {
    background-color: #f8f9fa66;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-left: #ffffff66 1px solid;
    border-top: #ffffff66 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
    display: none;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(8px);
}

.filter-toolbar.visible {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.toolbar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #dee2e633;
    gap: 16px;
}

.toolbar-header h3 {
    margin: 0;
    font-size: 1em;
    color: #495057;
    font-weight: 600;
}

.close-toolbar-btn {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 20px;
    padding: 5px;
    border-radius: 50%;
    transition: all 0.2s;
    line-height: 1;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.close-toolbar-btn:hover {
    background-color: #ffffff66;
    color: #333;
}

.filter-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #dee2e633;
}


.filter-toggles {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}


.filter-toggle {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    background-color: transparent;
    color: #495057;
    font-size: 0.85em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}

.filter-toggle:hover {
    background-color: #ffffff99;
    transform: translateY(-1px);
}

.filter-toggle.active {
    background-color: #ffffffaa;
}

.filter-toggle.active:hover {
    background-color: #ffffff66;
}

/* Color-coded filter buttons */
.filter-toggle[data-type="user"] {
    border-color: #ff9800;
    border-width: 2px;
}

.filter-toggle[data-type="system"] {
    border-color: #d98100;
    border-width: 2px;
}

.filter-toggle[data-type="tool"] {
    border-color: #4caf50;
    border-width: 2px;
}

.filter-toggle[data-type="assistant"] {
    border-color: #9c27b0;
    border-width: 2px;
}

.filter-toggle[data-type="thinking"] {
    border-color: #9c27b066;
    border-width: 2px;
}

.filter-actions {
    display: flex;
    gap: 6px;
}

.filter-action-btn {
    padding: 4px 8px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background-color: #ffffff66;
    color: #6c757d;
    font-size: 0.75em;
    cursor: pointer;
    transition: background-color 0.2s;
}

.filter-action-btn:hover {
    background-color: #ffffff99;
}

.filter-toggle .count {
    opacity: 0.7;
    font-size: 0.9em;
    margin-left: 2px;
}

.filter-toggle.active .count {
    opacity: 1;
}

.filter-messages.active {
    background-color: #fff3cd;
}
/* TodoWrite tool styling */
.todo-write {
    background-color: #f0f8ff66;
    border-left: #4169e188 3px solid;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
}

.tool-header {
    font-weight: 600;
    margin-bottom: 12px;
    color: #2c3e50;
    font-size: 1.1em;
}

.todo-list {
    background-color: #ffffff66;
    border-radius: 6px;
    padding: 8px;
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-left: #ffffff66 1px solid;
    border-top: #ffffff66 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
}

.todo-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 4px;
    border-bottom: 1px solid #f0f3f6;
    transition: background-color 0.2s ease;
}

.todo-item:last-child {
    border-bottom: none;
}

.todo-item:hover {
    background-color: #f8f9fa;
}

.todo-item.completed {
    opacity: 0.7;
}

.todo-item.completed .todo-content {
    text-decoration: line-through;
    color: #6c757d;
}

.todo-item input[type="checkbox"] {
    margin: 0;
    cursor: default;
}

.todo-status {
    font-size: 1.1em;
    line-height: 1;
}

.todo-content {
    flex: 1;
    color: #333;
    font-weight: 500;
    font-size: 90%;
    font-family: var(--font-ui);
}

.todo-id {
    font-size: 0.8em;
    color: #6c757d;
    font-weight: normal;
}

/* Priority-based left border colors */
.todo-item.high {
    border-left: 3px solid #dc3545;
}

.todo-item.medium {
    border-left: 3px solid #ffc107;
}

.todo-item.low {
    border-left: 3px solid #28a745;
}

/* Status-based background tints */
.todo-item.in_progress {
    background-color: #fff3cd;
}

.todo-item.completed {
    background-color: #d4edda;
}
/* Timeline-specific styles for vis-timeline */

/* Timeline toggle button styling */
.timeline-toggle.active {
    background-color: #fff3cd;
}

/* Timeline container positioning and styling */
#timeline-container {
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: top 0.3s ease;
    position: relative;
}

/* Timeline resize handle styling */
#timeline-resize-handle {
    transition: background 0.2s ease;
}

#timeline-resize-handle:hover {
    background: linear-gradient(to bottom, transparent, #bbb) !important;
}

#timeline-resize-handle:hover>div {
    background: #777 !important;
}

#timeline-resize-handle:active {
    background: linear-gradient(to bottom, transparent, #999) !important;
}

#timeline-resize-handle:active>div {
    background: #555 !important;
}

/* vis-timeline customizations */
.vis-timeline {
    border: none !important;
}

.vis-labelset .vis-label {
    font-size: 12px !important;
    font-weight: 500 !important;
    color: #495057 !important;
}

/* Timeline items styling */
.vis-item {
    border-radius: 4px !important;
    border: 1px solid #ddd !important;
    font-size: 11px !important;
    /* Stuck item workaround, see: https://github.com/visjs/vis-timeline/issues/494#issuecomment-1638974075 */
    transform: scale(0);
}

.vis-item .vis-item-content {
    padding: 2px 4px !important;
}

.vis-item.vis-selected {
    border-color: #007bff !important;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25) !important;
}

/* Message type specific styling */
.vis-item.timeline-item-user {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
}

.vis-item.timeline-item-assistant {
    background-color: #f3e5f5 !important;
    border-color: #9c27b0 !important;
}

.vis-item.timeline-item-tool_use {
    background-color: #fff8e1 !important;
    border-color: #ffc107 !important;
}

.vis-item.timeline-item-tool_result {
    background-color: #e8f5e8 !important;
    border-color: #4caf50 !important;
}

.vis-item.timeline-item-thinking {
    background-color: #fce4ec !important;
    border-color: #e91e63 !important;
}

.vis-item.timeline-item-system {
    background-color: #ffeee1 !important;
    border-color: #ff8707 !important;
}

.vis-item.timeline-item-image {
    background-color: #e1f5fe !important;
    border-color: #00bcd4 !important;
}

.vis-item.timeline-item-sidechain {
    background-color: #f5f5f5 !important;
    border-color: #9e9e9e !important;
}

/* Hide filtered timeline items */
.vis-item.timeline-filtered-hidden {
    display: none !important;
}

/* Timeline axis styling */
.vis-time-axis {
    border-top: 1px solid #ddd !important;
}

.vis-time-axis .vis-text {
    font-size: 11px !important;
    color: #666 !important;
}

/* Timeline navigation controls */
.vis-navigation {
    font-size: 12px !important;
}

/* Hide vis-timeline watermark if present */
.vis-timeline .vis-custom-time {
    display: none !important;
}

.vis-tooltip {
    max-width: 700px;
    padding: 1em !important;
    white-space: normal !important;
    font-family: inherit !important;
}

.vis-tooltip pre {
    margin: 0;
    padding: 0;
    background-color: transparent;
}

.vis-tooltip img {
    max-width: 700px;
}

.vis-tooltip div {
    white-space: normal;
}
/* Search Bar Styles */
.search-container {
    position: relative;
    width: 100%;
}

/* Keyboard shortcut hint */
.search-hint {
    position: absolute;
    right: 45px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    font-size: 0.75em;
    pointer-events: none;
    transition: opacity 0.2s;
}

.search-hint.hidden {
    opacity: 0;
    visibility: hidden;
}

/* Inline Search for Filter Toolbar */
.search-inline {
    width: 100%;
    margin-bottom: 12px;
}

/* In filter toolbar mode, search is always visible when toolbar is visible */
.filter-toolbar:not(.visible) .search-container {
    display: none;
}

.search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
}

.search-input {
    width: 100%;
    padding: 8px 40px 8px 12px;
    background: #ffffff88;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    color: #495057;
    font-size: 0.85em;
    font-family: inherit;
    transition: all 0.2s;
}

.search-input:focus {
    outline: none;
    border-color: #2196f3;
    background: #ffffff99;
    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
}

.search-input::placeholder {
    color: #666;
}

.search-clear {
    position: absolute;
    right: 15px;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 18px;
    padding: 5px;
    display: none;
    border-radius: 50%;
    transition: all 0.2s;
}

.search-clear:hover {
    color: #333;
    background: #ffffff66;
}

.search-clear.visible {
    display: block;
}

/* Search Results Counter */
.search-results-info {
    margin-top: 8px;
    font-size: 12px;
    color: #666;
    display: none;
}

.search-results-info.visible {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}

.search-navigation {
    display: flex;
    gap: 5px;
    align-items: center;
}

.search-options-inline {
    display: flex;
    gap: 12px;
    font-size: 0.75em;
}

.search-option-inline {
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    color: #666;
}

.search-option-inline:hover {
    color: #333;
}

.search-option-inline input[type="checkbox"] {
    cursor: pointer;
    margin: 0;
}

.search-nav-btn {
    background: #ffffff88;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    color: #333;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.search-nav-btn:hover:not(:disabled) {
    background: #ffffff99;
    border-color: #2196f3;
    transform: translateY(-1px);
}

.search-nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Search Match Highlighting */
.search-highlight {
    background-color: #ffeb3b;
    color: #000;
    padding: 0 2px;
    border-radius: 2px;
}

.search-highlight.current {
    background-color: #ff9800;
    color: #000;
}

/* Search Options */
.search-options {
    margin-top: 8px;
    display: flex;
    gap: 12px;
    font-size: 0.75em;
}

.search-option {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #666;
    transition: color 0.2s;
}

.search-option input[type="checkbox"] {
    cursor: pointer;
    accent-color: #2196f3;
}

.search-option label {
    cursor: pointer;
    user-select: none;
}

.search-option:hover {
    color: #333;
}

/* Index Page Search Results */
.search-results-panel {
    margin: 20px 0;
    padding: 20px;
    background-color: #ffffff66;
    border-radius: 8px;
    box-shadow: -7px -7px 10px #eeeeee44, 7px 7px 10px #00000011;
    border-left: #ffffff66 1px solid;
    border-top: #ffffff66 1px solid;
    border-bottom: #00000017 1px solid;
    border-right: #00000017 1px solid;
    display: none;
}

.search-results-panel.visible {
    display: block;
}

.search-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
}

.search-results-title {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
}

.search-close-btn {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 20px;
    padding: 5px;
    border-radius: 50%;
    transition: all 0.2s;
}

.search-close-btn:hover {
    color: #333;
    background: #ffffff66;
}

.search-result-group {
    margin-bottom: 20px;
}

.search-result-group-title {
    font-size: 14px;
    font-weight: 600;
    color: #2196f3;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.search-result-count {
    background: #ffffff88;
    color: #666;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: normal;
    border: 1px solid #dee2e6;
}

.search-result-item {
    padding: 12px;
    margin-bottom: 8px;
    background-color: #ffffff88;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: -3px -3px 5px #eeeeee22, 3px 3px 5px #00000008;
    border-left: #ffffff44 1px solid;
    border-top: #ffffff44 1px solid;
    border-bottom: #00000012 1px solid;
    border-right: #00000012 1px solid;
}

.search-result-item:hover {
    background-color: #ffffff99;
    transform: translateY(-1px);
    box-shadow: -5px -5px 8px #eeeeee33, 5px 5px 8px #00000012;
}

.search-result-item a {
    text-decoration: none;
    color: inherit;
    display: block;
}

.search-result-session {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
    font-weight: 500;
}

.search-result-excerpt {
    font-size: 13px;
    color: #495057;
    line-height: 1.4;
}

.search-result-excerpt .search-highlight {
    font-weight: 600;
    background-color: #ffeb3b;
    color: #000;
    padding: 0 2px;
    border-radius: 2px;
}

.search-result-meta {
    margin-top: 8px;
    font-size: 11px;
    color: #666;
    display: flex;
    gap: 15px;
    padding-top: 5px;
    border-top: 1px solid #dee2e611;
}

/* Removed floating search button - now integrated in filter toolbar */

/* No results message */
.search-no-results {
    text-align: center;
    padding: 30px;
    color: #666;
    font-size: 14px;
    background-color: #ffffff44;
    border-radius: 6px;
    margin: 10px 0;
}

/* Loading indicator */
.search-loading {
    text-align: center;
    padding: 20px;
    color: #666;
    background-color: #ffffff44;
    border-radius: 6px;
}

.search-loading::after {
    content: '...';
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* Keyboard shortcut hint */

/* Responsive adjustments */
@media (max-width: 768px) {
    .search-input {
        font-size: 0.8em;
    }

    .search-options {
        font-size: 0.7em;
    }
}
/* Edit tool diff styling */
.edit-tool-content {
    margin: 8px 0;
}

.edit-file-path {
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-size: 0.95em;
}

.edit-replace-all {
    color: var(--text-muted);
    font-size: 0.85em;
    font-style: italic;
    margin-bottom: 8px;
}

.edit-diff {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow-x: auto;
    font-family: var(--font-monospace);
    font-size: 80%;
    line-height: 2ex;
}

/* Diff line styling */
.diff-line {
    padding: 2px 4px 2px 2px;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.diff-marker {
    display: inline-block;
    width: 1.5em;
    text-align: center;
    user-select: none;
    color: var(--text-muted);
}

/* Line backgrounds */
.diff-removed {
    background-color: #ffebe9;
    border-left: 3px solid #f85149;
}

.diff-added {
    background-color: #dafbe1;
    border-left: 3px solid #3fb950;
}

.diff-context {
    background-color: var(--code-bg-color);
    border-left: 3px solid transparent;
}

/* Character-level highlighting */
.diff-char-removed {
    background-color: #ffcecb;
    border-radius: 2px;
}

.diff-char-added {
    background-color: #abf2bc;
    border-radius: 2px;
}

/* Remove default mark styling */
mark.diff-char-removed,
mark.diff-char-added {
    color: inherit;
}
/* Pygments syntax highlighting styles */

/* Base styles for highlighted code blocks */
.highlight {
    background: var(--color-bg-secondary);
    border-radius: 4px;
    overflow-x: auto;
}

.highlight pre {
    margin: 0;
    padding: 0.5em;
    line-height: 1.5;
    font-family: var(--font-monospace);
    white-space: pre;  /* Prevent line wrapping */
}

/* Smaller font for code blocks in markdown content (assistant messages, thinking, etc.) */
.content.markdown .highlight pre code {
    font-size: 80%;
}

/* Line numbers table styling */
.highlight .highlighttable {
    width: 100%;
    border-spacing: 0;
    background: transparent;
}

.highlight .highlighttable td {
    padding: 0;
    vertical-align: top;
}

.highlight .highlighttable td.linenos {
    width: 1%;
    text-align: right;
    user-select: none;
    border-right: 1px solid var(--color-border-dim);
}

.highlight .linenos pre {
    color: var(--color-text-dim);
    background: var(--color-bg-tertiary);
    padding: 0.65em 0.5em 0.5em 0.8em;
    margin: 0;
    line-height: 1.5;
    white-space: pre;
}

.highlight .linenos .normal {
    color: inherit;
}

.highlight td.code {
    width: 99%;
}

.highlight td.code pre {
    padding-left: 0.8em;
    line-height: 1.5;
}

/* Read tool specific styles */
.read-tool-content {
    font-weight: 600;
    color: var(--color-blue);
    margin: 0.5em 0;
    font-family: var(--font-monospace);
    font-size: 0.9em;
}

.read-tool-result {
    margin: 0.5em 0;
}

/* Unified styling for inline preview text in tool results */
.tool-result .line-count,
.tool-result .preview-text {
    font-size: 0.9em;
    color: var(--color-text-secondary);
    margin-left: 0.5em;
}

.read-tool-result .system-reminder {
    margin-top: 0.5em;
    padding: 0.5em;
    background: var(--color-bg-secondary);
    border-left: 3px solid var(--color-blue);
    border-radius: 4px;
    font-style: italic;
    font-size: 80%;
    color: var(--color-text-secondary);
}

/* Edit tool result specific styles */
.edit-tool-result {
    margin: 0.5em 0;
}

/* Multiedit tool specific styles */
.multiedit-tool-content {
    margin: 0.5em 0;
}

.multiedit-file-path {
    font-weight: 600;
    color: var(--color-purple);
    margin-bottom: 0.5em;
    font-family: var(--font-monospace);
    font-size: 0.9em;
}

.multiedit-count {
    font-size: 0.85em;
    color: var(--color-text-secondary);
    margin-bottom: 0.8em;
}

.multiedit-item {
    margin-bottom: 1em;
    border-left: 2px solid var(--color-border-dim);
    padding-left: 1em;
}

.multiedit-item-header {
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: 0.5em;
    font-size: 0.9em;
}

/* Write tool specific styles */
.write-tool-content {
    margin: 0.5em 0;
}

.write-file-path {
    font-weight: 600;
    color: var(--color-green);
    margin-bottom: 0.5em;
    font-family: var(--font-monospace);
    font-size: 0.9em;
    padding-left: 1.5em;
}


/* Pygments token styles (based on 'default' theme) */
.highlight { background: var(--color-bg-secondary); }
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #3D7B7B; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #9C6500 } /* Comment.Preproc */
.highlight .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.highlight .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #E40000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #008400 } /* Generic.Inserted */
.highlight .go { color: #717171 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #687822 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #717171; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #767600 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #A45A77 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
</head>

<body>
    <h1 id="title">GpDelphiUnits: Hi! I think we should extend HasElapsed function s...</h1>

    <!-- Timeline Component -->
    <!-- Timeline Component Template -->
<!-- vis-timeline integration for transcript visualization -->

<div id="timeline-container"
    style="display: none; position: sticky; top: 0; z-index: 100; background: white; border-bottom: 1px solid #ddd; width: 100vw; margin-left: calc(-50vw + 50%); overflow: hidden; min-height: 150px; max-height: 80vh;">
    <div id="timeline-visualization" style="height: calc(100% - 8px); width: 100%;"></div>
    <div id="timeline-resize-handle"
        style="position: absolute; bottom: 0; left: 0; right: 0; height: 8px; background: linear-gradient(to bottom, transparent, #ddd); cursor: ns-resize; display: flex; align-items: center; justify-content: center;">
        <div style="width: 40px; height: 3px; background: #999; border-radius: 2px;"></div>
    </div>
</div>

<script id="timeline-script">
    // Timeline functionality - inline for self-contained HTML
    (function () {
        let timeline = null;
        let items = null;
        let groups = null;
        let isTimelineLoaded = false;
        let timelineIdToElement = new Map(); // Map timeline IDs to DOM elements
        let isResizing = false;

        // Message type to group mapping
        const messageTypeGroups = {
            'user': { id: 'user', content: 'ü§∑ User', style: 'background-color: #e3f2fd;' },
            'assistant': { id: 'assistant', content: 'ü§ñ Assistant', style: 'background-color: #f3e5f5;' },
            'tool_use': { id: 'tool_use', content: 'üõ†Ô∏è Tool Use', style: 'background-color: #fff3e0;' },
            'tool_result': { id: 'tool_result', content: 'üß∞ Tool Result', style: 'background-color: #e8f5e8;' },
            'thinking': { id: 'thinking', content: 'üí≠ Thinking', style: 'background-color: #fce4ec;' },
            'system': { id: 'system', content: '‚öôÔ∏è System', style: 'background-color: #ffeee1;' },
            'image': { id: 'image', content: 'üñºÔ∏è Image', style: 'background-color: #e1f5fe;' },
            'sidechain': { id: 'sidechain', content: 'üîó Sub-assistant', style: 'background-color: #f5f5f5;' }
        };

        // Build timeline data from messages
        function buildTimelineData() {
            let latestTimeString = '1970-01-01 00:00:00';
            const timelineItems = [];
            const timelineGroups = [];
            const usedGroups = new Set();

            // Clear existing mapping
            timelineIdToElement.clear();

            // Get all messages from the page (including filtered ones - we'll hide them with CSS)
            const messages = document.querySelectorAll('.message:not(.session-header)');

            messages.forEach((messageEl, index) => {
                // Extract message data - handle both simple and complex CSS classes
                const classList = Array.from(messageEl.classList);
                let messageType = 'system'; // Default fallback

                // Check for sidechain first (sub-assistant messages)
                if (classList.includes('sidechain')) {
                    messageType = 'sidechain';
                } else if (classList.includes('system-warning') || classList.includes('system-error') || classList.includes('system-info')) {
                    messageType = 'system';
                } else {
                    // Look for standard message types
                    messageType = classList.find(cls =>
                        ['user', 'assistant', 'tool_use', 'tool_result', 'thinking', 'system', 'image'].includes(cls)
                    ) ?? 'system';
                }

                const timestampEl = messageEl.querySelector('.timestamp');
                if (!timestampEl) return; // Skip if no timestamp

                // Use raw timestamp from data attribute if available, otherwise fall back to text content
                const rawTimestamp = timestampEl.getAttribute('data-timestamp');
                const timestamp = rawTimestamp ?? timestampEl.textContent.trim();
                if (timestamp > latestTimeString) latestTimeString = timestamp;

                // Get message content preview
                const contentEl = messageEl.querySelector('.content');
                let content = '';
                if (contentEl) {
                    let textContent = contentEl.textContent ?? contentEl.innerText ?? '';

                    // For system messages, try to extract just the message without the prefix
                    if (messageType === 'system') {
                        // System messages often have format like "‚ö†Ô∏è System Warning: message content"
                        const systemMatch = textContent.match(/^[‚ö†Ô∏è‚ùå‚ÑπÔ∏è]?\s*System\s+\w+:\s*(.+)$/);
                        if (systemMatch) {
                            textContent = systemMatch[1];
                        }
                    }

                    content = textContent.length > 100 ? textContent.substring(0, 100) + '...' : textContent;
                }

                // For tool_use messages, try to extract the tool name
                if (messageType === 'tool_use') {
                    // Try to extract tool name from JSON content
                    const nameMatch = content.match(/"name":\s*"([^"]+)"/);
                    if (nameMatch) {
                        const toolName = nameMatch[1];
                        content = toolName + ': ' + content.replace(/"name":\s*"[^"]+",?\s*/, '');
                    } else {
                        // Fallback: try to extract from header if available
                        const headerEl = messageEl.querySelector('.header span');
                        if (headerEl) {
                            const headerText = headerEl.textContent ?? '';
                            const toolMatch = headerText.match(/üõ†Ô∏è\s*(.+) \(Id:.*/);
                            if (toolMatch) {
                                content = toolMatch[1].replace("Tool Use: ", "") + (content ? ': ' + content : '');
                            }
                        }
                    }
                }

                // Add group if not already added
                if (!usedGroups.has(messageType)) {
                    timelineGroups.push(messageTypeGroups[messageType]);
                    usedGroups.add(messageType);
                }

                // Store mapping for click handling
                timelineIdToElement.set(index, messageEl);

                // Format tooltip content with proper containment and styling
                let title = contentEl.innerHTML;
                title = title.includes("<pre") ? title : `<pre>${title}</pre>`;

                // Clean up collapsible details for tooltip display
                if (title.includes("<details")) {
                    title = title.replace(/(<summary>.*<\/summary>)/gs, '').replace(/<details class="collapsible-details">(.*?)<\/details>/gs, (m, p) => p)
                }

                // Clean up excessive whitespace in pre tags
                title = title.replace(/<pre([^>]*)>[\s\r\n]+(.*?)[\s\r\n]+<\/pre>/gs, (m, attrs, content) => `<pre${attrs}>${content}</pre>`)

                // Adjust content display based on message type
                let displayContent = content ?? messageTypeGroups[messageType].content;

                // Check for sidechain context regardless of primary message type
                if (classList.includes('sidechain')) {
                    // Override group for sidechain messages, but preserve the content
                    messageType = 'sidechain';

                    // For sidechain messages, prefix with appropriate icon based on original type
                    if (classList.includes('user')) {
                        displayContent = 'üìù ' + (content ?? 'Sub-assistant prompt');
                    } else if (classList.includes('assistant')) {
                        displayContent = 'üîó ' + (content ?? 'Sub-assistant response');
                    } else if (classList.includes('tool_use')) {
                        displayContent = 'üîó ' + (content ?? 'Sub-assistant tool use');
                    } else if (classList.includes('tool_result')) {
                        displayContent = 'üîó ' + (content ?? 'Sub-assistant tool result');
                    } else {
                        displayContent = 'üîó ' + (content ?? 'Sub-assistant');
                    }
                }

                // Create timeline item
                const timelineItem = {
                    id: index,
                    content: displayContent,
                    start: timestamp,
                    group: messageType,
                    title,
                    className: `timeline-item-${messageType}`
                };

                timelineItems.push(timelineItem);
            });

            // Set timeline window to show last hour by default, with padding after the last message
            const timelineEnd = new Date(new Date(latestTimeString).getTime() + 60 * 60 * 1000); // 1 hour after latest
            const timelineStart = new Date(timelineEnd.getTime() - 2 * 60 * 60 * 1000); // 2 hours total window (1 hour before latest + 1 hour after)

            return { timelineItems, timelineGroups, timelineEnd, timelineStart };
        }

        // Filter timeline items based on current message filters
        function applyFilters() {
            if (!timeline || !groups) return;

            // Get active filter types from filter toggles
            const activeTypes = Array.from(document.querySelectorAll('.filter-toggle.active'))
                .map(toggle => toggle.dataset.type);

            // Update groups visibility based on filter states
            const updatedGroups = groups.map(group => ({
                ...group,
                visible: activeTypes.includes(group.id)
            }));

            // Update timeline groups
            timeline.setGroups(updatedGroups);
        }

        // Handle timeline item click - scroll to corresponding message
        function onTimelineSelect(event) {
            const selection = timeline.getSelection();
            if (selection.length > 0) {
                const itemId = selection[0];
                const messageEl = timelineIdToElement.get(itemId);
                if (messageEl) {
                    // Calculate timeline height for proper scroll positioning
                    const timelineContainer = document.getElementById('timeline-container');
                    const timelineHeight = timelineContainer ? timelineContainer.offsetHeight : 0;

                    // Scroll so message top aligns with timeline bottom
                    const elementTop = messageEl.offsetTop;
                    const scrollPosition = elementTop - timelineHeight - 10; // 10px padding

                    window.scrollTo({
                        top: Math.max(0, scrollPosition),
                        behavior: 'smooth'
                    });

                    // Highlight the message briefly
                    messageEl.style.backgroundColor = '#fff3cd';
                    setTimeout(() => {
                        messageEl.style.backgroundColor = '';
                    }, 2000);
                }
            }
        }

        // Initialize timeline
        function initTimeline() {
            if (timeline) return; // Already initialized

            console.log('Initializing vis-timeline...');

            const container = document.getElementById('timeline-visualization');
            if (!container) {
                console.error('Timeline container not found');
                return;
            }

            // Build timeline data
            const { timelineItems, timelineGroups, timelineEnd, timelineStart } = buildTimelineData();
            items = timelineItems
            groups = timelineGroups
            if (items.length === 0) {
                console.warn('No timeline items found');
                return;
            }

            // Timeline options
            const options = {
                height: '100%',
                stack: true,
                showCurrentTime: true,
                zoomMin: 1000 * 1, // 1 second
                zoomMax: 1000 * 60 * 60 * 24 * 30, // 30 days
                start: timelineStart,
                end: timelineEnd,
                orientation: 'top',
                align: 'left',
                tooltip: {
                    // FIXME: This followMouse doesn't work for some reason and the tooltip box gets cut off for the bottom timeline boxes
                    followMouse: true,
                    overflowMethod: 'cap'
                },
                margin: {
                    item: 2,
                    axis: 2
                },
                groupOrder: (a, b) => {
                    const order = ['user', 'assistant', 'sidechain', 'tool_use', 'tool_result', 'thinking', 'system', 'image'];
                    return order.indexOf(a.id) - order.indexOf(b.id);
                }
            };

            // Create timeline
            timeline = new vis.Timeline(container, new vis.DataSet(items), new vis.DataSet(groups), options);

            // Make timeline available globally for debugging
            window.timeline = timeline;

            // Add event listeners
            timeline.on('select', onTimelineSelect);

            // Apply current filters
            applyFilters();

            console.log('Timeline initialized with', items.length, 'items and', groups.length, 'groups');
        }

        // Load vis-timeline library dynamically
        function loadVisTimeline() {
            return new Promise((resolve, reject) => {
                if (window.vis && window.vis.Timeline) {
                    resolve();
                    return;
                }

                console.log('Loading vis-timeline from CDN...');

                // Load CSS first
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css';
                document.head.appendChild(link);

                // Load JavaScript
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js';
                script.onload = () => {
                    console.log('vis-timeline loaded successfully');
                    isTimelineLoaded = true;
                    resolve();
                };
                script.onerror = () => {
                    console.error('Failed to load vis-timeline');
                    reject(new Error('Failed to load vis-timeline'));
                };
                document.head.appendChild(script);
            });
        }

        // Toggle timeline visibility
        function toggleTimeline() {
            const container = document.getElementById('timeline-container');
            const button = document.getElementById('toggleTimeline');

            if (container.style.display === 'none') {
                // Show timeline
                button.classList.add('active');
                button.title = 'Hide timeline';
                button.textContent = 'üóìÔ∏è';

                // Load vis-timeline if needed and show timeline
                loadVisTimeline().then(() => {
                    container.style.display = 'block';
                    // Set default height if not already set
                    if (!container.style.height) {
                        container.style.height = '30vh';
                    }
                    // Wait for container to be visible, then initialize
                    setTimeout(() => {
                        initTimeline();
                        initTimelineResize();
                    }, 100);
                }).catch(error => {
                    console.error('Error loading timeline:', error);
                    alert('Failed to load timeline. Please check your internet connection.');
                    container.style.display = 'none';
                    button.classList.remove('active');
                    button.title = 'Show timeline';
                    button.textContent = 'üìÜ';
                });
            } else {
                // Hide timeline
                container.style.display = 'none';
                button.classList.remove('active');
                button.title = 'Show timeline';
                button.textContent = 'üìÜ';
            }
        }

        // Update timeline position when filter bar is toggled
        function updateTimelinePosition() {
            const container = document.getElementById('timeline-container');
            const filterToolbar = document.querySelector('.filter-toolbar');

            if (container && filterToolbar) {
                const filterHeight = filterToolbar.offsetHeight;
                const computedStyle = getComputedStyle(filterToolbar);
                const isFilterVisible = computedStyle.display !== 'none' &&
                    computedStyle.visibility !== 'hidden' &&
                    filterHeight > 0;

                container.style.top = isFilterVisible ? `${filterHeight}px` : '0px';
            }
        }

        // Initialize timeline resizing functionality
        function initTimelineResize() {
            const container = document.getElementById('timeline-container');
            const resizeHandle = document.getElementById('timeline-resize-handle');

            if (!container || !resizeHandle) return;

            let startY = 0;
            let startHeight = 0;

            function handleMouseDown(e) {
                isResizing = true;
                startY = e.clientY;
                startHeight = container.offsetHeight;

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);

                // Prevent text selection during resize
                document.body.style.userSelect = 'none';
                e.preventDefault();
            }

            function handleMouseMove(e) {
                if (!isResizing) return;

                const deltaY = e.clientY - startY;
                const newHeight = Math.max(150, Math.min(window.innerHeight * 0.8, startHeight + deltaY));

                container.style.height = newHeight + 'px';

                // Trigger timeline redraw if needed
                if (timeline) {
                    timeline.redraw();
                }
            }

            function handleMouseUp() {
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                document.body.style.userSelect = '';
            }

            // Add mouse event listeners
            resizeHandle.addEventListener('mousedown', handleMouseDown);

            // Also allow resizing by dragging the container bottom edge
            container.addEventListener('mousedown', function (e) {
                const rect = container.getBoundingClientRect();
                if (e.clientY >= rect.bottom - 8) {
                    handleMouseDown(e);
                }
            });
        }

        // Export functions to global scope
        window.toggleTimeline = toggleTimeline;
        window.applyTimelineFilters = applyFilters;
        window.updateTimelinePosition = updateTimelinePosition;

        // Hook into existing systems
        document.addEventListener('DOMContentLoaded', function () {
            // Listen for filter changes
            const filterToggles = document.querySelectorAll('.filter-toggle');
            filterToggles.forEach(toggle => {
                toggle.addEventListener('click', function () {
                    setTimeout(applyFilters, 50);
                });
            });

            // Listen for select all/none buttons
            const selectAllButton = document.getElementById('selectAll');
            const selectNoneButton = document.getElementById('selectNone');
            if (selectAllButton) {
                selectAllButton.addEventListener('click', function () {
                    setTimeout(applyFilters, 50);
                });
            }
            if (selectNoneButton) {
                selectNoneButton.addEventListener('click', function () {
                    setTimeout(applyFilters, 50);
                });
            }

            // Listen for filter toolbar visibility changes
            const filterButton = document.getElementById('filterMessages');
            const closeFiltersButton = document.getElementById('closeFilters');

            if (filterButton) {
                filterButton.addEventListener('click', function () {
                    setTimeout(updateTimelinePosition, 50);
                });
            }

            if (closeFiltersButton) {
                closeFiltersButton.addEventListener('click', function () {
                    setTimeout(updateTimelinePosition, 50);
                });
            }

            // Update timeline position on window resize
            window.addEventListener('resize', updateTimelinePosition);
        });
    })();
</script>

    <!-- Combined Search & Filter Toolbar -->
    <div class="filter-toolbar">
        <div class="toolbar-header">
            <h3>üîç Search & Filter</h3>
            <button class="close-toolbar-btn" id="closeToolbar" title="Close">‚úï</button>
        </div>

        <!-- Inline Search -->
        <!-- Inline Search Component for Filter Toolbar -->
<div id="searchContainer" class="search-inline search-container">
    <div class="search-input-wrapper">
        <input type="text"
               id="searchInput"
               class="search-input"
               placeholder="Search conversations... (Ctrl+F)"
               autocomplete="off">
        <button id="searchClear" class="search-clear" title="Clear search">‚úï</button>
    </div>

    <div id="searchResultsInfo" class="search-results-info">
        <div class="search-navigation">
            <span id="searchResultCount">No results</span>
            <button id="searchPrev" class="search-nav-btn" disabled title="Previous match (Shift+F3)">‚Üë</button>
            <button id="searchNext" class="search-nav-btn" disabled title="Next match (F3)">‚Üì</button>
        </div>
        <div class="search-options-inline">
            <label class="search-option-inline">
                <input type="checkbox" id="searchRegex">
                <span>Regex</span>
            </label>
            <label class="search-option-inline">
                <input type="checkbox" id="searchInFiltered" checked>
                <span>Visible only</span>
            </label>
        </div>
    </div>
</div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-toggles">
                <button class="filter-toggle active" data-type="user">ü§∑ User <span class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="system">‚öôÔ∏è System <span class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="assistant">ü§ñ Assistant <span
                        class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="thinking">üí≠ Thinking <span
                        class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="tool">üõ†Ô∏è Tool <span
                        class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="sidechain">üîó Sub-assistant <span
                        class="count">(0)</span></button>
                <button class="filter-toggle active" data-type="image">üñºÔ∏è Images <span class="count">(0)</span></button>
            </div>
            <div class="filter-actions">
                <button class="filter-action-btn" id="selectAll">All</button>
                <button class="filter-action-btn" id="selectNone">None</button>
            </div>
        </div>
    </div>


    
    <div class="navigation">
        <a href="combined_transcripts.html" class="combined-transcript-link">
            ‚Üê View All Sessions (Combined Transcript)
        </a>
    </div>
    

    
    
    <div class="session-divider"></div>
    <div id='session-ee09dca3-2b73-4b02-a547-20c05a183d13' class='message session-header'>
        <div class='header'>Session: ee09dca3</div>
        

    </div>
    
    
    
    
    <div class='message assistant sidechain'>
        <div class='header'>
            <span>üîó Sub-assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:16:49.107Z'>2025-11-27 09:16:49</span>
                </div>
                
                <span class='token-usage'>Input: 3930 | Output: 187</span>
                
            </div>
        </div>
        <div class='content'><p>I'm ready to help with exploring the GpDelphiUnits codebase. I'm in read-only mode and will use my file search and analysis capabilities to help you find what you need.</p>
<p>I understand:</p>
<ul>
<li>This is a Delphi utility library in H:\RAZVOJ\GpDelphiUnits</li>
<li>The main Pascal source files are in <code>src/</code></li>
<li>Key units include DSiWin32.pas, GpStuff.pas, GpLists.pas, GpTimestamp.pas, and many specialized utilities</li>
<li>There are test projects in <code>src/tests/</code></li>
<li>I cannot create, modify, or delete files</li>
<li>I should follow the coding standards outlined in CLAUDE.md</li>
</ul>
<p>I'm ready to search through the codebase efficiently. What would you like me to find or analyze?</p>
</div>
    </div>
    
    
    
    
    <div class='message assistant sidechain'>
        <div class='header'>
            <span>üîó Sub-assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:16:54.792Z'>2025-11-27 09:16:54</span>
                </div>
                
                <span class='token-usage'>Input: 2 | Output: 2 | Cache Creation: 4117</span>
                
            </div>
        </div>
        <div class='content'><p>I'm ready to help you explore the GpDelphiUnits codebase and design implementation plans. I understand that:</p>
<ol>
<li><p><strong>I'm in READ-ONLY mode</strong> - I can only explore and analyze code, not modify or create files</p>
</li>
<li><p><strong>My role is planning</strong> - I'll design implementation approaches based on requirements and perspectives provided</p>
</li>
<li><p><strong>I follow project standards</strong>:</p>
<ul>
<li>Delphi naming conventions</li>
<li>Include OS error codes/messages in exceptions</li>
<li>Use inline variables for short-lived scopes</li>
<li>Don't capitalize 'assigned'</li>
<li>Use <code>_ms</code>, <code>_us</code>, <code>_ns</code> suffixes for time values (or prefer TGpTimestamp)</li>
<li>Qualify GetLastError calls with Winapi.Windows if custom implementation exists</li>
<li>Check for copy-paste errors</li>
</ul>
</li>
<li><p><strong>Key codebase knowledge</strong>:</p>
<ul>
<li>This is a Delphi utilities library (no build artifacts)</li>
<li>Core units include DSiWin32, GpStuff, GpTimestamp, GpLists, etc.</li>
<li>GpTimestamp provides type-safe time measurement with compile-time safety</li>
<li>Tests are in <code>src/tests/</code> directory</li>
<li>Working directory: H:\RAZVOJ\GpDelphiUnits</li>
</ul>
</li>
</ol>
<p>I'm ready to receive requirements and explore the codebase to create detailed implementation plans. What would you like me to analyze and plan?</p>
</div>
    </div>
    
    
    
    
    <div class='message user'>
        <div class='header'>
            <span>ü§∑ User</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:19:37.765Z'>2025-11-27 09:19:37</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Hi! I think we should extend HasElapsed function so that it always returns True when the clock is not valid (source is tsNone). This would simplify writing loops so instead of

```if (not time.IsValid) or time.HasElapsed(_TS_.Seconds(5)) then begin
  ...
  time := _TS_.FromStopwatch;
end;
```

One could just write:

```if time.HasElapsed(_TS_.Seconds(5)) then begin</pre></div>
    </div>
    
    
    
    
    <div class='message user'>
        <div class='header'>
            <span>ü§∑ User</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:19:41.917Z'>2025-11-27 09:19:41</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>[Request interrupted by user]</pre></div>
    </div>
    
    
    
    
    <div class='message user'>
        <div class='header'>
            <span>ü§∑ User</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:20:37.346Z'>2025-11-27 09:20:37</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Hi! I think we should extend HasElapsed function so that it always returns True when the clock is not valid (source is tsNone). This would simplify writing loops so instead of

```if (not time.IsValid) or time.HasElapsed(_TS_.Seconds(5)) then begin
  ...
  time := _TS_.FromStopwatch;
end;
```

One could just write:

```if time.HasElapsed(_TS_.Seconds(5)) then begin
  ...
  time := _TS_.FromStopwatch;
end;
```

Does this make sense? Of course, it would have to be documented and tested.

Are there other functions that could use such modifications?</pre></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:20:44.399Z'>2025-11-27 09:20:44</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">The user is suggesting a modification to the `HasElapsed` function in GpTimestamp so that it returns True when the timestamp is not valid (source is tsNone). This would simplify loop patterns where yo...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>The user is suggesting a modification to the <code>HasElapsed</code> function in GpTimestamp so that it returns True when the timestamp is not valid (source is tsNone). This would simplify loop patterns where you want to execute code the first time through (when time is not yet initialized) and then periodically after that.</p>
<p>Let me first read the GpTimestamp.pas file to understand the current implementation of HasElapsed and see what other functions might benefit from similar modifications.</p>
<p>I should:</p>
<ol>
<li>Read GpTimestamp.pas to see the current implementation</li>
<li>Look at related functions that might benefit from similar treatment</li>
<li>Consider the implications and whether this makes semantic sense</li>
<li>Suggest a plan if it makes sense</li>
</ol>
<p>Let me start by finding and reading the file.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:20:45.352Z'>2025-11-27 09:20:45</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>I think that makes excellent sense! Let me first examine the current implementation of <code>HasElapsed</code> and related functions to see what would benefit from this pattern.</p>
</div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01G21JwyWG7UU86hEeRdRboa">üìÑ Read <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:20:47.276Z'>2025-11-27 09:20:47</span>
                </div>
                
            </div>
        </div>
        <div class='content'></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01G21JwyWG7UU86hEeRdRboa"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:20:50.051Z' data-duration='took 2.8s'>2025-11-27 09:20:50</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='read-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>882 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">(</span><span class="o">*:</span><span class="k">Type</span><span class="o">-</span><span class="n">safe</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="n">source</span><span class="o">.</span><span class="w"> </span><span class="n">Prevents</span><span class="w"> </span><span class="n">mixing</span><span class="w"> </span><span class="n">incompatible</span><span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="n">measurements</span><span class="o">.</span>

<span class="w">   </span><span class="o">@</span><span class="n">author</span><span class="w"> </span><span class="n">Primoz</span><span class="w"> </span><span class="n">Gabrijelcic</span><span class="w"> </span><span class="p">(</span><span class="n">navigator</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">Claude</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
<span class="w">   </span><span class="o">@</span><span class="n">desc</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">(*:Type-safe timestamp with multiple time source. Prevents mixing incompatible time measurements.</span>

<span class="cm">   @author Primoz Gabrijelcic (navigator), Claude Code (driver)</span>
<span class="cm">   @desc &lt;pre&gt;</span>

<span class="cm">This software is distributed under the BSD license.</span>

<span class="cm">Copyright (c) 2025, Primoz Gabrijelcic</span>
<span class="cm">All rights reserved.</span>

<span class="cm">Redistribution and use in source and binary forms, with or without modification,</span>
<span class="cm">are permitted provided that the following conditions are met:</span>
<span class="cm">- Redistributions of source code must retain the above copyright notice, this</span>
<span class="cm">  list of conditions and the following disclaimer.</span>
<span class="cm">- Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="cm">  this list of conditions and the following disclaimer in the documentation</span>
<span class="cm">  and/or other materials provided with the distribution.</span>
<span class="cm">- The name of the Primoz Gabrijelcic may not be used to endorse or promote</span>
<span class="cm">  products derived from this software without specific prior written permission.</span>

<span class="cm">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<span class="cm">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="cm">WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm">DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="cm">ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="cm">(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="cm">LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="cm">ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm">(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm">SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="cm">   Author            : Primoz Gabrijelcic</span>
<span class="cm">   Creation date     : 2025-11-15</span>
<span class="cm">   Last modification : 2025-11-16</span>
<span class="cm">   Version           : 0.1</span>
<span class="cm">&lt;/pre&gt;*)(*</span>
<span class="cm">   History:</span>
<span class="cm">     0.1: 2025-11-15</span>
<span class="cm">       - Released. Not yet fully tested. There may be dragons!</span>
<span class="cm">*)</span>

<span class="k">unit</span><span class="w"> </span><span class="n">GpTimestamp</span><span class="o">;</span>

<span class="cm">{$IFDEF FPC}</span>
<span class="w">  </span><span class="cm">{$MODE DELPHI}</span>
<span class="cm">{$ENDIF}</span>

<span class="k">interface</span>

<span class="k">uses</span>
<span class="w">  </span><span class="n">System</span><span class="o">.</span><span class="n">SysUtils</span><span class="o">;</span>

<span class="k">type</span>
<span class="w">  </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">  </span><span class="c1">/// Identifies which clock source is used for time measurement.</span>
<span class="w">  </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">  </span><span class="n">TTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">tsNone</span><span class="o">,</span><span class="w">                    </span><span class="c1">// Uninitialized</span>
<span class="w">    </span><span class="n">tsTickCount</span><span class="o">,</span><span class="w">               </span><span class="c1">// GetTickCount64 - millisecond resolution (Windows only)</span>
<span class="w">    </span><span class="n">tsQueryPerformanceCounter</span><span class="o">,</span><span class="w"> </span><span class="c1">// QueryPerformanceCounter - high precision (Windows only)</span>
<span class="w">    </span><span class="n">tsTimeGetTime</span><span class="o">,</span><span class="w">             </span><span class="c1">// DSiTimeGetTime64 - millisecond resolution (Windows only)</span>
<span class="w">    </span><span class="n">tsStopwatch</span><span class="o">,</span><span class="w">               </span><span class="c1">// TStopwatch - high precision (cross-platform)</span>
<span class="w">    </span><span class="n">tsCustom</span><span class="o">,</span><span class="w">                  </span><span class="c1">// User-defined timebase</span>
<span class="w">    </span><span class="n">tsDVB</span><span class="o">,</span><span class="w">                     </span><span class="c1">// DVB/MPEG PCR/PTS timestamps</span>
<span class="w">    </span><span class="n">tsDuration</span><span class="w">                 </span><span class="c1">// Pure duration/difference, compatible with all sources</span>
<span class="w">  </span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">  </span><span class="c1">/// Time measurement type that stores both the timebase and time value.</span>
<span class="w">  </span><span class="c1">/// All time values are stored internally as nanoseconds.</span>
<span class="w">  </span><span class="c1">/// Prevents mixing times from different timebases through operator overloading.</span>
<span class="w">  </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">  </span><span class="n">TGpTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">record</span>
<span class="w">  </span><span class="n">strict</span><span class="w"> </span><span class="kp">private</span>
<span class="w">    </span><span class="n">FTimeSource</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="o">;</span><span class="w">  </span><span class="c1">// Which clock source was used</span>
<span class="w">    </span><span class="n">FTimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w">          </span><span class="c1">// Reference point (0 = use source&#39;s natural origin)</span>
<span class="w">    </span><span class="n">FValue</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w">             </span><span class="c1">// Time value in nanoseconds</span>

<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">CheckCompatible</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">other</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">GetPerformanceFrequency</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">GetAsString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">SetAsString</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="kp">public</span>
<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Captures current time from TStopwatch (cross-platform).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromStopwatch</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp from a TStopwatch value.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromStopwatch</span><span class="p">(</span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Captures current time from GetTickCount64 (millisecond resolution).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromTickCount</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp from a TickCount value in milliseconds.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromTickCount</span><span class="p">(</span><span class="n">value_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Captures current time from QueryPerformanceCounter (microsecond+ resolution).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromQueryPerformanceCounter</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp from a QueryPerformanceCounter value.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromQueryPerformanceCounter</span><span class="p">(</span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Captures current time from DSiTimeGetTime64 (millisecond resolution).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromTimeGetTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp from a TimeGetTime value in milliseconds.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromTimeGetTime</span><span class="p">(</span><span class="n">value_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>
<span class="w">    </span><span class="cm">{$ENDIF}</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp from a DVB PCR (Program Clock Reference) value.</span>
<span class="w">    </span><span class="c1">/// PCR uses a 27 MHz clock (1 tick = ~37.037 nanoseconds).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromDVB_PCR</span><span class="p">(</span><span class="n">pcr</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp from a DVB PTS (Presentation Time Stamp) value.</span>
<span class="w">    </span><span class="c1">/// PTS uses a 90 kHz clock (1 tick = ~11111.111 nanoseconds).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromDVB_PTS</span><span class="p">(</span><span class="n">pts</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp with a custom timebase and value.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromCustom</span><span class="p">(</span><span class="n">aTimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="n">aValue_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp from TDateTime value.</span>
<span class="w">    </span><span class="c1">/// Uses tsCustom with Delphi&#39;s TDateTime epoch (1899-12-30) as timebase.</span>
<span class="w">    </span><span class="c1">/// All TDateTime-based timestamps are compatible with each other.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromDateTime</span><span class="p">(</span><span class="n">dt</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp from Unix time (seconds since January 1, 1970, 00:00:00 UTC).</span>
<span class="w">    </span><span class="c1">/// Uses tsCustom with Unix epoch (1970-01-01) as timebase.</span>
<span class="w">    </span><span class="c1">/// All Unix time-based timestamps are compatible with each other.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromUnixTime</span><span class="p">(</span><span class="n">unixTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a timestamp with explicit time source, timebase, and value.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Create</span><span class="p">(</span><span class="n">aTimeSource</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="o">;</span><span class="w"> </span><span class="n">aTimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="n">aValue_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a duration of the specified number of nanoseconds.</span>
<span class="w">    </span><span class="c1">/// Returns a tsDuration timestamp compatible with all other sources.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Nanoseconds</span><span class="p">(</span><span class="n">ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a duration of the specified number of microseconds.</span>
<span class="w">    </span><span class="c1">/// Returns a tsDuration timestamp compatible with all other sources.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Microseconds</span><span class="p">(</span><span class="n">us</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a duration of the specified number of milliseconds.</span>
<span class="w">    </span><span class="c1">/// Returns a tsDuration timestamp compatible with all other sources.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Milliseconds</span><span class="p">(</span><span class="n">ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a duration of the specified number of seconds.</span>
<span class="w">    </span><span class="c1">/// Supports fractional seconds for sub-second precision.</span>
<span class="w">    </span><span class="c1">/// Returns a tsDuration timestamp compatible with all other sources.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Seconds</span><span class="p">(</span><span class="n">s</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a duration of the specified number of minutes.</span>
<span class="w">    </span><span class="c1">/// Returns a tsDuration timestamp compatible with all other sources.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Minutes</span><span class="p">(</span><span class="n">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Creates a duration of the specified number of hours.</span>
<span class="w">    </span><span class="c1">/// Returns a tsDuration timestamp compatible with all other sources.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Hours</span><span class="p">(</span><span class="n">h</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns a zero timestamp for the specified time source.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Zero</span><span class="p">(</span><span class="n">source</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns an invalid timestamp (tsNone).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Invalid</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns the time value in milliseconds.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToMilliseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns the time value in microseconds.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToMicroseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns the time value in nanoseconds.</span>
<span class="w">    </span><span class="c1">/// Note: Precision depends on the time source, this is just a unit conversion.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToNanoseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns the time value in seconds as a floating-point number.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToSeconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Converts the timestamp to a DVB PCR (Program Clock Reference) value.</span>
<span class="w">    </span><span class="c1">/// PCR uses a 27 MHz clock (1 tick = ~37.037 nanoseconds).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToPCR</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Converts the timestamp to a DVB PTS (Presentation Time Stamp) value.</span>
<span class="w">    </span><span class="c1">/// PTS uses a 90 kHz clock (1 tick = ~11111.111 nanoseconds).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToPTS</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Converts the timestamp to TDateTime.</span>
<span class="w">    </span><span class="c1">/// Note: This returns a relative time value, not an absolute date/time.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToDateTime</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns a human-readable string representation of the timestamp.</span>
<span class="w">    </span><span class="c1">/// Format: &quot;1.234567s [QPC]&quot; or &quot;123.456ms [TickCount]&quot;</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns a detailed debug string with all internal fields.</span>
<span class="w">    </span><span class="c1">/// Format: &quot;Source=QPC, Base=0, Value=1234567890ns&quot;</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">ToDebugString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns true if the timestamp is valid (has a time source assigned).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">IsValid</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns true if the timestamp represents a duration (tsDuration source).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">IsDuration</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Checks if the specified timeout has elapsed since this timestamp.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the comparison.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Checks if the specified duration has elapsed since this timestamp.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the comparison.</span>
<span class="w">    </span><span class="c1">/// The duration parameter must have TimeSource = tsDuration.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns the time elapsed since this timestamp as a duration.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the current time.</span>
<span class="w">    </span><span class="c1">/// Supported for: tsTickCount, tsQueryPerformanceCounter, tsTimeGetTime (Windows), tsStopwatch.</span>
<span class="w">    </span><span class="c1">/// Raises EInvalidOpException for unsupported time sources.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">Elapsed</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Adds two timestamps/durations.</span>
<span class="w">    </span><span class="c1">/// timestamp + duration = timestamp (with timestamp&#39;s source)</span>
<span class="w">    </span><span class="c1">/// duration + timestamp = timestamp (with timestamp&#39;s source)</span>
<span class="w">    </span><span class="c1">/// duration + duration = duration</span>
<span class="w">    </span><span class="c1">/// timestamp + timestamp raises an exception (invalid operation)</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">Add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Subtracts two timestamps and returns a duration (tsDuration).</span>
<span class="w">    </span><span class="c1">/// Raises an exception if the timestamps have incompatible timebases.</span>
<span class="w">    </span><span class="c1">/// Can also subtract durations: duration - duration = duration.</span>
<span class="w">    </span><span class="c1">/// Cannot subtract timestamp from duration (raises exception).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">Subtract</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns the earlier of two timestamps.</span>
<span class="w">    </span><span class="c1">/// Raises an exception if timestamps are incompatible.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Min</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns the later of two timestamps.</span>
<span class="w">    </span><span class="c1">/// Raises an exception if timestamps are incompatible.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Max</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">static</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Compares two timestamps. Raises an exception if timebases are incompatible.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">GreaterThan</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">LessThan</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">GreaterThanOrEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">LessThanOrEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">Equal</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">NotEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// The time source used for this timestamp.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">property</span><span class="w"> </span><span class="py">TimeSource</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="w"> </span><span class="kp">read</span><span class="w"> </span><span class="nf">FTimeSource</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// The reference timebase (0 for source&#39;s natural origin).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">property</span><span class="w"> </span><span class="py">TimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="w"> </span><span class="kp">read</span><span class="w"> </span><span class="nf">FTimeBase</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// The time value in nanoseconds.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">property</span><span class="w"> </span><span class="py">Value_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="w"> </span><span class="kp">read</span><span class="w"> </span><span class="nf">FValue</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Serializes/deserializes the timestamp to/from a string representation.</span>
<span class="w">    </span><span class="c1">/// Format: &quot;TimeSource|TimeBase|Value_ns&quot;</span>
<span class="w">    </span><span class="c1">/// Example: &quot;2|0|1000000000&quot; represents tsQueryPerformanceCounter with 1 second.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">property</span><span class="w"> </span><span class="py">AsString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="kp">read</span><span class="w"> </span><span class="nf">GetAsString</span><span class="w"> </span><span class="kp">write</span><span class="w"> </span><span class="nf">SetAsString</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">  </span><span class="c1">/// Short alias for TGpTimestamp to reduce verbosity in code.</span>
<span class="w">  </span><span class="c1">/// Use for cleaner syntax: _TS_.Milliseconds(500) instead of TGpTimestamp.Milliseconds(500)</span>
<span class="w">  </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">  </span><span class="n">_TS_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>

<span class="k">const</span>
<span class="w">  </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">  </span><span class="c1">/// Timebase constant representing the Delphi TDateTime epoch (December 30, 1899).</span>
<span class="w">  </span><span class="c1">/// All TDateTime-based timestamps share this timebase for compatibility.</span>
<span class="w">  </span><span class="c1">/// Value is the epoch date in YYYYMMDD format.</span>
<span class="w">  </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">  </span><span class="n">CDelphiDateTimeEpoch</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18991230</span><span class="o">;</span>

<span class="w">  </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">  </span><span class="c1">/// Timebase constant representing the Unix epoch (January 1, 1970, 00:00:00 UTC).</span>
<span class="w">  </span><span class="c1">/// All Unix time-based timestamps share this timebase for compatibility.</span>
<span class="w">  </span><span class="c1">/// Value is the epoch date in YYYYMMDD format.</span>
<span class="w">  </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">  </span><span class="n">CUnixTimeEpoch</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">19700101</span><span class="o">;</span>

<span class="k">implementation</span>

<span class="k">uses</span>
<span class="w">  </span><span class="n">System</span><span class="o">.</span><span class="n">Diagnostics</span>
<span class="w">  </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">  </span><span class="o">,</span><span class="n">Winapi</span><span class="o">.</span><span class="n">Windows</span>
<span class="w">  </span><span class="o">,</span><span class="n">DSiWin32</span>
<span class="w">  </span><span class="cm">{$ENDIF}</span>
<span class="w">  </span><span class="o">;</span>

<span class="k">const</span>
<span class="w">  </span><span class="c1">// Time conversion constants</span>
<span class="w">  </span><span class="n">CNanosecondsPerMicrosecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="o">;</span>
<span class="w">  </span><span class="n">CNanosecondsPerMillisecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="o">;</span>
<span class="w">  </span><span class="n">CNanosecondsPerSecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000000</span><span class="o">;</span>
<span class="w">  </span><span class="n">CNanosecondsPerDay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Int64</span><span class="p">(</span><span class="mi">86400000000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 24 * 60 * 60 * 1000000000</span>

<span class="w">  </span><span class="c1">// DVB timestamp conversion constants</span>
<span class="w">  </span><span class="n">CDVB_PCR_Frequency_MHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">27</span><span class="o">;</span><span class="w">   </span><span class="c1">// DVB PCR uses 27 MHz clock</span>
<span class="w">  </span><span class="n">CDVB_PTS_Frequency_kHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="o">;</span><span class="w">   </span><span class="c1">// DVB PTS uses 90 kHz clock</span>

<span class="cm">{ TGpTimestamp }</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">CheckCompatible</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">other</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Rule 0: Duration is compatible with everything</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsDuration</span><span class="p">)</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsDuration</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">Exit</span><span class="o">;</span><span class="w">  </span><span class="c1">// Compatible!</span>

<span class="w">  </span><span class="c1">// Rule 1: Same source type is always compatible</span>
<span class="w">  </span><span class="c1">//   (e.g., all FromTickCount calls are compatible)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsNone</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">other</span><span class="o">.</span><span class="n">FTimeSource</span><span class="p">)</span><span class="w"> </span><span class="k">and</span>
<span class="w">     </span><span class="p">(</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsCustom</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">Exit</span><span class="o">;</span><span class="w">  </span><span class="c1">// Compatible!</span>

<span class="w">  </span><span class="c1">// Rule 2: Same custom timebase is compatible</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsCustom</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsCustom</span><span class="p">)</span><span class="w"> </span><span class="k">and</span>
<span class="w">     </span><span class="p">(</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">other</span><span class="o">.</span><span class="n">FTimeBase</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">Exit</span><span class="o">;</span><span class="w">  </span><span class="c1">// Compatible!</span>

<span class="w">  </span><span class="c1">// Otherwise: incompatible</span>
<span class="w">  </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span>
<span class="w">    </span><span class="s">&#39;Cannot mix incompatible time measurements: [Source=%d, TimeBase=%d] vs [Source=%d, TimeBase=%d]&#39;</span><span class="o">,</span>
<span class="w">    </span><span class="p">[</span><span class="nb">Ord</span><span class="p">(</span><span class="n">FTimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">FTimeBase</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">FTimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">other</span><span class="o">.</span><span class="n">FTimeBase</span><span class="p">])</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">GetPerformanceFrequency</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">freq</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="cm">{$ENDIF}</span>
<span class="k">begin</span>
<span class="w">  </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">QueryPerformanceFrequency</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">Exception</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">&#39;QueryPerformanceFrequency failed&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">freq</span><span class="o">;</span>
<span class="w">  </span><span class="cm">{$ELSE}</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TStopwatch</span><span class="o">.</span><span class="n">Frequency</span><span class="o">;</span>
<span class="w">  </span><span class="cm">{$ENDIF}</span>
<span class="k">end</span><span class="o">;</span>

<span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromTickCount</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTickCount</span><span class="p">(</span><span class="n">GetTickCount64</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromTickCount</span><span class="p">(</span><span class="n">value_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsTickCount</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="cm">{$ENDIF}</span>

<span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromQueryPerformanceCounter</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">counter</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">QueryPerformanceCounter</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">Exception</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">&#39;QueryPerformanceCounter failed&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromQueryPerformanceCounter</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromQueryPerformanceCounter</span><span class="p">(</span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Round</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">GetPerformanceFrequency</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="cm">{$ENDIF}</span>

<span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromTimeGetTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTimeGetTime</span><span class="p">(</span><span class="n">DSiTimeGetTime64</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromTimeGetTime</span><span class="p">(</span><span class="n">value_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsTimeGetTime</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="cm">{$ENDIF}</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromStopwatch</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromStopwatch</span><span class="p">(</span><span class="n">TStopwatch</span><span class="o">.</span><span class="n">GetTimeStamp</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromStopwatch</span><span class="p">(</span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Round</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">TStopwatch</span><span class="o">.</span><span class="n">Frequency</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromDVB_PCR</span><span class="p">(</span><span class="n">pcr</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDVB</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="c1">// PCR is 27 MHz clock: 1 tick = 1000/27 nanoseconds</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Round</span><span class="p">(</span><span class="n">pcr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMicrosecond</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CDVB_PCR_Frequency_MHz</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromDVB_PTS</span><span class="p">(</span><span class="n">pts</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDVB</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="c1">// PTS is 90 kHz clock: 1 tick = 100000/9 nanoseconds</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Round</span><span class="p">(</span><span class="n">pts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CDVB_PTS_Frequency_kHz</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromCustom</span><span class="p">(</span><span class="n">aTimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="n">aValue_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsCustom</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">aTimeBase</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">aValue_ns</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromDateTime</span><span class="p">(</span><span class="n">dt</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsCustom</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">CDelphiDateTimeEpoch</span><span class="o">;</span>
<span class="w">  </span><span class="c1">// TDateTime is in days, convert to nanoseconds</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Round</span><span class="p">(</span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerDay</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">FromUnixTime</span><span class="p">(</span><span class="n">unixTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsCustom</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">CUnixTimeEpoch</span><span class="o">;</span>
<span class="w">  </span><span class="c1">// Unix time is in seconds, convert to nanoseconds</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">unixTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">aTimeSource</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="o">;</span><span class="w"> </span><span class="n">aTimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="n">aValue_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">aTimeSource</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">aTimeBase</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">aValue_ns</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Nanoseconds</span><span class="p">(</span><span class="n">ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ns</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Microseconds</span><span class="p">(</span><span class="n">us</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMicrosecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Milliseconds</span><span class="p">(</span><span class="n">ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Seconds</span><span class="p">(</span><span class="n">s</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Round</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Minutes</span><span class="p">(</span><span class="n">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Hours</span><span class="p">(</span><span class="n">h</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3600</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Zero</span><span class="p">(</span><span class="n">source</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">source</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Invalid</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsNone</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Min</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">b</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Max</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">b</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToMilliseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FValue</span><span class="w"> </span><span class="k">div</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToMicroseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FValue</span><span class="w"> </span><span class="k">div</span><span class="w"> </span><span class="n">CNanosecondsPerMicrosecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToNanoseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToSeconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToPCR</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Convert nanoseconds to 27 MHz PCR clock</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Round</span><span class="p">(</span><span class="n">FValue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CDVB_PCR_Frequency_MHz</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CNanosecondsPerMicrosecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToPTS</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Convert nanoseconds to 90 kHz PTS clock</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Round</span><span class="p">(</span><span class="n">FValue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CDVB_PTS_Frequency_kHz</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToDateTime</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Convert nanoseconds to days (TDateTime unit)</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CNanosecondsPerDay</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="k">const</span>
<span class="w">  </span><span class="n">SourceNames</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="p">[</span><span class="n">TTimeSource</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&#39;None&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TickCount&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;QPC&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeGetTime&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Stopwatch&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Custom&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;DVB&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Duration&#39;</span>
<span class="w">  </span><span class="p">)</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">absValue</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">seconds</span><span class="o">,</span><span class="w"> </span><span class="n">milliseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="o">;</span>
<span class="w">  </span><span class="n">fs</span><span class="o">:</span><span class="w"> </span><span class="n">TFormatSettings</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsNone</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">Exit</span><span class="p">(</span><span class="s">&#39;Invalid&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">fs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TFormatSettings</span><span class="o">.</span><span class="n">Create</span><span class="o">;</span>
<span class="w">  </span><span class="n">fs</span><span class="o">.</span><span class="n">DecimalSeparator</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&#39;.&#39;</span><span class="o">;</span>

<span class="w">  </span><span class="n">absValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">FValue</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">seconds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">absValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="o">;</span>
<span class="w">  </span><span class="n">milliseconds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">absValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="o">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">absValue</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">CNanosecondsPerSecond</span><span class="w"> </span><span class="k">then</span><span class="w">  </span><span class="c1">// &gt;= 1 second</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">FValue</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Format</span><span class="p">(</span><span class="s">&#39;-%1.6fs [%s]&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">seconds</span><span class="o">,</span><span class="w"> </span><span class="n">SourceNames</span><span class="p">[</span><span class="n">FTimeSource</span><span class="p">]]</span><span class="o">,</span><span class="w"> </span><span class="n">fs</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Format</span><span class="p">(</span><span class="s">&#39;%1.6fs [%s]&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">seconds</span><span class="o">,</span><span class="w"> </span><span class="n">SourceNames</span><span class="p">[</span><span class="n">FTimeSource</span><span class="p">]]</span><span class="o">,</span><span class="w"> </span><span class="n">fs</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="k">else</span><span class="w">  </span><span class="c1">// &lt; 1 second</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">FValue</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Format</span><span class="p">(</span><span class="s">&#39;-%1.3fms [%s]&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">milliseconds</span><span class="o">,</span><span class="w"> </span><span class="n">SourceNames</span><span class="p">[</span><span class="n">FTimeSource</span><span class="p">]]</span><span class="o">,</span><span class="w"> </span><span class="n">fs</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Format</span><span class="p">(</span><span class="s">&#39;%1.3fms [%s]&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">milliseconds</span><span class="o">,</span><span class="w"> </span><span class="n">SourceNames</span><span class="p">[</span><span class="n">FTimeSource</span><span class="p">]]</span><span class="o">,</span><span class="w"> </span><span class="n">fs</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">ToDebugString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="k">const</span>
<span class="w">  </span><span class="n">SourceNames</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="p">[</span><span class="n">TTimeSource</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&#39;None&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TickCount&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;QPC&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeGetTime&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Stopwatch&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Custom&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;DVB&#39;</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Duration&#39;</span>
<span class="w">  </span><span class="p">)</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Format</span><span class="p">(</span><span class="s">&#39;Source=%s, Base=%d, Value=%dns&#39;</span><span class="o">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">SourceNames</span><span class="p">[</span><span class="n">FTimeSource</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">FTimeBase</span><span class="o">,</span><span class="w"> </span><span class="n">FValue</span><span class="p">])</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">IsValid</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsNone</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">IsDuration</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">GetAsString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Format</span><span class="p">(</span><span class="s">&#39;%d|%d|%d&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nb">Ord</span><span class="p">(</span><span class="n">FTimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">FTimeBase</span><span class="o">,</span><span class="w"> </span><span class="n">FValue</span><span class="p">])</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">SetAsString</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="p">)</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">parts</span><span class="o">:</span><span class="w"> </span><span class="n">TArray</span><span class="o">&lt;</span><span class="k">string</span><span class="o">&gt;;</span>
<span class="w">  </span><span class="n">timeSource</span><span class="o">:</span><span class="w"> </span><span class="kt">Integer</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">parts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="o">.</span><span class="n">Split</span><span class="p">([</span><span class="s">&#39;|&#39;</span><span class="p">])</span><span class="o">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nb">Length</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EArgumentException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span><span class="s">&#39;Invalid timestamp string format: &quot;%s&quot;. Expected format: &quot;TimeSource|TimeBase|Value_ns&quot;&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="p">])</span><span class="o">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nb">TryStrToInt</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">timeSource</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EArgumentException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span><span class="s">&#39;Invalid TimeSource value: &quot;%s&quot;&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeSource</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="nb">Low</span><span class="p">(</span><span class="n">TTimeSource</span><span class="p">)))</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="n">timeSource</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="nb">High</span><span class="p">(</span><span class="n">TTimeSource</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EArgumentException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span><span class="s">&#39;TimeSource value out of range: %d&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">timeSource</span><span class="p">])</span><span class="o">;</span>

<span class="w">  </span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TTimeSource</span><span class="p">(</span><span class="n">timeSource</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nb">TryStrToInt64</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">FTimeBase</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EArgumentException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span><span class="s">&#39;Invalid TimeBase value: &quot;%s&quot;&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nb">TryStrToInt64</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EArgumentException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span><span class="s">&#39;Invalid Value_ns value: &quot;%s&quot;&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">currentTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Get current time from same source</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">    </span><span class="n">tsTickCount</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsQueryPerformanceCounter</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsTimeGetTime</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTimeGetTime</span><span class="o">;</span>
<span class="w">    </span><span class="cm">{$ENDIF}</span>
<span class="w">    </span><span class="n">tsStopwatch</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span>
<span class="w">      </span><span class="s">&#39;HasElapsed not supported for time source: %d&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nb">Ord</span><span class="p">(</span><span class="n">FTimeSource</span><span class="p">)])</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">currentTime</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">currentTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Verify that duration parameter is actually a duration</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsDuration</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">&#39;HasElapsed duration parameter must have TimeSource = tsDuration&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Get current time from same source</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">    </span><span class="n">tsTickCount</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsQueryPerformanceCounter</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsTimeGetTime</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTimeGetTime</span><span class="o">;</span>
<span class="w">    </span><span class="cm">{$ENDIF}</span>
<span class="w">    </span><span class="n">tsStopwatch</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span>
<span class="w">      </span><span class="s">&#39;HasElapsed not supported for time source: %d&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nb">Ord</span><span class="p">(</span><span class="n">FTimeSource</span><span class="p">)])</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">currentTime</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Elapsed</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">currentTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Get current time from same source</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">    </span><span class="n">tsTickCount</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsQueryPerformanceCounter</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsTimeGetTime</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTimeGetTime</span><span class="o">;</span>
<span class="w">    </span><span class="cm">{$ENDIF}</span>
<span class="w">    </span><span class="n">tsStopwatch</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span>
<span class="w">      </span><span class="s">&#39;Elapsed not supported for time source: %d&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nb">Ord</span><span class="p">(</span><span class="n">FTimeSource</span><span class="p">)])</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Return duration (currentTime - self)</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">Self</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Subtract</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// duration - timestamp is invalid</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsDuration</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsDuration</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">&#39;Cannot subtract timestamp from duration&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Result is always a duration</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// timestamp + timestamp is invalid</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsDuration</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsDuration</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">&#39;Cannot add two timestamps; only timestamp + duration is valid&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// duration + duration = duration</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsDuration</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsDuration</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">tsDuration</span><span class="o">;</span>
<span class="w">    </span><span class="bp">Result</span><span class="o">.</span><span class="n">FTimeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
<span class="w">    </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="c1">// timestamp + duration = timestamp (preserve timestamp&#39;s source)</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsDuration</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">;</span>
<span class="w">    </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="c1">// duration + timestamp = timestamp (preserve timestamp&#39;s source)</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">b</span><span class="o">;</span>
<span class="w">    </span><span class="bp">Result</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">GreaterThan</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">LessThan</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">GreaterThanOrEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">LessThanOrEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Equal</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">NotEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">CheckCompatible</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">end</span><span class="o">.</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                <div class='system-reminder'>ü§ñ <em>Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.</em></div></div></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:02.137Z'>2025-11-27 09:21:02</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">Now I can see the current implementation of `HasElapsed`. Looking at lines 737-779, I see that both overloads of `HasElapsed` raise an exception if the TimeSource is not one of the supported types (ts...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>Now I can see the current implementation of <code>HasElapsed</code>. Looking at lines 737-779, I see that both overloads of <code>HasElapsed</code> raise an exception if the TimeSource is not one of the supported types (tsTickCount, tsQueryPerformanceCounter, tsTimeGetTime, tsStopwatch).</p>
<p>The user's suggestion makes perfect sense! If the timestamp is not valid (TimeSource = tsNone), then returning True would mean &quot;yes, time has elapsed, you should reinitialize the timestamp now.&quot; This is a great usability improvement.</p>
<p>Let me also look at the <code>Elapsed</code> function (lines 781-800) to see if it would benefit from similar treatment.</p>
<p>Looking at the code:</p>
<ol>
<li><code>HasElapsed</code> - currently raises exception for unsupported sources (including tsNone). User suggests it should return True for tsNone.</li>
<li><code>Elapsed</code> - currently raises exception for unsupported sources. Should this also handle tsNone specially? Probably not - it should still raise an exception because you can't meaningfully calculate an elapsed duration from an invalid timestamp.</li>
</ol>
<p>Other functions to consider:</p>
<ul>
<li>Comparison operators (&gt;, &lt;, &gt;=, &lt;=, ==, !=) - These call CheckCompatible and would raise an exception. Should they handle tsNone? Probably not - comparing an invalid timestamp doesn't make semantic sense.</li>
<li>Arithmetic operators (Add, Subtract) - Same reasoning, comparing with tsNone should still be an error.</li>
</ul>
<p>So I think only <code>HasElapsed</code> should get this special treatment.</p>
<p>Now let me check the test file to understand how tests are structured.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:03.113Z'>2025-11-27 09:21:03</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Perfect! This makes complete sense. Let me examine the implementation and consider which functions would benefit from this pattern.</p>
</div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01CTbPFgNpT9K1b7UsdVeFkC">üìÑ Read <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\tests\GpTimestampTests.dpr</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:04.056Z'>2025-11-27 09:21:04</span>
                </div>
                
            </div>
        </div>
        <div class='content'></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01CTbPFgNpT9K1b7UsdVeFkC"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:05.444Z' data-duration='took 1.4s'>2025-11-27 09:21:05</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='read-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>81 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">program</span><span class="w"> </span><span class="n">GpTimestampTests</span><span class="o">;</span>

<span class="cm">{$IFNDEF TESTINSIGHT}</span>
<span class="cm">{$APPTYPE CONSOLE}</span>
<span class="cm">{$ENDIF}</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">program</span><span class="w"> </span><span class="n">GpTimestampTests</span><span class="o">;</span>

<span class="cm">{$IFNDEF TESTINSIGHT}</span>
<span class="cm">{$APPTYPE CONSOLE}</span>
<span class="cm">{$ENDIF}</span>
<span class="cm">{$STRONGLINKTYPES ON}</span>

<span class="k">uses</span>
<span class="w">  </span><span class="n">System</span><span class="o">.</span><span class="n">SysUtils</span><span class="o">,</span>
<span class="w">  </span><span class="cm">{$IFDEF TESTINSIGHT}</span>
<span class="w">  </span><span class="n">TestInsight</span><span class="o">.</span><span class="n">DUnitX</span><span class="o">,</span>
<span class="w">  </span><span class="cm">{$ELSE}</span>
<span class="w">  </span><span class="n">DUnitX</span><span class="o">.</span><span class="n">Loggers</span><span class="o">.</span><span class="n">Console</span><span class="o">,</span>
<span class="w">  </span><span class="cm">{$ENDIF }</span>
<span class="w">  </span><span class="n">DUnitX</span><span class="o">.</span><span class="n">TestFramework</span><span class="o">,</span>
<span class="w">  </span><span class="n">GpTimestamp</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s">&#39;..\GpTimestamp.pas&#39;</span><span class="o">,</span>
<span class="w">  </span><span class="n">GpTimestamp</span><span class="o">.</span><span class="n">UnitTests</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s">&#39;..\GpTimestamp.UnitTests.pas&#39;</span><span class="o">;</span>

<span class="cm">{$IFNDEF TESTINSIGHT}</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">runner</span><span class="o">:</span><span class="w"> </span><span class="n">ITestRunner</span><span class="o">;</span>
<span class="w">  </span><span class="n">results</span><span class="o">:</span><span class="w"> </span><span class="n">IRunResults</span><span class="o">;</span>
<span class="w">  </span><span class="n">logger</span><span class="o">:</span><span class="w"> </span><span class="n">ITestLogger</span><span class="o">;</span>
<span class="cm">{$ENDIF}</span>

<span class="k">begin</span>
<span class="cm">{$IFDEF TESTINSIGHT}</span>
<span class="w">  </span><span class="n">TestInsight</span><span class="o">.</span><span class="n">DUnitX</span><span class="o">.</span><span class="n">RunRegisteredTests</span><span class="o">;</span>
<span class="cm">{$ELSE}</span>
<span class="w">  </span><span class="k">try</span>
<span class="w">    </span><span class="c1">// Create the test runner</span>
<span class="w">    </span><span class="n">runner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TDUnitX</span><span class="o">.</span><span class="n">CreateRunner</span><span class="o">;</span>

<span class="w">    </span><span class="c1">// Create console logger</span>
<span class="w">    </span><span class="n">logger</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TDUnitXConsoleLogger</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="n">runner</span><span class="o">.</span><span class="n">AddLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="o">;</span>

<span class="w">    </span><span class="c1">// Run tests</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Running GpTimestamp Unit Tests&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;==============================&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="o">;</span>

<span class="w">    </span><span class="n">results</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">runner</span><span class="o">.</span><span class="n">Execute</span><span class="o">;</span>

<span class="w">    </span><span class="c1">// Display results</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="o">;</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Tests completed.&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Total:  &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">TestCount</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Passed: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">PassCount</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Failed: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">FailureCount</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Errors: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">ErrorCount</span><span class="p">)</span><span class="o">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">FailureCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nb">WriteLn</span><span class="o">;</span>
<span class="w">      </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;FAILURES:&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">      </span><span class="nb">WriteLn</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">ToString</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="k">end</span><span class="o">;</span>

<span class="w">    </span><span class="c1">// Keep console window open</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="o">;</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Press ENTER to exit...&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="nb">ReadLn</span><span class="o">;</span>

<span class="w">    </span><span class="c1">// Set exit code based on test results</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">FailureCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="n">ExitCode</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">ExitCode</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>

<span class="w">  </span><span class="k">except</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">E</span><span class="o">:</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;FATAL ERROR: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">E</span><span class="o">.</span><span class="n">ClassName</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">E</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="o">;</span>
<span class="w">      </span><span class="nb">ReadLn</span><span class="o">;</span>
<span class="w">      </span><span class="n">ExitCode</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="o">;</span>
<span class="w">    </span><span class="k">end</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>
<span class="cm">{$ENDIF}</span>
<span class="k">end</span><span class="o">.</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                <div class='system-reminder'>ü§ñ <em>Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.</em></div></div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:08.425Z'>2025-11-27 09:21:08</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Now let me read the actual unit tests file to see the structure.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_018tJfzJHENk1CNbzU1hn1z3">üìÑ Read <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.UnitTests.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:09.143Z'>2025-11-27 09:21:09</span>
                </div>
                
            </div>
        </div>
        <div class='content'></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_018tJfzJHENk1CNbzU1hn1z3"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:10.898Z' data-duration='took 1.8s'>2025-11-27 09:21:10</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='read-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>944 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">(*:Unit tests for the GpTimestamp unit.</span>

<span class="cm">   @author Primoz Gabrijelcic (navigator), Claude Code (driver)</span>
<span class="cm">*)</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">(*:Unit tests for the GpTimestamp unit.</span>

<span class="cm">   @author Primoz Gabrijelcic (navigator), Claude Code (driver)</span>
<span class="cm">*)</span>

<span class="k">unit</span><span class="w"> </span><span class="n">GpTimestamp</span><span class="o">.</span><span class="n">UnitTests</span><span class="o">;</span>

<span class="k">interface</span>

<span class="k">uses</span>
<span class="w">  </span><span class="n">DUnitX</span><span class="o">.</span><span class="n">TestFramework</span><span class="o">,</span>
<span class="w">  </span><span class="n">GpTimestamp</span><span class="o">;</span>

<span class="k">type</span>
<span class="w">  </span><span class="p">[</span><span class="n">TestFixture</span><span class="p">]</span>
<span class="w">  </span><span class="n">TGpTimestampTests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">class</span>
<span class="w">  </span><span class="kp">public</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestBasicTiming</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestUnitConversions</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestComparisons</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestCustomTimebase</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestDifferentSources</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestSameSourceCompatibility</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestHasElapsed</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestArithmetic</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestDVB_Conversions</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestDVB_Compatibility</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestStopwatch</span><span class="o">;</span>
<span class="w">    </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestTimeGetTime</span><span class="o">;</span>
<span class="w">    </span><span class="cm">{$ENDIF}</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestCreateOverload</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestAllOperators</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestStringConversion</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestDateTimeConversion</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestUnixTimeConversion</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestUtilityFunctions</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestNegativeDurations</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestDurationFactoryMethods</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestElapsed</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestFromValueOverloads</span><span class="o">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">TestAsString</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="k">implementation</span>

<span class="k">uses</span>
<span class="w">  </span><span class="n">System</span><span class="o">.</span><span class="n">SysUtils</span><span class="o">;</span>

<span class="cm">{ TGpTimestampTests }</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestBasicTiming</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start</span><span class="o">,</span><span class="w"> </span><span class="n">finish</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">finish</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="n">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">finish</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">elapsed</span><span class="o">.</span><span class="n">IsDuration</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Subtraction should produce duration&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Verify the sleep took approximately 100ms (allow tolerance)</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">150</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Sleep(100) should take approximately 100ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Verify direct subtraction works</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">elapsed</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="p">(</span><span class="n">finish</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Direct subtraction should equal stored value&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestUnitConversions</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">timestamp</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_sec</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_sec</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed</span><span class="o">.</span><span class="n">ToSeconds</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Verify conversions are consistent</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Sleep(50) should take approximately 50ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">elapsed_ns</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Nanoseconds should equal itself&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">elapsed_ns</span><span class="w"> </span><span class="k">div</span><span class="w"> </span><span class="mi">1000</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="k">div</span><span class="w"> </span><span class="mi">1000</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Microseconds conversion should be consistent&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_sec</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.045</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_sec</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.100</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Seconds conversion should be in range, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">FloatToStr</span><span class="p">(</span><span class="n">elapsed_sec</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;s&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestComparisons</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="n">t3</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">t3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should be less than t2&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t3</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should be less than t3&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t3</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should be less than t3&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t3</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t3 should be greater than t1&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should be greater than or equal to t1&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should be less than or equal to t2&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestCustomTimebase</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">timeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">measurement1</span><span class="o">,</span><span class="w"> </span><span class="n">measurement2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Create a custom timebase for related measurements</span>
<span class="w">  </span><span class="n">timeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">timeBase</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Custom timebase should be positive&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// First measurement</span>
<span class="w">  </span><span class="n">measurement1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="n">timeBase</span><span class="o">,</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">.</span><span class="n">Value_ns</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Second measurement with same timebase</span>
<span class="w">  </span><span class="n">measurement2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="n">timeBase</span><span class="o">,</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">.</span><span class="n">Value_ns</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// These can be compared because they share the same custom timebase</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">measurement2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">measurement1</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Elapsed time should be approximately 25ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestDifferentSources</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">exceptionRaised</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TickCount timestamp should be positive&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;QPC timestamp should be positive&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Attempting to compare incompatible sources should raise an exception</span>
<span class="w">  </span><span class="n">exceptionRaised</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">False</span><span class="o">;</span>
<span class="w">  </span><span class="k">try</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="o">;</span><span class="w"> </span><span class="c1">// This should raise an exception</span>
<span class="w">  </span><span class="k">except</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">E</span><span class="o">:</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">exceptionRaised</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">True</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">exceptionRaised</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Comparing incompatible time sources should raise EInvalidOpException&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestSameSourceCompatibility</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Both from TickCount - should be compatible</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>

<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;TickCount elapsed time should be approximately 30ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Both from QPC - should be compatible</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;QPC elapsed time should be approximately 30ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestHasElapsed</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">actualElapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test HasElapsed with Int64 parameter</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">50</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Wait for timeout</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="c1">// Busy wait</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">timeout_ms</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Actual elapsed time should be at least the timeout value&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">timeout_ms</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Actual elapsed time should be close to timeout value, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test HasElapsed with TGpTimestamp duration parameter</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Microseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Wait for duration</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="c1">// Busy wait</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Actual elapsed time should be at least 0.5ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with larger duration</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="c1">// Busy wait</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should wait for 30ms duration, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test that exception is raised for non-duration parameter</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span><span class="w">  </span><span class="c1">// Not a duration</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nc">start</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EInvalidOpException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;HasElapsed should raise exception when parameter is not tsDuration&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestArithmetic</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">timestamp</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">future</span><span class="o">,</span><span class="w"> </span><span class="n">past</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Create a duration of 1 second</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDuration</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">future</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">duration</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="p">(</span><span class="n">future</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Adding 1 second should result in 1000ms difference&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Create a duration of 500ms</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDuration</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">500000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">past</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">duration</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="p">(</span><span class="n">timestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">past</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Subtracting 500ms should result in 500ms difference&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Verify the order</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">past</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">timestamp</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Past should be less than timestamp&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">timestamp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">future</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Timestamp should be less than future&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestDVB_Conversions</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">pcr_value</span><span class="o">,</span><span class="w"> </span><span class="n">pts_value</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts_from_pcr</span><span class="o">,</span><span class="w"> </span><span class="n">ts_from_pts</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">converted_pcr</span><span class="o">,</span><span class="w"> </span><span class="n">converted_pts</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test PCR conversion (27 MHz clock)</span>
<span class="w">  </span><span class="c1">// 27,000,000 PCR ticks = 1 second = 1,000,000,000 nanoseconds</span>
<span class="w">  </span><span class="n">pcr_value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">27000000</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 second in PCR ticks</span>
<span class="w">  </span><span class="n">ts_from_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PCR</span><span class="p">(</span><span class="n">pcr_value</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts_from_pcr</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">999900000</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;PCR to ns conversion should be approximately 1 second&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts_from_pcr</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1000100000</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;PCR to ns conversion should be approximately 1 second&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Convert back to PCR</span>
<span class="w">  </span><span class="n">converted_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts_from_pcr</span><span class="o">.</span><span class="n">ToPCR</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">converted_pcr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pcr_value</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;PCR round-trip conversion should be accurate within 1 tick&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test PTS conversion (90 kHz clock)</span>
<span class="w">  </span><span class="c1">// 90,000 PTS ticks = 1 second = 1,000,000,000 nanoseconds</span>
<span class="w">  </span><span class="n">pts_value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">90000</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 second in PTS ticks</span>
<span class="w">  </span><span class="n">ts_from_pts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PTS</span><span class="p">(</span><span class="n">pts_value</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts_from_pts</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">999900000</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;PTS to ns conversion should be approximately 1 second&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts_from_pts</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1000100000</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;PTS to ns conversion should be approximately 1 second&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Convert back to PTS</span>
<span class="w">  </span><span class="n">converted_pts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts_from_pts</span><span class="o">.</span><span class="n">ToPTS</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">converted_pts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pts_value</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;PTS round-trip conversion should be accurate within 1 tick&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test smaller values for precision</span>
<span class="w">  </span><span class="n">pcr_value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">27000</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 millisecond in PCR ticks</span>
<span class="w">  </span><span class="n">ts_from_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PCR</span><span class="p">(</span><span class="n">pcr_value</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ts_from_pcr</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1000</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;PCR conversion should handle millisecond precision&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">pts_value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">90</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 millisecond in PTS ticks</span>
<span class="w">  </span><span class="n">ts_from_pts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PTS</span><span class="p">(</span><span class="n">pts_value</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ts_from_pts</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1000</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;PTS conversion should handle millisecond precision&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestDVB_Compatibility</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1_pcr</span><span class="o">,</span><span class="w"> </span><span class="n">t2_pcr</span><span class="o">,</span><span class="w"> </span><span class="n">t1_pts</span><span class="o">,</span><span class="w"> </span><span class="n">t2_pts</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">exceptionRaised</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Both from PCR - should be compatible</span>
<span class="w">  </span><span class="n">t1_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PCR</span><span class="p">(</span><span class="mi">27000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 second</span>
<span class="w">  </span><span class="n">t2_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PCR</span><span class="p">(</span><span class="mi">54000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 2 seconds</span>

<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t2_pcr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_pcr</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1000</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Elapsed time between two PCR timestamps should be 1 second&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1_pcr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2_pcr</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1_pcr should be less than t2_pcr&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Both from PTS - should be compatible</span>
<span class="w">  </span><span class="n">t1_pts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PTS</span><span class="p">(</span><span class="mi">90000</span><span class="p">)</span><span class="o">;</span><span class="w">   </span><span class="c1">// 1 second</span>
<span class="w">  </span><span class="n">t2_pts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PTS</span><span class="p">(</span><span class="mi">180000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 2 seconds</span>

<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t2_pts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_pts</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1000</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Elapsed time between two PTS timestamps should be 1 second&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1_pts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2_pts</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1_pts should be less than t2_pts&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// PCR and PTS should be compatible (both use tsDVB)</span>
<span class="w">  </span><span class="n">t1_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PCR</span><span class="p">(</span><span class="mi">27000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 second</span>
<span class="w">  </span><span class="n">t1_pts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PTS</span><span class="p">(</span><span class="mi">90000</span><span class="p">)</span><span class="o">;</span><span class="w">     </span><span class="c1">// 1 second</span>

<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t1_pts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_pcr</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">elapsed_ns</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1000</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;PCR and PTS representing same time should have minimal difference&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// DVB and other sources should be incompatible</span>
<span class="w">  </span><span class="n">t1_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PCR</span><span class="p">(</span><span class="mi">27000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">t2_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>

<span class="w">  </span><span class="n">exceptionRaised</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">False</span><span class="o">;</span>
<span class="w">  </span><span class="k">try</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">t1_pcr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2_pcr</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="o">;</span><span class="w"> </span><span class="c1">// This should raise an exception</span>
<span class="w">  </span><span class="k">except</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">E</span><span class="o">:</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="n">exceptionRaised</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">True</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">exceptionRaised</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Comparing DVB and TickCount sources should raise EInvalidOpException&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestStopwatch</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Stopwatch timestamp should be positive&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsStopwatch</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsStopwatch source&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="k">div</span><span class="w"> </span><span class="mi">1000000</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Stopwatch elapsed time should be approximately 30ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should be less than t2&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestTimeGetTime</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTimeGetTime</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeGetTime timestamp should be positive&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsTimeGetTime</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsTimeGetTime source&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTimeGetTime</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="k">div</span><span class="w"> </span><span class="mi">1000000</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;TimeGetTime elapsed time should be approximately 30ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should be less than t2&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="cm">{$ENDIF}</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestCreateOverload</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test the Create overload with TTimeSource parameter</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 second in nanoseconds</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsDVB</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsDVB source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeBase should be 0&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Value should be 1 second&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">2000000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 2 seconds in nanoseconds</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ts2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;ts1 should be less than ts2&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Elapsed should be 1 second&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with custom timebase</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsCustom</span><span class="o">,</span><span class="w"> </span><span class="mi">123456</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsCustom</span><span class="o">,</span><span class="w"> </span><span class="mi">123456</span><span class="o">,</span><span class="w"> </span><span class="mi">2000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Elapsed should be 1 second for custom timebase&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestAllOperators</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="n">t3</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Create some test timestamps using Create for precise control</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span><span class="w">   </span><span class="c1">// 1 second</span>
<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">2000000000</span><span class="p">)</span><span class="o">;</span><span class="w">   </span><span class="c1">// 2 seconds</span>
<span class="w">  </span><span class="n">t3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">2000000000</span><span class="p">)</span><span class="o">;</span><span class="w">   </span><span class="c1">// 2 seconds (equal to t2)</span>

<span class="w">  </span><span class="c1">// Test Subtract (timestamp - timestamp) -&gt; duration</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Subtract operator should return 1 second&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Add (timestamp + duration) -&gt; timestamp</span>
<span class="w">  </span><span class="n">t3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDuration</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">2000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">t3</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Add operator should produce 2 second timestamp&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Subtract (timestamp - duration) -&gt; timestamp</span>
<span class="w">  </span><span class="n">t3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDuration</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">t3</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Subtract duration should produce 1 second timestamp&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test GreaterThan operator</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should be greater than t1&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should not be greater than t2&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test LessThan operator</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should be less than t2&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should not be less than t1&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test GreaterThanOrEqual operator</span>
<span class="w">  </span><span class="n">t3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">2000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should be &gt;= t1&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">t3</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should be &gt;= t3 (equal values)&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should not be &gt;= t2&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test LessThanOrEqual operator</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should be &lt;= t2&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">t3</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should be &lt;= t3 (equal values)&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should not be &lt;= t1&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Equal operator</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t3</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should equal t3&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should not equal t2&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test NotEqual operator</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t1 should not equal t2&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">t3</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;t2 should equal t3&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestStringConversion</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">,</span><span class="w"> </span><span class="n">ts3</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="nb">str</span><span class="o">,</span><span class="w"> </span><span class="n">debugStr</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test positive values</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1234567890</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1.23... seconds</span>
<span class="w">  </span><span class="nb">str</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">ToString</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;1.234568s&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should format as seconds: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// rounded to 6 decimals</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;[DVB]&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should contain source name: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">123456789</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 123.456... milliseconds</span>
<span class="w">  </span><span class="nb">str</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">ToString</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;123.457ms&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should format as milliseconds: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;[DVB]&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should contain source name: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test negative values</span>
<span class="w">  </span><span class="n">ts3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">500000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// -500ms</span>
<span class="w">  </span><span class="nb">str</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts3</span><span class="o">.</span><span class="n">ToString</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;-500&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should show negative sign: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should format as milliseconds: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test invalid timestamp</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Invalid</span><span class="o">;</span>
<span class="w">  </span><span class="nb">str</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">ToString</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&#39;Invalid&#39;</span><span class="o">,</span><span class="w"> </span><span class="nb">str</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Invalid timestamp should return &quot;Invalid&quot;&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test debug string</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsCustom</span><span class="o">,</span><span class="w"> </span><span class="mi">12345</span><span class="o">,</span><span class="w"> </span><span class="mi">9876543210</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">debugStr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">ToDebugString</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">debugStr</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;Source=Custom&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Debug string should contain source: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debugStr</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">debugStr</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;Base=12345&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Debug string should contain base: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debugStr</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">debugStr</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#39;Value=9876543210ns&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Debug string should contain value: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debugStr</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestDateTimeConversion</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">dt</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">convertedDt</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="o">;</span>
<span class="w">  </span><span class="n">diff</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test FromDateTime and ToDateTime round-trip</span>
<span class="w">  </span><span class="n">dt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mf">1.5</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1.5 days = 36 hours</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDateTime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsCustom</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should use tsCustom source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">CDelphiDateTimeEpoch</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should have Delphi DateTime epoch as timebase&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">convertedDt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">ToDateTime</span><span class="o">;</span>
<span class="w">  </span><span class="n">diff</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">convertedDt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">diff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.000001</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Round-trip conversion should be accurate&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with fractional seconds</span>
<span class="w">  </span><span class="n">dt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mf">0.001</span><span class="o">;</span><span class="w">  </span><span class="c1">// About 86.4 seconds</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDateTime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">convertedDt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">ToDateTime</span><span class="o">;</span>
<span class="w">  </span><span class="n">diff</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">convertedDt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">diff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.000001</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Small values should convert accurately&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test that TDateTime-based timestamps are compatible</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts2</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be able to subtract TDateTime timestamps&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestUnixTimeConversion</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">unixTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test FromUnixTime</span>
<span class="w">  </span><span class="n">unixTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1000000000</span><span class="o">;</span><span class="w">  </span><span class="c1">// September 9, 2001, 01:46:40 UTC</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromUnixTime</span><span class="p">(</span><span class="n">unixTime</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsCustom</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should use tsCustom source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">CUnixTimeEpoch</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should have Unix epoch as timebase&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">unixTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Value should be in nanoseconds&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with zero Unix time (epoch)</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromUnixTime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Unix epoch should have value 0&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">CUnixTimeEpoch</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should have Unix epoch as timebase&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test that Unix time-based timestamps are compatible</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts2</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">unixTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Difference should equal unix time in nanoseconds&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test negative Unix time (before epoch)</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromUnixTime</span><span class="p">(</span><span class="o">-</span><span class="mi">86400</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// One day before Unix epoch</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="o">-</span><span class="mi">86400</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should handle negative Unix time&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestUtilityFunctions</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">,</span><span class="w"> </span><span class="n">ts3</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">minTs</span><span class="o">,</span><span class="w"> </span><span class="n">maxTs</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test Zero</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Zero</span><span class="p">(</span><span class="n">tsDVB</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsDVB</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Zero should have correct source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Zero should have value 0&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Zero should have base 0&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Invalid</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Invalid</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsNone</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Invalid should have tsNone source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsFalse</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">IsValid</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Invalid timestamp should not be valid&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Min</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">2000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">minTs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="n">minTs</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Min should return smaller value&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">minTs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">ts2</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="n">minTs</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Min should work regardless of order&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Max</span>
<span class="w">  </span><span class="n">maxTs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">ts2</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="n">maxTs</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Max should return larger value&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">maxTs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">ts2</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">ts2</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="n">maxTs</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Max should work regardless of order&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test equal values</span>
<span class="w">  </span><span class="n">ts3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">minTs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts3</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="n">minTs</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Min of equal values should work&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestNegativeDurations</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">diff_ns</span><span class="o">,</span><span class="w"> </span><span class="n">diff_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">diff_sec</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test negative duration from subtraction</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">2000000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 2 seconds</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 second</span>

<span class="w">  </span><span class="c1">// ts2 - ts1 should be negative (earlier - later)</span>
<span class="w">  </span><span class="n">diff_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="o">-</span><span class="mi">1000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">diff_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Subtracting later from earlier should be negative&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test ToMilliseconds with negative result</span>
<span class="w">  </span><span class="n">diff_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">diff_ms</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Difference should be -1000ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test ToSeconds with negative result</span>
<span class="w">  </span><span class="n">diff_sec</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">.</span><span class="n">ToSeconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">diff_sec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0001</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Difference should be -1.0s&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test positive differences too</span>
<span class="w">  </span><span class="n">diff_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts2</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">diff_ms</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Reverse difference should be positive&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">diff_sec</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts2</span><span class="p">)</span><span class="o">.</span><span class="n">ToSeconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">diff_sec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0001</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Reverse difference should be 1.0s&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test arithmetic with negative durations</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDuration</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">500000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// Subtract 500ms</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">500000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Adding negative duration should work&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDuration</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">500000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// Add 500ms</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1500000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Subtracting negative duration should work&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test ToString with negative values</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDVB</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1234567890</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">ToString</span><span class="o">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Negative value should show minus sign&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestDurationFactoryMethods</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">timestamp</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test Nanoseconds</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Nanoseconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsDuration</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsDuration&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 1000 nanoseconds&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">IsDuration</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be duration&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Microseconds</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Microseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">500000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 500000 nanoseconds (500 microseconds)&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Milliseconds</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">100000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 100000000 nanoseconds (100 milliseconds)&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should convert back to 100 milliseconds&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Seconds with integer value</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">5000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 5000000000 nanoseconds (5 seconds)&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 5000 milliseconds&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Seconds with fractional value</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">2500000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 2500000000 nanoseconds (2.5 seconds)&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 2500 milliseconds&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Minutes</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Minutes</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">180000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 180000000000 nanoseconds (3 minutes)&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">180000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 180000 milliseconds&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test Hours</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Hours</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">7200000000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 7200000000000 nanoseconds (2 hours)&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">7200000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 7200000 milliseconds&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test duration arithmetic with timestamp</span>
<span class="w">  </span><span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Should be able to add duration to timestamp</span>
<span class="w">  </span><span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">duration</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsQueryPerformanceCounter</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should preserve timestamp source after adding duration&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test duration + duration</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 300 milliseconds&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">IsDuration</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Result should still be duration&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestElapsed</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test with QueryPerformanceCounter</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">elapsed</span><span class="o">.</span><span class="n">IsDuration</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Elapsed should return duration&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Sleep(50) should take approximately 50ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with TickCount</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">elapsed</span><span class="o">.</span><span class="n">IsDuration</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Elapsed should return duration&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Sleep(30) should take approximately 30ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with Stopwatch</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">elapsed</span><span class="o">.</span><span class="n">IsDuration</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Elapsed should return duration&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">35</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">70</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Sleep(40) should take approximately 40ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">  </span><span class="c1">// Test with TimeGetTime (Windows only)</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTimeGetTime</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">elapsed</span><span class="o">.</span><span class="n">IsDuration</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Elapsed should return duration&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">elapsed</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">65</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Sleep(35) should take approximately 35ms, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="cm">{$ENDIF}</span>

<span class="w">  </span><span class="c1">// Test that Elapsed raises exception for unsupported sources</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDuration</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nf">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">;</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EInvalidOpException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Elapsed should raise exception for tsDuration source&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="mi">12345</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nf">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">;</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EInvalidOpException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Elapsed should raise exception for tsCustom source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestFromValueOverloads</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">value_ms</span><span class="o">,</span><span class="w"> </span><span class="n">value_qpc</span><span class="o">,</span><span class="w"> </span><span class="n">value_sw</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test FromTickCount with value</span>
<span class="w">  </span><span class="n">value_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">5000</span><span class="o">;</span><span class="w">  </span><span class="c1">// 5 seconds in milliseconds</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="p">(</span><span class="n">value_ms</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsTickCount</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsTickCount source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeBase should be 0&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">value_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 5000ms in nanoseconds&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test compatibility between parameterless and value-based versions</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="p">(</span><span class="n">value_ms</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Value-based timestamps should be compatible and comparable&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test FromQueryPerformanceCounter with value</span>
<span class="w">  </span><span class="n">value_qpc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1000000</span><span class="o">;</span><span class="w">  </span><span class="c1">// Some QPC value</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="p">(</span><span class="n">value_qpc</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsQueryPerformanceCounter</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsQueryPerformanceCounter source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeBase should be 0&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should have positive nanosecond value&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test FromStopwatch with value</span>
<span class="w">  </span><span class="n">value_sw</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1000000</span><span class="o">;</span><span class="w">  </span><span class="c1">// Some stopwatch value</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromStopwatch</span><span class="p">(</span><span class="n">value_sw</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsStopwatch</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsStopwatch source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeBase should be 0&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should have positive nanosecond value&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">  </span><span class="c1">// Test FromTimeGetTime with value</span>
<span class="w">  </span><span class="n">value_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3000</span><span class="o">;</span><span class="w">  </span><span class="c1">// 3 seconds in milliseconds</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTimeGetTime</span><span class="p">(</span><span class="n">value_ms</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsTimeGetTime</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsTimeGetTime source&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeBase should be 0&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">value_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be 3000ms in nanoseconds&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="cm">{$ENDIF}</span>

<span class="w">  </span><span class="c1">// Test arithmetic with value-based timestamps</span>
<span class="w">  </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="p">(</span><span class="n">ts2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Difference should be 1000ms&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="cm">{$ENDIF}</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestAsString</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">serialized</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Test serialization of various timestamp types</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsStopwatch</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">serialized</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">AsString</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&#39;4|0|1000000000&#39;</span><span class="o">,</span><span class="w"> </span><span class="n">serialized</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should serialize to correct format&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test round-trip serialization/deserialization</span>
<span class="w">  </span><span class="n">ts2</span><span class="o">.</span><span class="n">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">serialized</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts2</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeSource should match&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeBase should match&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Value_ns should match&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with custom timebase</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="mi">12345</span><span class="o">,</span><span class="w"> </span><span class="mi">9876543210</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">serialized</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">AsString</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts2</span><span class="o">.</span><span class="n">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">serialized</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="nb">Ord</span><span class="p">(</span><span class="n">tsCustom</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts2</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Should be tsCustom&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;TimeBase should be preserved&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="mi">9876543210</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Value should be preserved&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with negative values</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tsDuration</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="o">-</span><span class="mi">500000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">serialized</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">AsString</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts2</span><span class="o">.</span><span class="n">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">serialized</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="kt">Int64</span><span class="p">(</span><span class="o">-</span><span class="mi">500000000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Negative value should be preserved&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test with DateTime</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDateTime</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">serialized</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">AsString</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts2</span><span class="o">.</span><span class="n">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">serialized</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">CDelphiDateTimeEpoch</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">.</span><span class="n">TimeBase</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;DateTime timebase should be preserved&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test invalid formats</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nc">ts2</span><span class="o">.</span><span class="nf">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&#39;invalid&#39;</span><span class="o">;</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EArgumentException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should raise exception for invalid format&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nc">ts2</span><span class="o">.</span><span class="nf">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&#39;1|2&#39;</span><span class="o">;</span><span class="w">  </span><span class="c1">// Missing third field</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EArgumentException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should raise exception for missing field&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nc">ts2</span><span class="o">.</span><span class="nf">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&#39;abc|0|1000&#39;</span><span class="o">;</span><span class="w">  </span><span class="c1">// Invalid TimeSource</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EArgumentException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should raise exception for invalid TimeSource&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nc">ts2</span><span class="o">.</span><span class="nf">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&#39;99|0|1000&#39;</span><span class="o">;</span><span class="w">  </span><span class="c1">// TimeSource out of range</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EArgumentException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should raise exception for TimeSource out of range&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nc">ts2</span><span class="o">.</span><span class="nf">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&#39;1|abc|1000&#39;</span><span class="o">;</span><span class="w">  </span><span class="c1">// Invalid TimeBase</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EArgumentException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should raise exception for invalid TimeBase&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nc">ts2</span><span class="o">.</span><span class="nf">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&#39;1|0|xyz&#39;</span><span class="o">;</span><span class="w">  </span><span class="c1">// Invalid Value_ns</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EArgumentException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should raise exception for invalid Value_ns&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">initialization</span>
<span class="w">  </span><span class="n">TDUnitX</span><span class="o">.</span><span class="n">RegisterTestFixture</span><span class="p">(</span><span class="n">TGpTimestampTests</span><span class="p">)</span><span class="o">;</span>

<span class="k">end</span><span class="o">.</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                <div class='system-reminder'>ü§ñ <em>Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.</em></div></div></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:25.509Z'>2025-11-27 09:21:25</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">Perfect! Now I understand the full context. Let me analyze what functions could benefit from the user&#x27;s suggested pattern.

Looking at the code:

1. **HasElapsed** (lines 737-779 in GpTimestamp.pas) -...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>Perfect! Now I understand the full context. Let me analyze what functions could benefit from the user's suggested pattern.</p>
<p>Looking at the code:</p>
<ol>
<li><p><strong>HasElapsed</strong> (lines 737-779 in GpTimestamp.pas) - This is the function the user wants to modify. Currently it raises an exception for unsupported sources (including tsNone). The user suggests it should return True for tsNone, which makes perfect sense for the loop pattern they described.</p>
</li>
<li><p><strong>Elapsed</strong> (lines 781-800) - This returns the time elapsed since the timestamp. Should this return a zero duration for tsNone? I don't think so - it doesn't make semantic sense to ask &quot;how much time has elapsed since an invalid timestamp?&quot;. It should continue raising an exception.</p>
</li>
<li><p><strong>Comparison operators</strong> (&gt;, &lt;, &gt;=, &lt;=, ==, !=) - These should NOT treat tsNone specially. Comparing an invalid timestamp doesn't make sense and should continue raising exceptions.</p>
</li>
<li><p><strong>Arithmetic operators</strong> (Add, Subtract) - These should NOT treat tsNone specially. Arithmetic with invalid timestamps doesn't make sense.</p>
</li>
<li><p><strong>IsValid</strong> (line 698-701) - Already handles tsNone correctly by returning false.</p>
</li>
</ol>
<p>So I think only <code>HasElapsed</code> should get this special treatment.</p>
<p>Let me think about the semantic meaning:</p>
<ul>
<li><code>HasElapsed</code> on an invalid timestamp means &quot;has the timeout expired?&quot;</li>
<li>If the timestamp is invalid (never initialized), then conceptually &quot;yes, you should do the action now because you haven't done it yet&quot;</li>
<li>This makes perfect sense for initialization patterns</li>
</ul>
<p>Now let me create a plan:</p>
<ol>
<li>Modify both <code>HasElapsed</code> overloads to check if <code>FTimeSource = tsNone</code> first, and return True if so</li>
<li>Update the XML documentation to describe this behavior</li>
<li>Add tests for this new behavior</li>
</ol>
<p>Let me create a todo list and get started.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:27.008Z'>2025-11-27 09:21:27</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Excellent idea! This makes perfect semantic sense. When a timestamp is invalid (never initialized), <code>HasElapsed</code> returning <code>True</code> means &quot;yes, you should perform the action now&quot; - perfect for initialization patterns.</p>
<p>Let me analyze which other functions might benefit from similar treatment:</p>
</div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01GiAmtBZjXa2p5mATKZnVKz">üìù Todo List</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:32.641Z'>2025-11-27 09:21:32</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
    <div class="todo-list">
        
                <div class="todo-item in_progress medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">üîÑ</span>
                    <span class="todo-content">Analyze which functions should handle tsNone specially</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Modify HasElapsed(timeout_ms: Int64) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Modify HasElapsed(duration: TGpTimestamp) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Update XML documentation for both HasElapsed overloads</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Add tests for HasElapsed with tsNone timestamps</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Run tests to verify all changes work correctly</span>
                    <span class="todo-id">#</span>
                </div>
            
    </div>
    </div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01GiAmtBZjXa2p5mATKZnVKz"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:32.742Z' data-duration='took 101 ms'>2025-11-27 09:21:32</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable</pre></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:38.787Z'>2025-11-27 09:21:38</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">After analyzing the code, I believe:

**Functions that SHOULD handle tsNone specially:**
1. `HasElapsed` (both overloads) - Return True when tsNone (the user&#x27;s suggestion)

**Functions that should NOT...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>After analyzing the code, I believe:</p>
<p><strong>Functions that SHOULD handle tsNone specially:</strong></p>
<ol>
<li><code>HasElapsed</code> (both overloads) - Return True when tsNone (the user's suggestion)</li>
</ol>
<p><strong>Functions that should NOT handle tsNone specially:</strong></p>
<ol>
<li><code>Elapsed</code> - Doesn't make semantic sense to ask &quot;how much time has elapsed since invalid timestamp&quot;. Should continue raising exception.</li>
<li>Comparison operators - Comparing invalid timestamps doesn't make sense</li>
<li>Arithmetic operators - Arithmetic with invalid timestamps doesn't make sense</li>
<li><code>IsValid</code> - Already correctly returns False for tsNone</li>
</ol>
<p>The user's insight is that <code>HasElapsed</code> is often used in control flow to decide &quot;should I do this action now?&quot; When the timestamp is invalid (not yet initialized), the answer should be &quot;yes, do it now (and initialize the timestamp)&quot;.</p>
<p>Let me document this analysis and proceed with the implementation.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:42.190Z'>2025-11-27 09:21:42</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Based on my analysis of the code, I believe <strong>only <code>HasElapsed</code> should handle <code>tsNone</code> specially</strong>. Here's my reasoning:</p>
<p><strong>Functions that SHOULD handle tsNone:</strong></p>
<ul>
<li><strong><code>HasElapsed</code> (both overloads)</strong> ‚úì - Your suggestion makes perfect sense. An invalid timestamp means &quot;not yet initialized,&quot; so returning <code>True</code> means &quot;yes, perform the action now and initialize the timer.&quot;</li>
</ul>
<p><strong>Functions that should NOT handle tsNone:</strong></p>
<ul>
<li><strong><code>Elapsed</code></strong> ‚úó - Asking &quot;how much time has elapsed since invalid timestamp?&quot; doesn't have a meaningful answer. Should continue raising exception.</li>
<li><strong>Comparison operators (<code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>, <code>=</code>, <code>&lt;&gt;</code>)</strong> ‚úó - Comparing invalid timestamps is meaningless and should remain an error.</li>
<li><strong>Arithmetic operators (<code>+</code>, <code>-</code>)</strong> ‚úó - Arithmetic with invalid timestamps doesn't make semantic sense.</li>
<li><strong><code>IsValid</code></strong> ‚úì - Already correctly returns <code>False</code> for <code>tsNone</code>.</li>
</ul>
<p>Let me implement this change:</p>
</div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_014k2WFBQ8E6Mb1F96muqokd">üìù Todo List</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:44.958Z'>2025-11-27 09:21:44</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
    <div class="todo-list">
        
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Analyze which functions should handle tsNone specially</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item in_progress medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">üîÑ</span>
                    <span class="todo-content">Modify HasElapsed(timeout_ms: Int64) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Modify HasElapsed(duration: TGpTimestamp) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Update XML documentation for both HasElapsed overloads</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Add tests for HasElapsed with tsNone timestamps</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Run tests to verify all changes work correctly</span>
                    <span class="todo-id">#</span>
                </div>
            
    </div>
    </div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_014k2WFBQ8E6Mb1F96muqokd"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:45.061Z' data-duration='took 103 ms'>2025-11-27 09:21:45</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable</pre></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:47.520Z'>2025-11-27 09:21:47</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Now let me modify the first HasElapsed overload.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01Hv4tqHnUXUDaf6zm8gNVSe">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:21:55.237Z'>2025-11-27 09:21:55</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>function TGpTimestamp.HasElapsed(timeout_ms: Int64): Boolean;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>var</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  currentTime: TGpTimestamp;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>begin</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // Invalid timestamp always returns True (allows simple initialization pattern)</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  if FTimeSource = tsNone then</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    Exit(True);</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  // Get current time from same source</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  case FTimeSource of</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    {$IFDEF MSWINDOWS}</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    tsTickCount: currentTime := FromTickCount;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    tsQueryPerformanceCounter: currentTime := FromQueryPerformanceCounter;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    tsTimeGetTime: currentTime := FromTimeGetTime;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    {$ENDIF}</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    tsStopwatch: currentTime := FromStopwatch;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  else</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    raise EInvalidOpException.CreateFmt(</div><div class='diff-line diff-context'><span class='diff-marker'> </span>      &#x27;HasElapsed not supported for time source: %d&#x27;, [Ord(FTimeSource)]);</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  end;</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  Result := (currentTime.FValue - FValue) &gt;= (timeout_ms * CNanosecondsPerMillisecond);</div><div class='diff-line diff-context'><span class='diff-marker'> </span>end;</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01Hv4tqHnUXUDaf6zm8gNVSe"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:23:05.166Z' data-duration='took 1m 9s'>2025-11-27 09:23:05</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>31 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nb">TryStrToInt64</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EArgumentException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span><span class="s">&#39;Invalid Value_ns value: &quot;%s&quot;&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nb">TryStrToInt64</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EArgumentException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span><span class="s">&#39;Invalid Value_ns value: &quot;%s&quot;&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">currentTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Invalid timestamp always returns True (allows simple initialization pattern)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsNone</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">Exit</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Get current time from same source</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">    </span><span class="n">tsTickCount</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsQueryPerformanceCounter</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsTimeGetTime</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTimeGetTime</span><span class="o">;</span>
<span class="w">    </span><span class="cm">{$ENDIF}</span>
<span class="w">    </span><span class="n">tsStopwatch</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span>
<span class="w">      </span><span class="s">&#39;HasElapsed not supported for time source: %d&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nb">Ord</span><span class="p">(</span><span class="n">FTimeSource</span><span class="p">)])</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">currentTime</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">currentTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:23:11.131Z'>2025-11-27 09:23:11</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Good! Now let me update the second overload of HasElapsed.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01SjQwLKsjKpL4W7Not6zdUZ">üìù Todo List</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:23:15.645Z'>2025-11-27 09:23:15</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
    <div class="todo-list">
        
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Analyze which functions should handle tsNone specially</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(timeout_ms: Int64) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item in_progress medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">üîÑ</span>
                    <span class="todo-content">Modify HasElapsed(duration: TGpTimestamp) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Update XML documentation for both HasElapsed overloads</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Add tests for HasElapsed with tsNone timestamps</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Run tests to verify all changes work correctly</span>
                    <span class="todo-id">#</span>
                </div>
            
    </div>
    </div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01SjQwLKsjKpL4W7Not6zdUZ"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:23:15.771Z' data-duration='took 126 ms'>2025-11-27 09:23:15</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable</pre></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:23:20.750Z'>2025-11-27 09:23:20</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Now let me modify the second HasElapsed overload that takes a TGpTimestamp duration parameter.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01CDSUDWVoMSzbQrAPdd3Td3">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:23:26.609Z'>2025-11-27 09:23:26</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>function TGpTimestamp.HasElapsed(const duration: TGpTimestamp): Boolean;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>var</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  currentTime: TGpTimestamp;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>begin</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  // Verify that duration parameter is actually a duration</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  if duration.FTimeSource &lt;&gt; tsDuration then</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    raise EInvalidOpException.Create(&#x27;HasElapsed duration parameter must have TimeSource = tsDuration&#x27;);</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // Invalid timestamp always returns True (allows simple initialization pattern)</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  if FTimeSource = tsNone then</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    Exit(True);</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  // Get current time from same source</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  case FTimeSource of</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    {$IFDEF MSWINDOWS}</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    tsTickCount: currentTime := FromTickCount;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    tsQueryPerformanceCounter: currentTime := FromQueryPerformanceCounter;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    tsTimeGetTime: currentTime := FromTimeGetTime;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    {$ENDIF}</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    tsStopwatch: currentTime := FromStopwatch;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  else</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    raise EInvalidOpException.CreateFmt(</div><div class='diff-line diff-context'><span class='diff-marker'> </span>      &#x27;HasElapsed not supported for time source: %d&#x27;, [Ord(FTimeSource)]);</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  end;</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  Result := (currentTime.FValue - FValue) &gt;= duration.FValue;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>end;</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01CDSUDWVoMSzbQrAPdd3Td3"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:07.530Z' data-duration='took 40.9s'>2025-11-27 09:24:07</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>35 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">currentTime</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">currentTime</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CNanosecondsPerMillisecond</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">currentTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Verify that duration parameter is actually a duration</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tsDuration</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">&#39;HasElapsed duration parameter must have TimeSource = tsDuration&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Invalid timestamp always returns True (allows simple initialization pattern)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsNone</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">Exit</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Get current time from same source</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="k">of</span>
<span class="w">    </span><span class="cm">{$IFDEF MSWINDOWS}</span>
<span class="w">    </span><span class="n">tsTickCount</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsQueryPerformanceCounter</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">    </span><span class="n">tsTimeGetTime</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromTimeGetTime</span><span class="o">;</span>
<span class="w">    </span><span class="cm">{$ENDIF}</span>
<span class="w">    </span><span class="n">tsStopwatch</span><span class="o">:</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">raise</span><span class="w"> </span><span class="n">EInvalidOpException</span><span class="o">.</span><span class="n">CreateFmt</span><span class="p">(</span>
<span class="w">      </span><span class="s">&#39;HasElapsed not supported for time source: %d&#39;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nb">Ord</span><span class="p">(</span><span class="n">FTimeSource</span><span class="p">)])</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">currentTime</span><span class="o">.</span><span class="n">FValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">FValue</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">duration</span><span class="o">.</span><span class="n">FValue</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">function</span><span class="w"> </span><span class="nc">TGpTimestamp</span><span class="o">.</span><span class="nf">Elapsed</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">currentTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:10.806Z'>2025-11-27 09:24:10</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Great! Now I need to update the XML documentation for both HasElapsed overloads to document this new behavior.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_016DjCVR4wD1tRuEpH19ZJ6r">üìù Todo List</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:15.297Z'>2025-11-27 09:24:15</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
    <div class="todo-list">
        
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Analyze which functions should handle tsNone specially</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(timeout_ms: Int64) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(duration: TGpTimestamp) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item in_progress medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">üîÑ</span>
                    <span class="todo-content">Update XML documentation for both HasElapsed overloads</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Add tests for HasElapsed with tsNone timestamps</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Run tests to verify all changes work correctly</span>
                    <span class="todo-id">#</span>
                </div>
            
    </div>
    </div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_016DjCVR4wD1tRuEpH19ZJ6r"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:15.407Z' data-duration='took 110 ms'>2025-11-27 09:24:15</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable</pre></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:19.734Z'>2025-11-27 09:24:19</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Now I need to find the XML documentation for both HasElapsed overloads and update them. Let me read the relevant section again to see the current documentation.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_018Yihv3raCjk16DDMZwkKF8">üìÑ Read <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:20.476Z'>2025-11-27 09:24:20</span>
                </div>
                
            </div>
        </div>
        <div class='content'></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_018Yihv3raCjk16DDMZwkKF8"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:21.976Z' data-duration='took 1.5s'>2025-11-27 09:24:21</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='read-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>15 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Checks if the specified timeout has elapsed since this timestamp.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the comparison.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Checks if the specified timeout has elapsed since this timestamp.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the comparison.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Checks if the specified duration has elapsed since this timestamp.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the comparison.</span>
<span class="w">    </span><span class="c1">/// The duration parameter must have TimeSource = tsDuration.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                <div class='system-reminder'>ü§ñ <em>Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.</em></div></div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:24.847Z'>2025-11-27 09:24:24</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>I can see the XML documentation for the two HasElapsed methods. Let me update them to include information about the tsNone behavior.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_011uvQFjCMucdD2o6DMiwVg2">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:27.218Z'>2025-11-27 09:24:27</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// &lt;summary&gt;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// Checks if the specified timeout has elapsed since this timestamp.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// Automatically uses the same time source for the comparison.</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    /// Returns True if the timestamp is invalid (TimeSource = tsNone), allowing simple initialization patterns.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// &lt;/summary&gt;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    function HasElapsed(timeout_ms: Int64): Boolean; overload;</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_011uvQFjCMucdD2o6DMiwVg2"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:44.989Z' data-duration='took 17.8s'>2025-11-27 09:24:44</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>14 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="c1">/// Returns true if the timestamp represents a duration (tsDuration source).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">IsDuration</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="c1">/// Returns true if the timestamp represents a duration (tsDuration source).</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">IsDuration</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="k">inline</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Checks if the specified timeout has elapsed since this timestamp.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the comparison.</span>
<span class="w">    </span><span class="c1">/// Returns True if the timestamp is invalid (TimeSource = tsNone), allowing simple initialization patterns.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Checks if the specified duration has elapsed since this timestamp.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the comparison.</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:47.959Z'>2025-11-27 09:24:47</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Good! Now let me update the second HasElapsed overload's documentation.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01PGejRqzyYdWL1nzkH3vza7">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:50.044Z'>2025-11-27 09:24:50</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// &lt;summary&gt;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// Checks if the specified duration has elapsed since this timestamp.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// Automatically uses the same time source for the comparison.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// The duration parameter must have TimeSource = tsDuration.</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    /// Returns True if the timestamp is invalid (TimeSource = tsNone), allowing simple initialization patterns.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    /// &lt;/summary&gt;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    function HasElapsed(const duration: TGpTimestamp): Boolean; overload;</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01PGejRqzyYdWL1nzkH3vza7"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:52.822Z' data-duration='took 2.8s'>2025-11-27 09:24:52</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>15 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="c1">/// Returns True if the timestamp is invalid (TimeSource = tsNone), allowing simple initialization patterns.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="c1">/// Returns True if the timestamp is invalid (TimeSource = tsNone), allowing simple initialization patterns.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Checks if the specified duration has elapsed since this timestamp.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the comparison.</span>
<span class="w">    </span><span class="c1">/// The duration parameter must have TimeSource = tsDuration.</span>
<span class="w">    </span><span class="c1">/// Returns True if the timestamp is invalid (TimeSource = tsNone), allowing simple initialization patterns.</span>
<span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>

<span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<span class="w">    </span><span class="c1">/// Returns the time elapsed since this timestamp as a duration.</span>
<span class="w">    </span><span class="c1">/// Automatically uses the same time source for the current time.</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:24:56.093Z'>2025-11-27 09:24:56</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Perfect! Now I need to add tests for the new behavior. Let me add a new test method or update the existing TestHasElapsed test.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_012fZG2kdkcD2QkRzm5Tg9a8">üìù Todo List</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:00.568Z'>2025-11-27 09:25:00</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
    <div class="todo-list">
        
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Analyze which functions should handle tsNone specially</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(timeout_ms: Int64) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(duration: TGpTimestamp) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Update XML documentation for both HasElapsed overloads</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item in_progress medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">üîÑ</span>
                    <span class="todo-content">Add tests for HasElapsed with tsNone timestamps</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item pending medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">‚è≥</span>
                    <span class="todo-content">Run tests to verify all changes work correctly</span>
                    <span class="todo-id">#</span>
                </div>
            
    </div>
    </div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_012fZG2kdkcD2QkRzm5Tg9a8"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:00.664Z' data-duration='took 96 ms'>2025-11-27 09:25:00</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable</pre></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:04.237Z'>2025-11-27 09:25:04</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">Now let me add tests for the new tsNone behavior. I&#x27;ll look at the existing TestHasElapsed test and add additional test cases for the tsNone behavior. I&#x27;ll update the existing test rather than creatin...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>Now let me add tests for the new tsNone behavior. I'll look at the existing TestHasElapsed test and add additional test cases for the tsNone behavior. I'll update the existing test rather than creating a new one.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01M7U8yfxrEQWiT2Ks1goAWt">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.UnitTests.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:11.758Z'>2025-11-27 09:25:11</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>  // Test that exception is raised for non-duration parameter</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  start := TGpTimestamp.FromQueryPerformanceCounter;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  duration := TGpTimestamp.FromTickCount;  // Not a duration</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  Assert.WillRaise(</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    procedure</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    begin</div><div class='diff-line diff-context'><span class='diff-marker'> </span>      start.HasElapsed(duration);</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    end,</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    EInvalidOpException,</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    &#x27;HasElapsed should raise exception when parameter is not tsDuration&#x27;);</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // Test that HasElapsed returns True for invalid timestamp (tsNone)</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  start := TGpTimestamp.Invalid;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  Assert.IsTrue(start.HasElapsed(1000), &#x27;HasElapsed should return True for invalid timestamp (Int64 overload)&#x27;);</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  duration := TGpTimestamp.Milliseconds(500);</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  Assert.IsTrue(start.HasElapsed(duration), &#x27;HasElapsed should return True for invalid timestamp (TGpTimestamp overload)&#x27;);</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // Test the initialization pattern</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  start := TGpTimestamp.Invalid;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  if start.HasElapsed(100) then</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  begin</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    start := TGpTimestamp.FromQueryPerformanceCounter;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    Assert.IsTrue(start.IsValid, &#x27;Timestamp should now be valid&#x27;);</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  end;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  Assert.IsTrue(start.IsValid, &#x27;Initialization pattern should have set valid timestamp&#x27;);</div><div class='diff-line diff-context'><span class='diff-marker'> </span>end;</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01M7U8yfxrEQWiT2Ks1goAWt"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:35.460Z' data-duration='took 23.7s'>2025-11-27 09:25:35</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>36 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should wait for 30ms duration, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test that exception is raised for non-duration parameter</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;Should wait for 30ms duration, got &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">actualElapsed_ms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#39;ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test that exception is raised for non-duration parameter</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span><span class="w">  </span><span class="c1">// Not a duration</span>

<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">WillRaise</span><span class="p">(</span>
<span class="w">    </span><span class="k">procedure</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="nc">start</span><span class="o">.</span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="o">;</span>
<span class="w">    </span><span class="k">end</span><span class="o">,</span>
<span class="w">    </span><span class="n">EInvalidOpException</span><span class="o">,</span>
<span class="w">    </span><span class="s">&#39;HasElapsed should raise exception when parameter is not tsDuration&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test that HasElapsed returns True for invalid timestamp (tsNone)</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Invalid</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;HasElapsed should return True for invalid timestamp (Int64 overload)&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;HasElapsed should return True for invalid timestamp (TGpTimestamp overload)&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Test the initialization pattern</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Invalid</span><span class="o">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">    </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">IsValid</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Timestamp should now be valid&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="o">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">IsValid</span><span class="o">,</span><span class="w"> </span><span class="s">&#39;Initialization pattern should have set valid timestamp&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TGpTimestampTests</span><span class="o">.</span><span class="nf">TestArithmetic</span><span class="o">;</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">timestamp</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:39.362Z'>2025-11-27 09:25:39</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Perfect! Now let me run the tests to verify all changes work correctly. I need to compile and run the test project.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_019o8TRPPn9KNBxE2XTaCCBC">üìù Todo List</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:43.722Z'>2025-11-27 09:25:43</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
    <div class="todo-list">
        
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Analyze which functions should handle tsNone specially</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(timeout_ms: Int64) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(duration: TGpTimestamp) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Update XML documentation for both HasElapsed overloads</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Add tests for HasElapsed with tsNone timestamps</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item in_progress medium">
                    <input type="checkbox"   readonly>
                    <span class="todo-status">üîÑ</span>
                    <span class="todo-content">Run tests to verify all changes work correctly</span>
                    <span class="todo-id">#</span>
                </div>
            
    </div>
    </div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_019o8TRPPn9KNBxE2XTaCCBC"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:43.820Z' data-duration='took 98 ms'>2025-11-27 09:25:43</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable</pre></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:46.669Z'>2025-11-27 09:25:46</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Now I need to compile and run the tests. Let me first compile the test project.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01MCc3FkMQQ8Qr5Mo1RZL5Qe">üõ†Ô∏è Bash <span class='tool-summary'>Compile GpTimestampTests with parent folder in unit path</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:48.230Z'>2025-11-27 09:25:48</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='bash-tool-content'><pre class='bash-tool-command'>cd src/tests &amp;&amp; &quot;C:\Program Files (x86)\Embarcadero\Studio\37.0\bin\dcc32.exe&quot; -B -U.. GpTimestampTests.dpr</pre></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01MCc3FkMQQ8Qr5Mo1RZL5Qe"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:55.243Z' data-duration='took 7.0s'>2025-11-27 09:25:55</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Embarcadero Delphi for Win32 compiler version 37.0
Copyright (c) 1983,2025 Embarcadero Technologies, Inc.
11788 lines, 0.98 seconds, 2759384 bytes code, 134884 bytes data.</pre></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:57.850Z'>2025-11-27 09:25:57</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Great! The compilation was successful. Now let me run the tests.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01DPiogKfQxsc1tDCDhU4M4Z">üõ†Ô∏è Bash <span class='tool-summary'>Run GpTimestampTests executable</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:25:58.611Z'>2025-11-27 09:25:58</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='bash-tool-content'><pre class='bash-tool-command'>cd src/tests &amp;&amp; ./GpTimestampTests.exe</pre></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01DPiogKfQxsc1tDCDhU4M4Z"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:00.638Z' data-duration='took 2.0s'>2025-11-27 09:26:00</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><pre>Running GpTimestamp Unit Tests
==============================

DUnitX - [GpTimestampTests.exe] - Starting Tests.

..............................................

Tests Found   : 23
Tests Ignored : 0
T...</pre></div>
        </summary>
        <div class="details-content">
            <pre>Running GpTimestamp Unit Tests
==============================

DUnitX - [GpTimestampTests.exe] - Starting Tests.

..............................................

Tests Found   : 23
Tests Ignored : 0
Tests Passed  : 23
Tests Leaked  : 0
Tests Failed  : 0
Tests Errored : 0

Tests completed.
Total:  23
Passed: 23
Failed: 0
Errors: 0

Press ENTER to exit...</pre>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:06.750Z'>2025-11-27 09:26:06</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">Perfect! All 23 tests passed, including the new tests I added for the tsNone behavior. Now I need to send an ENTER key to close the console window. Actually, I realize the test is waiting for input. L...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>Perfect! All 23 tests passed, including the new tests I added for the tsNone behavior. Now I need to send an ENTER key to close the console window. Actually, I realize the test is waiting for input. Let me handle this differently by killing the process or just leaving it (it will timeout eventually).</p>
<p>Actually, the Bash tool will handle this automatically after the timeout, but since I don't want to wait, let me just acknowledge the successful test run.</p>
<p>Now let me update the version history in the unit file to document this change.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:07.249Z'>2025-11-27 09:26:07</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Excellent! All 23 tests passed successfully. Let me update the version history to document this change:</p>
</div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01L1Q2KsRTLYbGW51DGFX46D">üìÑ Read <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:08.388Z'>2025-11-27 09:26:08</span>
                </div>
                
            </div>
        </div>
        <div class='content'></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01L1Q2KsRTLYbGW51DGFX46D"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:09.753Z' data-duration='took 1.4s'>2025-11-27 09:26:09</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='read-tool-result'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">SOFTWARE</span><span class="o">,</span><span class="w"> </span><span class="n">EVEN</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="n">ADVISED</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">THE</span><span class="w"> </span><span class="n">POSSIBILITY</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">SUCH</span><span class="w"> </span><span class="n">DAMAGE</span><span class="o">.</span>

<span class="w">   </span><span class="n">Author</span><span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="n">Primoz</span><span class="w"> </span><span class="n">Gabrijelcic</span>
<span class="w">   </span><span class="n">Creation</span><span class="w"> </span><span class="nb">date</span><span class="w">     </span><span class="o">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">15</span>
<span class="w">   </span><span class="n">Last</span><span class="w"> </span><span class="n">modification</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">16</span>
<span class="w">   </span><span class="n">Version</span><span class="w">           </span><span class="o">:</span><span class="w"> </span><span class="mf">0.1</span>
<span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;*</span><span class="p">)(</span><span class="o">*</span>
<span class="w">   </span><span class="n">History</span><span class="o">:</span>
<span class="w">     </span><span class="mf">0.1</span><span class="o">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">15</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Released</span><span class="o">.</span><span class="w"> </span><span class="k">Not</span><span class="w"> </span><span class="n">yet</span><span class="w"> </span><span class="n">fully</span><span class="w"> </span><span class="n">tested</span><span class="o">.</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">dragons</span><span class="err">!</span>
</code></pre></div></td></tr></table></div>
<div class='system-reminder'>ü§ñ <em>Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.</em></div></div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:12.930Z'>2025-11-27 09:26:12</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Let me update the version history to reflect this change. I'll increment to version 0.2 and document the HasElapsed enhancement.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01HnB9BGbKSiLELtd9j6DNiz">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.pas</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:16.319Z'>2025-11-27 09:26:16</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>   Author            : Primoz Gabrijelcic</div><div class='diff-line diff-context'><span class='diff-marker'> </span>   Creation date     : 2025-11-15</div><div class='diff-line diff-removed'><span class='diff-marker'>-</span>   Last modification : 2025-11-<mark class='diff-char-removed'>16</mark></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>   Last modification : 2025-11-<mark class='diff-char-added'>27</mark></div><div class='diff-line diff-removed'><span class='diff-marker'>-</span>   Version           : 0.<mark class='diff-char-removed'>1</mark></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>   Version           : 0.<mark class='diff-char-added'>2</mark></div><div class='diff-line diff-context'><span class='diff-marker'> </span>&lt;/pre&gt;*)(*</div><div class='diff-line diff-context'><span class='diff-marker'> </span>   History:</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>     0.2: 2025-11-27</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>       - HasElapsed now returns True when timestamp is invalid (TimeSource = tsNone),</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>         enabling simpler initialization patterns without explicit IsValid checks.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>     0.1: 2025-11-15</div><div class='diff-line diff-context'><span class='diff-marker'> </span>       - Released. Not yet fully tested. There may be dragons!</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01HnB9BGbKSiLELtd9j6DNiz"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:22.347Z' data-duration='took 6.0s'>2025-11-27 09:26:22</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>19 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">ANY</span><span class="w"> </span><span class="n">THEORY</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">LIABILITY</span><span class="o">,</span><span class="w"> </span><span class="n">WHETHER</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">CONTRACT</span><span class="o">,</span><span class="w"> </span><span class="n">STRICT</span><span class="w"> </span><span class="n">LIABILITY</span><span class="o">,</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">TORT</span>
<span class="p">(</span><span class="n">INCLUDING</span><span class="w"> </span><span class="n">NEGLIGENCE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">OTHERWISE</span><span class="p">)</span><span class="w"> </span><span class="n">ARISING</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">ANY</span><span class="w"> </span><span class="n">WAY</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">THE</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">THIS</span>
<span class="n">SOFTWARE</span><span class="o">,</span><span class="w"> </span><span class="n">EVEN</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="n">ADVISED</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">THE</span><span class="w"> </span><span class="n">POSSIBILITY</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">SUCH</span><span class="w"> </span><span class="n">DAMAGE</span><span class="o">.</span>

<span class="w">   </span><span class="n">Author</span><span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="n">Primoz</span><span class="w"> </span><span class="n">Gabrijelcic</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">ANY</span><span class="w"> </span><span class="n">THEORY</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">LIABILITY</span><span class="o">,</span><span class="w"> </span><span class="n">WHETHER</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">CONTRACT</span><span class="o">,</span><span class="w"> </span><span class="n">STRICT</span><span class="w"> </span><span class="n">LIABILITY</span><span class="o">,</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">TORT</span>
<span class="p">(</span><span class="n">INCLUDING</span><span class="w"> </span><span class="n">NEGLIGENCE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">OTHERWISE</span><span class="p">)</span><span class="w"> </span><span class="n">ARISING</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="n">ANY</span><span class="w"> </span><span class="n">WAY</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">THE</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">THIS</span>
<span class="n">SOFTWARE</span><span class="o">,</span><span class="w"> </span><span class="n">EVEN</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="n">ADVISED</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">THE</span><span class="w"> </span><span class="n">POSSIBILITY</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">SUCH</span><span class="w"> </span><span class="n">DAMAGE</span><span class="o">.</span>

<span class="w">   </span><span class="n">Author</span><span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="n">Primoz</span><span class="w"> </span><span class="n">Gabrijelcic</span>
<span class="w">   </span><span class="n">Creation</span><span class="w"> </span><span class="nb">date</span><span class="w">     </span><span class="o">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">15</span>
<span class="w">   </span><span class="n">Last</span><span class="w"> </span><span class="n">modification</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">27</span>
<span class="w">   </span><span class="n">Version</span><span class="w">           </span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span>
<span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;*</span><span class="p">)(</span><span class="o">*</span>
<span class="w">   </span><span class="n">History</span><span class="o">:</span>
<span class="w">     </span><span class="mf">0.2</span><span class="o">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">27</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">HasElapsed</span><span class="w"> </span><span class="nb">now</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="k">True</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="p">(</span><span class="n">TimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsNone</span><span class="p">)</span><span class="o">,</span>
<span class="w">         </span><span class="n">enabling</span><span class="w"> </span><span class="n">simpler</span><span class="w"> </span><span class="k">initialization</span><span class="w"> </span><span class="n">patterns</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">explicit</span><span class="w"> </span><span class="n">IsValid</span><span class="w"> </span><span class="n">checks</span><span class="o">.</span>
<span class="w">     </span><span class="mf">0.1</span><span class="o">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">15</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">Released</span><span class="o">.</span><span class="w"> </span><span class="k">Not</span><span class="w"> </span><span class="n">yet</span><span class="w"> </span><span class="n">fully</span><span class="w"> </span><span class="n">tested</span><span class="o">.</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">dragons</span><span class="err">!</span>
<span class="o">*</span><span class="p">)</span>

<span class="k">unit</span><span class="w"> </span><span class="n">GpTimestamp</span><span class="o">;</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:25.541Z'>2025-11-27 09:26:25</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Perfect! Let me mark the final todo as completed and summarize what was done.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_0194dgy1dJtrnagJTPPj846v">üìù Todo List</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:30.076Z'>2025-11-27 09:26:30</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
    <div class="todo-list">
        
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Analyze which functions should handle tsNone specially</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(timeout_ms: Int64) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Modify HasElapsed(duration: TGpTimestamp) to return True for tsNone</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Update XML documentation for both HasElapsed overloads</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Add tests for HasElapsed with tsNone timestamps</span>
                    <span class="todo-id">#</span>
                </div>
            
                <div class="todo-item completed medium">
                    <input type="checkbox" checked disabled readonly>
                    <span class="todo-status">‚úÖ</span>
                    <span class="todo-content">Run tests to verify all changes work correctly</span>
                    <span class="todo-id">#</span>
                </div>
            
    </div>
    </div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_0194dgy1dJtrnagJTPPj846v"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:30.175Z' data-duration='took 99 ms'>2025-11-27 09:26:30</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable</pre></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:35.445Z'>2025-11-27 09:26:35</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Perfect! All tasks are completed. Let me provide a summary to the user about what was done.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:26:44.470Z'>2025-11-27 09:26:44</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Perfect! I've successfully implemented your suggestion. Here's what was done:</p>
<h2>Summary of Changes</h2>
<p><strong>Modified Functions:</strong></p>
<ul>
<li>Both <code>HasElapsed</code> overloads now return <code>True</code> when <code>TimeSource = tsNone</code></li>
<li>This enables the clean initialization pattern you described</li>
</ul>
<p><strong>Code Changes in <code>GpTimestamp.pas</code>:</strong></p>
<ol>
<li>Added early return in both <code>HasElapsed</code> methods:<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">FTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsNone</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="k">Exit</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="o">;</span>
</code></pre></div>
</li>
<li>Updated XML documentation for both overloads to document this behavior</li>
<li>Incremented version to 0.2 with change history</li>
</ol>
<p><strong>Tests Added in <code>GpTimestamp.UnitTests.pas</code>:</strong></p>
<ul>
<li>Test that <code>HasElapsed</code> returns <code>True</code> for invalid timestamp (both overloads)</li>
<li>Test the initialization pattern you described</li>
<li>All 23 tests pass successfully ‚úì</li>
</ul>
<p><strong>Analysis of Other Functions:</strong><br />
After reviewing the codebase, I concluded that <strong>only <code>HasElapsed</code> should have this special behavior</strong>:</p>
<ul>
<li>‚úì <code>HasElapsed</code> - Now returns <code>True</code> for <code>tsNone</code> (simplifies initialization)</li>
<li>‚úó <code>Elapsed</code> - Should still raise exception (no meaningful elapsed time from invalid timestamp)</li>
<li>‚úó Comparison operators - Should still raise exception (comparing invalid timestamps is meaningless)</li>
<li>‚úó Arithmetic operators - Should still raise exception (arithmetic with invalid timestamps is meaningless)</li>
</ul>
<p>Now you can use the cleaner pattern:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="nb">time</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">_TS_</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="k">begin</span>
<span class="w">  </span><span class="c1">// Do work</span>
<span class="w">  </span><span class="nb">time</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_TS_</span><span class="o">.</span><span class="n">FromStopwatch</span><span class="o">;</span><span class="w">  </span><span class="c1">// Re-initialize</span>
<span class="k">end</span><span class="o">;</span>
</code></pre></div>
<p>The change is well-documented, tested, and semantically sound!</p>
</div>
    </div>
    
    
    
    
    <div class='message user'>
        <div class='header'>
            <span>ü§∑ User</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:37.058Z'>2025-11-27 09:27:37</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Should GpTimestamp.md also be updated?</pre></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:41.853Z'>2025-11-27 09:27:41</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>The user is asking if GpTimestamp.md should be updated. Let me check if that file exists and what it contains.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:42.252Z'>2025-11-27 09:27:42</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Good catch! Let me check if that file exists and update it:</p>
</div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_015gSLb6QnYDPQD1CZubGR5k">üõ†Ô∏è Glob</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:42.577Z'>2025-11-27 09:27:42</span>
                </div>
                
            </div>
        </div>
        <div class='content'><table class='tool-params-table'>
            <tr>
                <td class='tool-param-key'>pattern</td>
                <td class='tool-param-value'>**/GpTimestamp.md</td>
            </tr>
        </table></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_015gSLb6QnYDPQD1CZubGR5k"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:44.715Z' data-duration='took 2.1s'>2025-11-27 09:27:44</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.md</pre></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:48.823Z'>2025-11-27 09:27:48</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Yes, there is a GpTimestamp.md file. Let me read it to see what needs to be updated.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01RSt774Fbab6hCi1fKtxBwJ">üìÑ Read <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.md</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:49.145Z'>2025-11-27 09:27:49</span>
                </div>
                
            </div>
        </div>
        <div class='content'></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01RSt774Fbab6hCi1fKtxBwJ"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:50.896Z' data-duration='took 1.8s'>2025-11-27 09:27:50</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='read-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>856 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh"># GpTimestamp - Type-Safe Timestamp with Multiple Time Sources</span>

<span class="gs">**Version:**</span> 0.1 (2025-11-16)
<span class="gs">**Author:**</span> Primoz Gabrijelcic (navigator), Claude Code (driver)
<span class="gs">**License:**</span> BSD
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh"># GpTimestamp - Type-Safe Timestamp with Multiple Time Sources</span>

<span class="gs">**Version:**</span> 0.1 (2025-11-16)
<span class="gs">**Author:**</span> Primoz Gabrijelcic (navigator), Claude Code (driver)
<span class="gs">**License:**</span> BSD
<span class="gs">**Unit File:**</span> GpTimestamp.pas

<span class="gu">## Overview</span>

GpTimestamp provides a type-safe timestamp implementation that prevents mixing incompatible time measurements through operator overloading. All time values are stored internally as nanoseconds (Int64), providing 292 years of range at nanosecond precision.

<span class="gu">### Key Features</span>

<span class="k">-</span><span class="w"> </span><span class="gs">**Type-safe time measurements**</span> - Prevents mixing timestamps from different sources
<span class="k">-</span><span class="w"> </span><span class="gs">**Multiple time sources**</span> - Support for QueryPerformanceCounter, GetTickCount, TStopwatch, DVB timestamps, and more
<span class="k">-</span><span class="w"> </span><span class="gs">**Operator overloading**</span> - Automatic compatibility checking on all arithmetic and comparison operations
<span class="k">-</span><span class="w"> </span><span class="gs">**Nanosecond precision**</span> - All values stored as Int64 nanoseconds internally
<span class="k">-</span><span class="w"> </span><span class="gs">**Cross-platform support**</span> - Works on Windows and non-Windows platforms with appropriate fallbacks
<span class="k">-</span><span class="w"> </span><span class="gs">**Fail-fast design**</span> - Raises EInvalidOpException immediately when mixing incompatible timebases
<span class="k">-</span><span class="w"> </span><span class="gs">**Duration semantics**</span> - Special <span class="sb">`tsDuration`</span> source type compatible with all other sources

<span class="gu">## Platform Dependencies</span>

<span class="gu">### Windows-Only Features</span>

The following features are <span class="gs">**only available on Windows**</span> (controlled by <span class="sb">`{$IFDEF MSWINDOWS}`</span>):

| Feature | Description | Dependency/Alternative |
|---------|-------------|------------------------|
| <span class="sb">`FromTickCount`</span> (both overloads) | GetTickCount64 timing | Use <span class="sb">`FromStopwatch`</span> for cross-platform |
| <span class="sb">`FromQueryPerformanceCounter`</span> (both overloads) | QueryPerformanceCounter timing | Use <span class="sb">`FromStopwatch`</span> for cross-platform |
| <span class="sb">`FromTimeGetTime`</span> (both overloads) | Multimedia timer via DSiTimeGetTime64 | Requires <span class="gs">**DSiWin32.pas**</span> |
| <span class="sb">`HasElapsed`</span> (for TickCount/QPC/TimeGetTime) | Timeout checking | Use <span class="sb">`FromStopwatch`</span> timestamps instead |
| <span class="sb">`Elapsed`</span> (for TickCount/QPC/TimeGetTime) | Elapsed time | Use <span class="sb">`FromStopwatch`</span> timestamps instead |

<span class="gu">### Platform-Specific Implementations</span>

| Method | Windows Implementation | Non-Windows Fallback |
|--------|----------------------|---------------------|
| <span class="sb">`GetPerformanceFrequency`</span> | QueryPerformanceFrequency | TStopwatch.Frequency |

<span class="gu">### Fully Cross-Platform Features</span>

<span class="k">-</span><span class="w"> </span><span class="sb">`FromStopwatch`</span> - Uses System.Diagnostics.TStopwatch
<span class="k">-</span><span class="w"> </span><span class="sb">`FromDVB_PCR`</span> / <span class="sb">`FromDVB_PTS`</span> - DVB timestamp support
<span class="k">-</span><span class="w"> </span><span class="sb">`FromDateTime`</span> / <span class="sb">`ToDateTime`</span> - TDateTime conversions
<span class="k">-</span><span class="w"> </span><span class="sb">`FromUnixTime`</span> - Unix timestamp support
<span class="k">-</span><span class="w"> </span><span class="sb">`FromCustom`</span> - Custom timebase support
<span class="k">-</span><span class="w"> </span>All conversion methods (ToMilliseconds, ToMicroseconds, etc.)
<span class="k">-</span><span class="w"> </span>All operators and comparisons

<span class="gu">## Minimum Delphi Version</span>

<span class="gs">**Minimum Required:**</span> Delphi 2010 or later (intruduction of TStopwatch)

<span class="gu">## Dependencies</span>

<span class="gu">### Required Units</span>

<span class="k">1.</span> <span class="gs">**System.SysUtils**</span> - Exception handling, string formatting
<span class="k">2.</span> <span class="gs">**System.Diagnostics**</span> - TStopwatch for cross-platform timing

<span class="gu">### Conditional Windows Dependencies</span>

<span class="k">3.</span> <span class="gs">**Winapi.Windows**</span> - QueryPerformanceCounter, QueryPerformanceFrequency, GetTickCount64
<span class="k">4.</span> <span class="gs">**DSiWin32.pas**</span> - DSiTimeGetTime64 function (located in same directory)

<span class="k">&gt; </span><span class="ge">**Note:** GpTimestamp is self-contained and doesn&#39;t depend on other GpXxx utility units, making it safe for use in base infrastructure projects.</span>

<span class="gu">## Time Sources</span>

<span class="sb">```pascal</span>
<span class="n">TTimeSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">tsNone</span><span class="o">,</span><span class="w">                    </span><span class="c1">// Uninitialized</span>
<span class="w">  </span><span class="n">tsTickCount</span><span class="o">,</span><span class="w">               </span><span class="c1">// GetTickCount64 - millisecond resolution (Windows only)</span>
<span class="w">  </span><span class="n">tsQueryPerformanceCounter</span><span class="o">,</span><span class="w"> </span><span class="c1">// QueryPerformanceCounter - high precision (Windows only)</span>
<span class="w">  </span><span class="n">tsTimeGetTime</span><span class="o">,</span><span class="w">             </span><span class="c1">// DSiTimeGetTime64 - millisecond resolution (Windows only)</span>
<span class="w">  </span><span class="n">tsStopwatch</span><span class="o">,</span><span class="w">               </span><span class="c1">// TStopwatch - high precision (cross-platform)</span>
<span class="w">  </span><span class="n">tsCustom</span><span class="o">,</span><span class="w">                  </span><span class="c1">// User-defined timebase</span>
<span class="w">  </span><span class="n">tsDVB</span><span class="o">,</span><span class="w">                     </span><span class="c1">// DVB/MPEG PCR/PTS timestamps</span>
<span class="w">  </span><span class="n">tsDuration</span><span class="w">                 </span><span class="c1">// Pure duration, compatible with all sources</span>
<span class="p">)</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">## Type Alias</span>

<span class="sb">```pascal</span>
<span class="n">_TS_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>

A short alias for <span class="sb">`TGpTimestamp`</span> to reduce verbosity in code. Use this for cleaner, more concise syntax:

<span class="sb">```pascal</span>
<span class="c1">// Instead of:</span>
<span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">;</span>
<span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Microseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">Something</span><span class="p">()</span><span class="o">;</span>

<span class="c1">// You can write:</span>
<span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_TS_</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">;</span>
<span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">_TS_</span><span class="o">.</span><span class="n">Microseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">Something</span><span class="p">()</span><span class="o">;</span>
<span class="sb">```</span>

The alias is particularly useful when using factory methods and duration creation frequently in your code.

<span class="gu">## Public Constants</span>

<span class="gu">### Timebase Constants</span>

<span class="sb">```pascal</span>
<span class="k">const</span>
<span class="w">  </span><span class="c1">// Delphi TDateTime epoch (December 30, 1899)</span>
<span class="w">  </span><span class="c1">// Used by FromDateTime; all TDateTime-based timestamps share this timebase</span>
<span class="w">  </span><span class="n">CDelphiDateTimeEpoch</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18991230</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Unix epoch (January 1, 1970, 00:00:00 UTC)</span>
<span class="w">  </span><span class="c1">// Used by FromUnixTime; all Unix time-based timestamps share this timebase</span>
<span class="w">  </span><span class="n">CUnixTimeEpoch</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">19700101</span><span class="o">;</span>
<span class="sb">```</span>

These constants can be used with the <span class="sb">`Create`</span> or <span class="sb">`FromCustom`</span> methods to create timestamps compatible with DateTime or Unix time values.

<span class="gu">## API Reference</span>

<span class="gu">### Factory Methods (Class Functions)</span>

<span class="gu">#### High-Precision Timing (Cross-Platform)</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromStopwatch</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromStopwatch</span><span class="p">(</span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>
<span class="sb">```</span>
Captures current time from TStopwatch, or creates a timestamp from a specific TStopwatch value. Fully cross-platform with microsecond+ resolution. The overload with value parameter allows creating timestamps from previously captured stopwatch values.

<span class="gu">#### High-Precision Timing (Windows Only)</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromQueryPerformanceCounter</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w">  </span><span class="c1">// Windows only</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromQueryPerformanceCounter</span><span class="p">(</span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w">  </span><span class="c1">// Windows only</span>
<span class="sb">```</span>
Captures current time from QueryPerformanceCounter (microsecond+ resolution), or creates a timestamp from a specific QPC value. <span class="gs">**Windows only.**</span> The overload with value parameter allows creating timestamps from previously captured QPC values. For cross-platform high-precision timing, use <span class="sb">`FromStopwatch`</span> instead.

<span class="gu">#### Millisecond-Resolution Timing (Windows Only)</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromTickCount</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w">  </span><span class="c1">// Windows only</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromTickCount</span><span class="p">(</span><span class="n">value_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w">  </span><span class="c1">// Windows only</span>
<span class="sb">```</span>
Captures current time from GetTickCount64 (millisecond resolution), or creates a timestamp from a specific tick count value in milliseconds. <span class="gs">**Windows only.**</span> The overload with value parameter allows creating timestamps from previously captured tick count values. For cross-platform timing, use <span class="sb">`FromStopwatch`</span> instead.

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromTimeGetTime</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w">  </span><span class="c1">// Windows only</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromTimeGetTime</span><span class="p">(</span><span class="n">value_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span><span class="w">  </span><span class="c1">// Windows only</span>
<span class="sb">```</span>
Captures current time from DSiTimeGetTime64 (millisecond resolution), or creates a timestamp from a specific TimeGetTime value in milliseconds. <span class="gs">**Windows only.**</span> The overload with value parameter allows creating timestamps from previously captured TimeGetTime values.

<span class="gu">#### External Timestamp Conversions</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromDateTime</span><span class="p">(</span><span class="n">dt</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Creates a timestamp from TDateTime value. Uses tsCustom with CDelphiDateTimeEpoch as timebase. All TDateTime-based timestamps are compatible with each other.

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromUnixTime</span><span class="p">(</span><span class="n">unixTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Creates a timestamp from Unix time (seconds since January 1, 1970, 00:00:00 UTC). Uses tsCustom with CUnixTimeEpoch as timebase. All Unix time-based timestamps are compatible with each other.

<span class="gu">#### DVB Timestamp Support</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromDVB_PCR</span><span class="p">(</span><span class="n">pcr</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Creates a timestamp from DVB PCR (Program Clock Reference) value. PCR uses a 27 MHz clock (1 tick ‚âà 37.037 nanoseconds).

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromDVB_PTS</span><span class="p">(</span><span class="n">pts</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Creates a timestamp from DVB PTS (Presentation Time Stamp) value. PTS uses a 90 kHz clock (1 tick ‚âà 11111.111 nanoseconds).

<span class="gu">#### Custom Timestamps</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">FromCustom</span><span class="p">(</span><span class="n">aTimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w"> </span><span class="n">aValue_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Creates a timestamp with a custom timebase and value in nanoseconds. Timestamps with the same timebase are compatible.

<span class="gu">#### Duration Factory Methods</span>

These methods create duration timestamps (tsDuration source) that are compatible with all other timestamp sources.

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Nanoseconds</span><span class="p">(</span><span class="n">ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Microseconds</span><span class="p">(</span><span class="n">us</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Milliseconds</span><span class="p">(</span><span class="n">ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Seconds</span><span class="p">(</span><span class="n">s</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Minutes</span><span class="p">(</span><span class="n">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Hours</span><span class="p">(</span><span class="n">h</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>

Create durations of the specified length. The <span class="sb">`Seconds`</span> method supports fractional values for sub-second precision. All return tsDuration timestamps that can be used in arithmetic with any timestamp source.

<span class="gs">**Examples:**</span>
<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">timeout</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">delay</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">timestamp</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Create durations</span>
<span class="w">  </span><span class="n">timeout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">delay</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Use in arithmetic</span>
<span class="w">  </span><span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Minutes</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// Add 5 minutes</span>

<span class="w">  </span><span class="c1">// Combine durations</span>
<span class="w">  </span><span class="n">delay</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1.5 seconds</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">#### Generic Creation</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Create</span><span class="p">(</span><span class="n">aTimeSource</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="o">;</span><span class="w"> </span><span class="n">aTimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">                     </span><span class="n">aValue_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Creates a timestamp with explicit time source, timebase, and value in nanoseconds. Most flexible creation method. Use this when you need complete control over all timestamp parameters.

<span class="gu">#### Utility Factory Methods</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Zero</span><span class="p">(</span><span class="n">source</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Returns a zero timestamp for the specified time source.

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Invalid</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Returns an invalid timestamp (tsNone source).

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Min</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Returns the earlier of two timestamps. Raises exception if timestamps are incompatible.

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="nf">Max</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Returns the later of two timestamps. Raises exception if timestamps are incompatible.

<span class="gu">### Conversion Methods</span>

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToMilliseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToMicroseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToNanoseconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToSeconds</span><span class="o">:</span><span class="w"> </span><span class="kt">Double</span><span class="o">;</span>
<span class="sb">```</span>
Convert the timestamp value to various time units. Note: Precision depends on the time source; this is just unit conversion.

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToPCR</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToPTS</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="sb">```</span>
Convert the timestamp to DVB PCR or PTS values (27 MHz and 90 kHz clocks respectively).

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToDateTime</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="o">;</span>
<span class="sb">```</span>
Converts the timestamp to TDateTime. Note: Returns a relative time value, not an absolute date/time.

<span class="gu">### String Conversions</span>

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="sb">```</span>
Returns a human-readable string representation. Format: &quot;1.234567s [QPC]&quot; or &quot;123.456ms [TickCount]&quot;.

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">ToDebugString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="sb">```</span>
Returns a detailed debug string with all internal fields. Format: &quot;Source=QPC, Base=0, Value=1234567890ns&quot;.

<span class="sb">```pascal</span>
<span class="k">property</span><span class="w"> </span><span class="py">AsString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="kp">read</span><span class="o">/</span><span class="kp">write</span><span class="o">;</span>
<span class="sb">```</span>
Serializes and deserializes the timestamp to/from a string representation. This property allows you to save and restore the complete state of a timestamp, including TimeSource, TimeBase, and Value_ns.

<span class="gs">**Format:**</span> <span class="sb">`&quot;TimeSource|TimeBase|Value_ns&quot;`</span>

<span class="gs">**Example:**</span>
<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">serialized</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="mi">12345</span><span class="o">,</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">serialized</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">AsString</span><span class="o">;</span><span class="w">  </span><span class="c1">// &quot;5|12345|1000000000&quot;</span>

<span class="w">  </span><span class="c1">// Later, restore the timestamp</span>
<span class="w">  </span><span class="n">ts2</span><span class="o">.</span><span class="n">AsString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">serialized</span><span class="o">;</span>
<span class="w">  </span><span class="c1">// ts2 now has the same TimeSource, TimeBase, and Value_ns as ts1</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gs">**Error Handling:**</span> Setting AsString with an invalid format raises EArgumentException with a descriptive message.

<span class="gu">### State Checking Methods</span>

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">IsValid</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="sb">```</span>
Returns true if the timestamp has a valid time source (not tsNone).

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">IsDuration</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="sb">```</span>
Returns true if the timestamp represents a duration (tsDuration source).

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>
<span class="k">function</span><span class="w"> </span><span class="nf">HasElapsed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span><span class="w"> </span><span class="n">overload</span><span class="o">;</span>
<span class="sb">```</span>
Checks if the specified timeout has elapsed since this timestamp. Automatically uses the same time source for the comparison.

The first overload accepts timeout in milliseconds as an Int64.

The second overload accepts a TGpTimestamp duration (TimeSource must be tsDuration), enabling more readable, self-documenting code using the duration factory methods.

<span class="gs">**Supported for:**</span>
<span class="k">-</span><span class="w"> </span>Cross-platform: tsStopwatch
<span class="k">-</span><span class="w"> </span>Windows only: tsTickCount, tsQueryPerformanceCounter, tsTimeGetTime

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">Elapsed</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
Returns the time elapsed since this timestamp as a duration (tsDuration). Automatically captures the current time using the same time source and returns the difference. This is a convenience method equivalent to <span class="sb">`(TGpTimestamp.FromXxx - self)`</span> but more readable.

<span class="gs">**Supported for:**</span>
<span class="k">-</span><span class="w"> </span>Cross-platform: tsStopwatch
<span class="k">-</span><span class="w"> </span>Windows only: tsTickCount, tsQueryPerformanceCounter, tsTimeGetTime

<span class="gs">**Raises:**</span> EInvalidOpException for unsupported time sources (tsCustom, tsDVB, tsDuration, tsNone).

<span class="gs">**Example:**</span>
<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">DoWork</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span><span class="w">  </span><span class="c1">// Clean and readable!</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Operators</span>

<span class="gu">#### Arithmetic Operators</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">Subtract</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
<span class="gs">**Semantics:**</span>
<span class="k">-</span><span class="w"> </span><span class="sb">`timestamp - timestamp`</span> ‚Üí duration (tsDuration source)
<span class="k">-</span><span class="w"> </span><span class="sb">`duration - duration`</span> ‚Üí duration
<span class="k">-</span><span class="w"> </span><span class="sb">`duration - timestamp`</span> ‚Üí <span class="gs">**ERROR**</span> (raises EInvalidOpException)

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">Add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
<span class="gs">**Semantics:**</span>
<span class="k">-</span><span class="w"> </span><span class="sb">`timestamp + duration`</span> ‚Üí timestamp (preserves timestamp&#39;s source)
<span class="k">-</span><span class="w"> </span><span class="sb">`duration + timestamp`</span> ‚Üí timestamp (preserves timestamp&#39;s source)
<span class="k">-</span><span class="w"> </span><span class="sb">`duration + duration`</span> ‚Üí duration
<span class="k">-</span><span class="w"> </span><span class="sb">`timestamp + timestamp`</span> ‚Üí <span class="gs">**ERROR**</span> (raises EInvalidOpException)

<span class="gu">#### Comparison Operators</span>

<span class="sb">```pascal</span>
<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">GreaterThan</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">LessThan</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">GreaterThanOrEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">LessThanOrEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">Equal</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="k">class</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="nf">NotEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="o">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="o">;</span>
<span class="sb">```</span>
All comparison operators check compatibility before comparing values. Raises EInvalidOpException if timestamps have incompatible timebases.

<span class="gu">### Properties</span>

<span class="sb">```pascal</span>
<span class="k">property</span><span class="w"> </span><span class="py">TimeSource</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="w"> </span><span class="kp">read</span><span class="w"> </span><span class="nf">FTimeSource</span><span class="o">;</span>
<span class="sb">```</span>
The time source used for this timestamp.

<span class="sb">```pascal</span>
<span class="k">property</span><span class="w"> </span><span class="py">TimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="w"> </span><span class="kp">read</span><span class="w"> </span><span class="nf">FTimeBase</span><span class="o">;</span>
<span class="sb">```</span>
The reference timebase (0 for source&#39;s natural origin, or custom epoch value).

<span class="sb">```pascal</span>
<span class="k">property</span><span class="w"> </span><span class="py">Value_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="w"> </span><span class="kp">read</span><span class="w"> </span><span class="nf">FValue</span><span class="o">;</span>
<span class="sb">```</span>
The time value in nanoseconds.

<span class="gu">## Compatibility Rules</span>

The <span class="sb">`CheckCompatible`</span> method implements the following rules (enforced by all operators):

<span class="gu">### Rule 0: Duration is Universal</span>
<span class="gs">**tsDuration is compatible with everything.**</span> This allows:
<span class="k">-</span><span class="w"> </span><span class="sb">`duration + timestamp`</span> = timestamp
<span class="k">-</span><span class="w"> </span><span class="sb">`timestamp - duration`</span> = timestamp
<span class="k">-</span><span class="w"> </span><span class="sb">`duration + duration`</span> = duration

<span class="gu">### Rule 1: Same Source Type</span>
<span class="gs">**All timestamps from the same source are compatible.**</span> For example:
<span class="k">-</span><span class="w"> </span>All <span class="sb">`FromTickCount`</span> calls are compatible with each other
<span class="k">-</span><span class="w"> </span>All <span class="sb">`FromQueryPerformanceCounter`</span> calls are compatible with each other
<span class="k">-</span><span class="w"> </span>All <span class="sb">`FromStopwatch`</span> calls are compatible with each other

<span class="gu">### Rule 2: Custom Timebase Matching</span>
<span class="gs">**Two tsCustom timestamps with the same FTimeBase are compatible.**</span> This enables session-relative measurements.

<span class="gu">### Rule 3: Everything Else is Incompatible</span>
<span class="gs">**Different sources or different custom timebases raise EInvalidOpException.**</span>

Examples:
<span class="sb">```pascal</span>
<span class="c1">// COMPATIBLE - same source</span>
<span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="n">elapsed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="o">;</span><span class="w">  </span><span class="c1">// OK</span>

<span class="c1">// COMPATIBLE - same custom timebase</span>
<span class="n">timeBase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>
<span class="n">m1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="n">timeBase</span><span class="o">,</span><span class="w"> </span><span class="n">value1</span><span class="p">)</span><span class="o">;</span>
<span class="n">m2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="n">timeBase</span><span class="o">,</span><span class="w"> </span><span class="n">value2</span><span class="p">)</span><span class="o">;</span>
<span class="n">diff</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">m1</span><span class="o">;</span><span class="w">  </span><span class="c1">// OK</span>

<span class="c1">// INCOMPATIBLE - different sources</span>
<span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="k">if</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">then</span><span class="w">  </span><span class="c1">// EXCEPTION: EInvalidOpException</span>
<span class="sb">```</span>

<span class="gu">## Usage Examples</span>

<span class="gu">### Basic Timing with Fluent API</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">DoWork</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Fluent API - subtraction returns duration, call methods on it</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Elapsed: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ms</span><span class="o">,</span><span class="w"> </span><span class="s">&#39; ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Or use the convenient Elapsed method (recommended!)</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Elapsed: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ms</span><span class="o">,</span><span class="w"> </span><span class="s">&#39; ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Or access raw nanoseconds</span>
<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Elapsed: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">Elapsed</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">,</span><span class="w"> </span><span class="s">&#39; ns&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Using Now for Best Available Timer</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start</span><span class="o">,</span><span class="w"> </span><span class="n">finish</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span><span class="w">  </span><span class="c1">// High precision</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">finish</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Sleep took: &#39;</span><span class="o">,</span><span class="w"> </span><span class="p">(</span><span class="n">finish</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39; ms&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Duration Arithmetic</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">timestamp</span><span class="o">,</span><span class="w"> </span><span class="n">future</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">duration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Create durations using factory methods (much cleaner!)</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">future</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">duration</span><span class="o">;</span><span class="w">  </span><span class="c1">// Works with any timestamp source</span>

<span class="w">  </span><span class="c1">// Verify</span>
<span class="w">  </span><span class="nb">Assert</span><span class="p">((</span><span class="n">future</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">IsDuration</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="p">((</span><span class="n">future</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Combine durations</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Minutes</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 5.5 minutes</span>
<span class="w">  </span><span class="n">future</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">duration</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Use fractional seconds</span>
<span class="w">  </span><span class="n">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 2500 milliseconds</span>
<span class="w">  </span><span class="nb">Assert</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2500</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Custom Timebase for Session Measurements</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">sessionStart</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">measurement1</span><span class="o">,</span><span class="w"> </span><span class="n">measurement2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Create a custom timebase representing session start</span>
<span class="w">  </span><span class="n">sessionStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// First measurement</span>
<span class="w">  </span><span class="n">measurement1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="n">sessionStart</span><span class="o">,</span>
<span class="w">                    </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">.</span><span class="n">Value_ns</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">DoSomething</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Second measurement</span>
<span class="w">  </span><span class="n">measurement2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromCustom</span><span class="p">(</span><span class="n">sessionStart</span><span class="o">,</span>
<span class="w">                    </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">.</span><span class="n">Value_ns</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Compatible because they share the same custom timebase</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">measurement2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">measurement1</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### DateTime Conversion</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">dt</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts1</span><span class="o">,</span><span class="w"> </span><span class="n">ts2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">diff</span><span class="o">:</span><span class="w"> </span><span class="kt">TDateTime</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Convert from TDateTime</span>
<span class="w">  </span><span class="n">dt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Now</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDateTime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Another DateTime timestamp</span>
<span class="w">  </span><span class="n">ts2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDateTime</span><span class="p">(</span><span class="nb">Now</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Compatible - both use CDelphiDateTimeEpoch</span>
<span class="w">  </span><span class="n">diff</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">ts2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts1</span><span class="p">)</span><span class="o">.</span><span class="n">ToDateTime</span><span class="o">;</span>
<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Elapsed days: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">diff</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Round-trip conversion</span>
<span class="w">  </span><span class="n">dt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ts1</span><span class="o">.</span><span class="n">ToDateTime</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Unix Time Conversion</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">unixTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="w">  </span><span class="n">ts</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Current Unix timestamp</span>
<span class="w">  </span><span class="n">unixTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">DateTimeToUnix</span><span class="p">(</span><span class="nb">Now</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Convert to TGpTimestamp</span>
<span class="w">  </span><span class="n">ts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromUnixTime</span><span class="p">(</span><span class="n">unixTime</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// All Unix time timestamps are compatible</span>
<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;TimeSource: &#39;</span><span class="o">,</span><span class="w"> </span><span class="nb">Ord</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">TimeSource</span><span class="p">))</span><span class="o">;</span><span class="w">  </span><span class="c1">// tsCustom</span>
<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;TimeBase: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">ts</span><span class="o">.</span><span class="n">TimeBase</span><span class="p">)</span><span class="o">;</span><span class="w">            </span><span class="c1">// CUnixTimeEpoch</span>

<span class="w">  </span><span class="c1">// Unix epoch (Jan 1, 1970)</span>
<span class="w">  </span><span class="n">ts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromUnixTime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Unix epoch: &#39;</span><span class="o">,</span><span class="w"> </span><span class="n">ts</span><span class="o">.</span><span class="n">Value_ns</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 0</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### DVB Timestamp Handling</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">pcr_timestamp</span><span class="o">,</span><span class="w"> </span><span class="n">pts_timestamp</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">converted_pcr</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Convert from DVB PCR (27 MHz clock) to nanoseconds</span>
<span class="w">  </span><span class="n">pcr_timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PCR</span><span class="p">(</span><span class="mi">27000000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 second</span>

<span class="w">  </span><span class="c1">// Convert from DVB PTS (90 kHz clock) to nanoseconds</span>
<span class="w">  </span><span class="n">pts_timestamp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromDVB_PTS</span><span class="p">(</span><span class="mi">90000</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// 1 second</span>

<span class="w">  </span><span class="c1">// Both use tsDVB source, so they&#39;re compatible</span>
<span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Difference: &#39;</span><span class="o">,</span><span class="w"> </span><span class="p">(</span><span class="n">pcr_timestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pts_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">,</span><span class="w"> </span><span class="s">&#39; ms&#39;</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Convert back to PCR</span>
<span class="w">  </span><span class="n">converted_pcr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pcr_timestamp</span><span class="o">.</span><span class="n">ToPCR</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="p">(</span><span class="n">converted_pcr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">27000000</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Timeout Checking</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">timeout</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Option 1: Using milliseconds (Int64)</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w">  </span><span class="c1">// 5 second timeout</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="n">ProcessMessages</span><span class="o">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">WorkCompleted</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="k">Break</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Option 2: Using TGpTimestamp duration (more readable!)</span>
<span class="w">  </span><span class="n">timeout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="n">ProcessMessages</span><span class="o">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">WorkCompleted</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="k">Break</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Self-documenting inline usage (with alias for brevity)</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">_TS_</span><span class="o">.</span><span class="n">Milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">DoSomething</span><span class="o">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">start</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Timeout!&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">&#39;Completed in time&#39;</span><span class="p">)</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Comparing and Finding Min/Max</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="n">earliest</span><span class="o">,</span><span class="w"> </span><span class="n">latest</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Comparisons</span>
<span class="w">  </span><span class="nb">Assert</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Find earliest and latest</span>
<span class="w">  </span><span class="n">earliest</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="o">;</span><span class="w">  </span><span class="c1">// Returns t1</span>
<span class="w">  </span><span class="n">latest</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="o">;</span><span class="w">    </span><span class="c1">// Returns t2</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">## Design Concepts</span>

<span class="gu">### Type-Safe Time Measurement</span>

<span class="gs">**Problem:**</span> Traditional time measurement in Delphi has three critical issues:
<span class="k">1.</span> Ambiguous units - Hard to tell if Int64 stores milliseconds, microseconds, or nanoseconds
<span class="k">2.</span> Unsafe mixing - Easy to accidentally subtract QueryPerformanceCounter from GetTickCount values
<span class="k">3.</span> No compile-time safety - Relies only on variable naming conventions (<span class="ge">_ms, _</span>us suffixes)

<span class="gs">**Solution:**</span> TGpTimestamp stores both the time source and value, with automatic compatibility checking through operator overloading.

<span class="gu">### Nanosecond Internal Storage</span>

All values are stored as Int64 nanoseconds, providing:
<span class="k">-</span><span class="w"> </span><span class="gs">**292 years of range**</span> at nanosecond precision
<span class="k">-</span><span class="w"> </span><span class="gs">**Future-proof precision**</span> - Can represent sub-nanosecond values if needed
<span class="k">-</span><span class="w"> </span><span class="gs">**Consistent internal representation**</span> - Simplifies arithmetic and conversions

<span class="gu">### Fail-Fast Approach</span>

Mixing incompatible timebases raises <span class="sb">`EInvalidOpException`</span> immediately rather than producing silently incorrect results. This catches bugs early during development.

<span class="gu">### Duration vs Timestamp Semantics</span>

<span class="k">-</span><span class="w"> </span><span class="gs">**Timestamps**</span> have a specific time source and timebase
<span class="k">-</span><span class="w"> </span><span class="gs">**Durations**</span> (tsDuration) represent time differences and are universally compatible
<span class="k">-</span><span class="w"> </span><span class="gs">**Arithmetic rules**</span> enforce correct semantics:
<span class="w">  </span><span class="k">-</span><span class="w"> </span>timestamp - timestamp = duration ‚úì
<span class="w">  </span><span class="k">-</span><span class="w"> </span>timestamp + duration = timestamp ‚úì
<span class="w">  </span><span class="k">-</span><span class="w"> </span>timestamp + timestamp = ERROR ‚úó

<span class="gu">## Testing</span>

The unit includes comprehensive unit tests in <span class="sb">`GpTimestamp.UnitTests.pas`</span> with 22 test methods covering:

<span class="k">-</span><span class="w"> </span>Basic timing with various sources
<span class="k">-</span><span class="w"> </span>Unit conversions (ns, Œºs, ms, seconds)
<span class="k">-</span><span class="w"> </span>Comparisons and ordering
<span class="k">-</span><span class="w"> </span>Custom timebase functionality
<span class="k">-</span><span class="w"> </span>Incompatible source detection
<span class="k">-</span><span class="w"> </span>DVB PCR/PTS conversions
<span class="k">-</span><span class="w"> </span>Stopwatch integration
<span class="k">-</span><span class="w"> </span>TimeGetTime (Windows only)
<span class="k">-</span><span class="w"> </span>DateTime and Unix time conversions
<span class="k">-</span><span class="w"> </span>All arithmetic operators
<span class="k">-</span><span class="w"> </span>String conversions
<span class="k">-</span><span class="w"> </span>Utility functions (Min, Max, Zero, Invalid)
<span class="k">-</span><span class="w"> </span>Negative duration handling
<span class="k">-</span><span class="w"> </span>Duration factory methods
<span class="k">-</span><span class="w"> </span>Elapsed method
<span class="k">-</span><span class="w"> </span>FromXXX value overloads

Run tests with:
<span class="sb">```</span>
<span class="sb">dcc32 -B -U.. GpTimestampTests.dpr</span>
<span class="sb">GpTimestampTests.exe</span>
<span class="sb">```</span>

<span class="gu">## Internal Structure</span>

<span class="gu">### Record Layout</span>

<span class="sb">```pascal</span>
<span class="n">TGpTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">record</span>
<span class="w">  </span><span class="n">strict</span><span class="w"> </span><span class="kp">private</span>
<span class="w">    </span><span class="n">FTimeSource</span><span class="o">:</span><span class="w"> </span><span class="n">TTimeSource</span><span class="o">;</span><span class="w">  </span><span class="c1">// 4 bytes (Int32 enum)</span>
<span class="w">    </span><span class="n">FTimeBase</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w">          </span><span class="c1">// 8 bytes</span>
<span class="w">    </span><span class="n">FValue</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span><span class="w">             </span><span class="c1">// 8 bytes</span>
<span class="w">  </span><span class="c1">// Total: 20 bytes (may be padded to 24 bytes depending on alignment)</span>
<span class="sb">```</span>

<span class="gu">### Conversion Constants</span>

Internal constants used for all conversions (defined in implementation section):

<span class="sb">```pascal</span>
<span class="k">const</span>
<span class="w">  </span><span class="n">CNanosecondsPerMicrosecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="o">;</span>
<span class="w">  </span><span class="n">CNanosecondsPerMillisecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="o">;</span>
<span class="w">  </span><span class="n">CNanosecondsPerSecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000000</span><span class="o">;</span>
<span class="w">  </span><span class="n">CNanosecondsPerDay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Int64</span><span class="p">(</span><span class="mi">86400000000000</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">CDVB_PCR_Frequency_MHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">27</span><span class="o">;</span><span class="w">   </span><span class="c1">// DVB PCR: 27 MHz clock</span>
<span class="w">  </span><span class="n">CDVB_PTS_Frequency_kHz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="o">;</span><span class="w">   </span><span class="c1">// DVB PTS: 90 kHz clock</span>
<span class="sb">```</span>

<span class="gu">## Best Practices</span>

<span class="gu">### When to Use Which Time Source</span>

| Use Case | Recommended Source | Reason |
|----------|-------------------|--------|
| High-precision profiling (cross-platform) | <span class="sb">`FromStopwatch`</span> | Microsecond+ resolution, guaranteed cross-platform |
| High-precision profiling (Windows) | <span class="sb">`FromQueryPerformanceCounter`</span> | Microsecond+ resolution, <span class="gs">**Windows only**</span> |
| Simple timeout tracking (Windows) | <span class="sb">`FromTickCount`</span> | Millisecond resolution, <span class="gs">**Windows only**</span> |
| Simple timeout tracking (cross-platform) | <span class="sb">`FromStopwatch`</span> | Works everywhere |
| Windows multimedia | <span class="sb">`FromTimeGetTime`</span> | Consistent with multimedia timers, <span class="gs">**Windows only**</span> |
| DVB/MPEG timestamps | <span class="sb">`FromDVB_PCR`</span> / <span class="sb">`FromDVB_PTS`</span> | Native DVB support |
| Session-relative times | <span class="sb">`FromCustom`</span> | Share custom timebase |
| External timestamps | <span class="sb">`FromDateTime`</span> / <span class="sb">`FromUnixTime`</span> | Maintain compatibility |

<span class="gu">### Prefer TGpTimestamp Over Raw Int64</span>

<span class="gs">**Instead of:**</span>
<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start_ms</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">start_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">GetTickCount64</span><span class="o">;</span>
<span class="w">  </span><span class="n">DoWork</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">GetTickCount64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_ms</span><span class="o">;</span><span class="w">  </span><span class="c1">// Easy to mix with QPC values!</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gs">**Use:**</span>
<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">start</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="o">;</span>
<span class="w">  </span><span class="n">DoWork</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromTickCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Use Descriptive Variable Names</span>

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">requestStart</span><span class="o">,</span><span class="w"> </span><span class="n">requestEnd</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">processingDuration</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">timeout_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">requestStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">ProcessRequest</span><span class="o">;</span>
<span class="w">  </span><span class="n">requestEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>

<span class="w">  </span><span class="n">processingDuration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">requestEnd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">requestStart</span><span class="o">;</span>
<span class="w">  </span><span class="nb">Assert</span><span class="p">(</span><span class="n">processingDuration</span><span class="o">.</span><span class="n">IsDuration</span><span class="p">)</span><span class="o">;</span>

<span class="w">  </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">processingDuration</span><span class="o">.</span><span class="n">ToMilliseconds</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">## Breaking Changes from Traditional Approaches</span>

<span class="gu">### Subtract Operator Returns TGpTimestamp</span>

<span class="gs">**Old approach (raw Int64):**</span>
<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">,</span><span class="w"> </span><span class="n">elapsed_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">GetQPCValue</span><span class="o">;</span>
<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">GetQPCValue</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="o">;</span><span class="w">  </span><span class="c1">// Direct Int64 result</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gs">**New approach (TGpTimestamp):**</span>
<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">t1</span><span class="o">,</span><span class="w"> </span><span class="n">t2</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="o">:</span><span class="w"> </span><span class="kt">Int64</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="n">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">t2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromQueryPerformanceCounter</span><span class="o">;</span>
<span class="w">  </span><span class="n">elapsed_ns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">Value_ns</span><span class="o">;</span><span class="w">  </span><span class="c1">// or .ToNanoseconds</span>
<span class="w">  </span><span class="c1">// Can also use: .ToMilliseconds, .ToMicroseconds, .ToSeconds</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">## License</span>

This software is distributed under the BSD license.

Copyright (c) 2025, Primoz Gabrijelcic
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
<span class="k">-</span><span class="w"> </span>Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
<span class="k">-</span><span class="w"> </span>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
<span class="k">-</span><span class="w"> </span>The name of the Primoz Gabrijelcic may not be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</code></pre></div></td></tr></table></div>
</div>
                </details>
                <div class='system-reminder'>ü§ñ <em>Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.</em></div></div></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:59.382Z'>2025-11-27 09:27:59</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">Yes, the GpTimestamp.md file should definitely be updated. I need to:
1. Update the version number from 0.1 to 0.2
2. Add documentation about the HasElapsed behavior with tsNone timestamps
3. Add an e...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>Yes, the GpTimestamp.md file should definitely be updated. I need to:</p>
<ol>
<li>Update the version number from 0.1 to 0.2</li>
<li>Add documentation about the HasElapsed behavior with tsNone timestamps</li>
<li>Add an example showing the initialization pattern</li>
</ol>
<p>Let me look at where to add this information. The best places would be:</p>
<ol>
<li>Update version at the top</li>
<li>Update the HasElapsed section (around lines 323-648)</li>
<li>Add a new example showing the initialization pattern</li>
</ol>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:27:59.675Z'>2025-11-27 09:27:59</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Yes, absolutely! Let me update the documentation:</p>
</div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01L615odH7Zzv6c7ZJs2rdBQ">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.md</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:28:01.459Z'>2025-11-27 09:28:01</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-removed'><span class='diff-marker'>-</span>**Version:** 0.<mark class='diff-char-removed'>1</mark> (2025-11-<mark class='diff-char-removed'>16</mark>)</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>**Version:** 0.<mark class='diff-char-added'>2</mark> (2025-11-<mark class='diff-char-added'>27</mark>)</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01L615odH7Zzv6c7ZJs2rdBQ"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:29:41.239Z' data-duration='took 1m 39s'>2025-11-27 09:29:41</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gh"># GpTimestamp - Type-Safe Timestamp with Multiple Time Sources</span>

<span class="gs">**Version:**</span> 0.2 (2025-11-27)
<span class="gs">**Author:**</span> Primoz Gabrijelcic (navigator), Claude Code (driver)
<span class="gs">**License:**</span> BSD
<span class="gs">**Unit File:**</span> GpTimestamp.pas
</code></pre></div></td></tr></table></div>
</div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:29:47.090Z'>2025-11-27 09:29:47</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Now I need to update the HasElapsed documentation section to mention the new behavior with tsNone timestamps.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01RYyJ7kxeWHKMfhKc8o1ayR">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.md</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:29:53.902Z'>2025-11-27 09:29:53</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>```pascal</div><div class='diff-line diff-context'><span class='diff-marker'> </span>function HasElapsed(timeout_ms: Int64): Boolean; overload;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>function HasElapsed(const duration: TGpTimestamp): Boolean; overload;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>```</div><div class='diff-line diff-context'><span class='diff-marker'> </span>Checks if the specified timeout has elapsed since this timestamp. Automatically uses the same time source for the comparison.</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>The first overload accepts timeout in milliseconds as an Int64.</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>The second overload accepts a TGpTimestamp duration (TimeSource must be tsDuration), enabling more readable, self-documenting code using the duration factory methods.</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>**Special behavior:** Returns `True` when the timestamp is invalid (TimeSource = tsNone), allowing simple initialization patterns without explicit `IsValid` checks. This is useful for lazy initialization of timers.</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>**Supported for:**</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Cross-platform: tsStopwatch</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Windows only: tsTickCount, tsQueryPerformanceCounter, tsTimeGetTime</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01RYyJ7kxeWHKMfhKc8o1ayR"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:30:00.534Z' data-duration='took 6.6s'>2025-11-27 09:30:00</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>23 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code>function IsDuration: Boolean;
```
Returns true if the timestamp represents a duration (tsDuration source).

```pascal
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code>function IsDuration: Boolean;
<span class="sb">```</span>
<span class="sb">Returns true if the timestamp represents a duration (tsDuration source).</span>

<span class="sb">```pascal</span>
<span class="sb">function HasElapsed(timeout_ms: Int64): Boolean; overload;</span>
<span class="sb">function HasElapsed(const duration: TGpTimestamp): Boolean; overload;</span>
<span class="sb">```</span>
Checks if the specified timeout has elapsed since this timestamp. Automatically uses the same time source for the comparison.

The first overload accepts timeout in milliseconds as an Int64.

The second overload accepts a TGpTimestamp duration (TimeSource must be tsDuration), enabling more readable, self-documenting code using the duration factory methods.

<span class="gs">**Special behavior:**</span> Returns <span class="sb">`True`</span> when the timestamp is invalid (TimeSource = tsNone), allowing simple initialization patterns without explicit <span class="sb">`IsValid`</span> checks. This is useful for lazy initialization of timers.

<span class="gs">**Supported for:**</span>
<span class="k">-</span><span class="w"> </span>Cross-platform: tsStopwatch
<span class="k">-</span><span class="w"> </span>Windows only: tsTickCount, tsQueryPerformanceCounter, tsTimeGetTime

<span class="sb">```pascal</span>
<span class="k">function</span><span class="w"> </span><span class="nf">Elapsed</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span>
<span class="sb">```</span>
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:30:04.909Z'>2025-11-27 09:30:04</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Now I should add an example showing the initialization pattern. Let me find the timeout checking examples section and add a new example there.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01VknKbPKjjQLnWDdMEPtY2k">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.md</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:30:19.162Z'>2025-11-27 09:30:19</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>### Timeout Checking</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>```pascal</div><div class='diff-line diff-context'><span class='diff-marker'> </span>var</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  start: TGpTimestamp;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  timeout: TGpTimestamp;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>begin</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  start := TGpTimestamp.FromQueryPerformanceCounter;</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  // Option 1: Using milliseconds (Int64)</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  while not start.HasElapsed(5000) do  // 5 second timeout</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  begin</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    ProcessMessages;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    if WorkCompleted then</div><div class='diff-line diff-context'><span class='diff-marker'> </span>      Break;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  end;</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  // Option 2: Using TGpTimestamp duration (more readable!)</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  timeout := TGpTimestamp.Seconds(5);</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  while not start.HasElapsed(timeout) do</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  begin</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    ProcessMessages;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    if WorkCompleted then</div><div class='diff-line diff-context'><span class='diff-marker'> </span>      Break;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  end;</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  // Self-documenting inline usage (with alias for brevity)</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  while not start.HasElapsed(_TS_.Milliseconds(500)) do</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    DoSomething;</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-context'><span class='diff-marker'> </span>  if start.HasElapsed(TGpTimestamp.Seconds(5)) then</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    WriteLn(&#x27;Timeout!&#x27;)</div><div class='diff-line diff-context'><span class='diff-marker'> </span>  else</div><div class='diff-line diff-context'><span class='diff-marker'> </span>    WriteLn(&#x27;Completed in time&#x27;);</div><div class='diff-line diff-context'><span class='diff-marker'> </span>end;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>```</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>### Simple Initialization Pattern with HasElapsed</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>The `HasElapsed` method returns `True` for invalid timestamps (TimeSource = tsNone), enabling clean initialization patterns:</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>```pascal</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>var</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  lastUpdate: TGpTimestamp;  // Defaults to tsNone (invalid)</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>begin</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // Simple pattern - no need to check IsValid explicitly</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  if lastUpdate.HasElapsed(_TS_.Seconds(5)) then</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  begin</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    PerformUpdate;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    lastUpdate := TGpTimestamp.FromStopwatch;  // Initialize or reset</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  end;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // Old pattern (no longer necessary):</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // if (not lastUpdate.IsValid) or lastUpdate.HasElapsed(_TS_.Seconds(5)) then</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // begin</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  //   PerformUpdate;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  //   lastUpdate := TGpTimestamp.FromStopwatch;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // end;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>end;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>```</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>This is particularly useful for class fields that need periodic updates:</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>```pascal</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>type</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  TMyClass = class</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  private</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    FLastCheck: TGpTimestamp;  // Automatically invalid (tsNone) on creation</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  public</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    procedure Update;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  end;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span></div><div class='diff-line diff-added'><span class='diff-marker'>+</span>procedure TMyClass.Update;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>begin</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // First call: FLastCheck is invalid, HasElapsed returns True immediately</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  // Subsequent calls: Checks if 1 second has actually elapsed</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  if FLastCheck.HasElapsed(1000) then</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  begin</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    DoPeriodicWork;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>    FLastCheck := TGpTimestamp.FromStopwatch;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>  end;</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>end;</div><div class='diff-line diff-context'><span class='diff-marker'> </span>```</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01VknKbPKjjQLnWDdMEPtY2k"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:30:51.287Z' data-duration='took 32.1s'>2025-11-27 09:30:51</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>91 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span></pre></div></td><td class="code"><div><pre><span></span><code>  Assert(converted_pcr = 27000000);
end;
```

<span class="gu">### Timeout Checking</span>
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span></pre></div></td><td class="code"><div><pre><span></span><code>  Assert(converted_pcr = 27000000);
end;
<span class="sb">```</span>

<span class="sb">### Timeout Checking</span>

<span class="sb">```pascal</span>
<span class="sb">var</span>
<span class="sb">  start: TGpTimestamp;</span>
<span class="sb">  timeout: TGpTimestamp;</span>
<span class="sb">begin</span>
<span class="sb">  start := TGpTimestamp.FromQueryPerformanceCounter;</span>

<span class="sb">  // Option 1: Using milliseconds (Int64)</span>
<span class="sb">  while not start.HasElapsed(5000) do  // 5 second timeout</span>
<span class="sb">  begin</span>
<span class="sb">    ProcessMessages;</span>
<span class="sb">    if WorkCompleted then</span>
<span class="sb">      Break;</span>
<span class="sb">  end;</span>

<span class="sb">  // Option 2: Using TGpTimestamp duration (more readable!)</span>
<span class="sb">  timeout := TGpTimestamp.Seconds(5);</span>
<span class="sb">  while not start.HasElapsed(timeout) do</span>
<span class="sb">  begin</span>
<span class="sb">    ProcessMessages;</span>
<span class="sb">    if WorkCompleted then</span>
<span class="sb">      Break;</span>
<span class="sb">  end;</span>

<span class="sb">  // Self-documenting inline usage (with alias for brevity)</span>
<span class="sb">  while not start.HasElapsed(_TS_.Milliseconds(500)) do</span>
<span class="sb">    DoSomething;</span>

<span class="sb">  if start.HasElapsed(TGpTimestamp.Seconds(5)) then</span>
<span class="sb">    WriteLn(&#39;Timeout!&#39;)</span>
<span class="sb">  else</span>
<span class="sb">    WriteLn(&#39;Completed in time&#39;);</span>
<span class="sb">end;</span>
<span class="sb">```</span>

<span class="gu">### Simple Initialization Pattern with HasElapsed</span>

The <span class="sb">`HasElapsed`</span> method returns <span class="sb">`True`</span> for invalid timestamps (TimeSource = tsNone), enabling clean initialization patterns:

<span class="sb">```pascal</span>
<span class="k">var</span>
<span class="w">  </span><span class="n">lastUpdate</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w">  </span><span class="c1">// Defaults to tsNone (invalid)</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// Simple pattern - no need to check IsValid explicitly</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">lastUpdate</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="n">_TS_</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="n">PerformUpdate</span><span class="o">;</span>
<span class="w">    </span><span class="n">lastUpdate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromStopwatch</span><span class="o">;</span><span class="w">  </span><span class="c1">// Initialize or reset</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="w">  </span><span class="c1">// Old pattern (no longer necessary):</span>
<span class="w">  </span><span class="c1">// if (not lastUpdate.IsValid) or lastUpdate.HasElapsed(_TS_.Seconds(5)) then</span>
<span class="w">  </span><span class="c1">// begin</span>
<span class="w">  </span><span class="c1">//   PerformUpdate;</span>
<span class="w">  </span><span class="c1">//   lastUpdate := TGpTimestamp.FromStopwatch;</span>
<span class="w">  </span><span class="c1">// end;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

This is particularly useful for class fields that need periodic updates:

<span class="sb">```pascal</span>
<span class="k">type</span>
<span class="w">  </span><span class="n">TMyClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">class</span>
<span class="w">  </span><span class="kp">private</span>
<span class="w">    </span><span class="n">FLastCheck</span><span class="o">:</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">;</span><span class="w">  </span><span class="c1">// Automatically invalid (tsNone) on creation</span>
<span class="w">  </span><span class="kp">public</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">Update</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>

<span class="k">procedure</span><span class="w"> </span><span class="nc">TMyClass</span><span class="o">.</span><span class="nf">Update</span><span class="o">;</span>
<span class="k">begin</span>
<span class="w">  </span><span class="c1">// First call: FLastCheck is invalid, HasElapsed returns True immediately</span>
<span class="w">  </span><span class="c1">// Subsequent calls: Checks if 1 second has actually elapsed</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">FLastCheck</span><span class="o">.</span><span class="n">HasElapsed</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="n">DoPeriodicWork</span><span class="o">;</span>
<span class="w">    </span><span class="n">FLastCheck</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TGpTimestamp</span><span class="o">.</span><span class="n">FromStopwatch</span><span class="o">;</span>
<span class="w">  </span><span class="k">end</span><span class="o">;</span>
<span class="k">end</span><span class="o">;</span>
<span class="sb">```</span>

<span class="gu">### Comparing and Finding Min/Max</span>

```pascal
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:30:57.026Z'>2025-11-27 09:30:57</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Good! Now I should update the test count in the Testing section to reflect that there are now 23 tests instead of 22.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_014erS9u8fyqPZdk89SrEaCb">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.md</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:30:58.777Z'>2025-11-27 09:30:58</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>## Testing</div><div class='diff-line diff-context'><span class='diff-marker'> </span></div><div class='diff-line diff-removed'><span class='diff-marker'>-</span>The unit includes comprehensive unit tests in `GpTimestamp.UnitTests.pas` with 2<mark class='diff-char-removed'>2</mark> test methods covering:</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>The unit includes comprehensive unit tests in `GpTimestamp.UnitTests.pas` with 2<mark class='diff-char-added'>3</mark> test methods covering:</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_014erS9u8fyqPZdk89SrEaCb"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:03.980Z' data-duration='took 5.2s'>2025-11-27 09:31:03</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="k">-</span><span class="w"> </span>timestamp - timestamp = duration ‚úì
<span class="w">  </span><span class="k">-</span><span class="w"> </span>timestamp + duration = timestamp ‚úì
<span class="w">  </span><span class="k">-</span><span class="w"> </span>timestamp + timestamp = ERROR ‚úó

<span class="gu">## Testing</span>

The unit includes comprehensive unit tests in <span class="sb">`GpTimestamp.UnitTests.pas`</span> with 23 test methods covering:

<span class="k">-</span><span class="w"> </span>Basic timing with various sources
<span class="k">-</span><span class="w"> </span>Unit conversions (ns, Œºs, ms, seconds)
<span class="k">-</span><span class="w"> </span>Comparisons and ordering
</code></pre></div></td></tr></table></div>
</div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:08.276Z'>2025-11-27 09:31:08</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>I should also add the new feature to the list of what tests cover. Let me update that section.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01P5JBYgsfwj778iPHSX3SJM">üìù Edit <span class='tool-summary'>H:\RAZVOJ\GpDelphiUnits\src\GpTimestamp.md</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:13.087Z'>2025-11-27 09:31:13</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>- Basic timing with various sources</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Unit conversions (ns, Œºs, ms, seconds)</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Comparisons and ordering</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Custom timebase functionality</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Incompatible source detection</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- DVB PCR/PTS conversions</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Stopwatch integration</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- TimeGetTime (Windows only)</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- DateTime and Unix time conversions</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- All arithmetic operators</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- String conversions</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Utility functions (Min, Max, Zero, Invalid)</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Negative duration handling</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Duration factory methods</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- Elapsed method</div><div class='diff-line diff-removed'><span class='diff-marker'>-</span>- FromXXX value overloads</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>- FromXXX value overloads</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>- HasElapsed with invalid timestamps (initialization patterns)</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01P5JBYgsfwj778iPHSX3SJM"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:21.080Z' data-duration='took 8.0s'>2025-11-27 09:31:21</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'>
                <details class='collapsible-code'>
                    <summary>
                        <span class='line-count'>25 lines</span>
                        <div class='preview-content'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gu">## Testing</span>

The unit includes comprehensive unit tests in <span class="sb">`GpTimestamp.UnitTests.pas`</span> with 23 test methods covering:

<span class="k">-</span><span class="w"> </span>Basic timing with various sources
</code></pre></div></td></tr></table></div>
</div>
                    </summary>
                    <div class='code-full'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gu">## Testing</span>

The unit includes comprehensive unit tests in <span class="sb">`GpTimestamp.UnitTests.pas`</span> with 23 test methods covering:

<span class="k">-</span><span class="w"> </span>Basic timing with various sources
<span class="k">-</span><span class="w"> </span>Unit conversions (ns, Œºs, ms, seconds)
<span class="k">-</span><span class="w"> </span>Comparisons and ordering
<span class="k">-</span><span class="w"> </span>Custom timebase functionality
<span class="k">-</span><span class="w"> </span>Incompatible source detection
<span class="k">-</span><span class="w"> </span>DVB PCR/PTS conversions
<span class="k">-</span><span class="w"> </span>Stopwatch integration
<span class="k">-</span><span class="w"> </span>TimeGetTime (Windows only)
<span class="k">-</span><span class="w"> </span>DateTime and Unix time conversions
<span class="k">-</span><span class="w"> </span>All arithmetic operators
<span class="k">-</span><span class="w"> </span>String conversions
<span class="k">-</span><span class="w"> </span>Utility functions (Min, Max, Zero, Invalid)
<span class="k">-</span><span class="w"> </span>Negative duration handling
<span class="k">-</span><span class="w"> </span>Duration factory methods
<span class="k">-</span><span class="w"> </span>Elapsed method
<span class="k">-</span><span class="w"> </span>FromXXX value overloads
<span class="k">-</span><span class="w"> </span>HasElapsed with invalid timestamps (initialization patterns)

Run tests with:
```
dcc32 -B -U.. GpTimestampTests.dpr
</code></pre></div></td></tr></table></div>
</div>
                </details>
                </div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:25.879Z'>2025-11-27 09:31:25</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Perfect! Now I should clean up the todo list since all tasks are complete.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01S84Tvxb3Zr5NpvKNUTymkD">üìù Todo List</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:26.131Z'>2025-11-27 09:31:26</span>
                </div>
                
            </div>
        </div>
        <div class='content'>
        <div class="todo-content">
            <p><em>No todos found</em></p>
        </div>
        </div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01S84Tvxb3Zr5NpvKNUTymkD"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:26.233Z' data-duration='took 102 ms'>2025-11-27 09:31:26</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable</pre></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:30.090Z'>2025-11-27 09:31:30</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><div class="thinking-text"><p>Perfect! Let me verify what files were updated with a quick summary for the user.</p>
</div></div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:31:34.761Z'>2025-11-27 09:31:34</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Perfect! I've updated <code>GpTimestamp.md</code> with the following changes:</p>
<h2>Documentation Updates</h2>
<ol>
<li><p><strong>Version bumped to 0.2</strong> (2025-11-27)</p>
</li>
<li><p><strong>Updated HasElapsed documentation</strong> (lines 333-337):</p>
<ul>
<li>Added note about special behavior with invalid timestamps</li>
<li>Explains that it returns <code>True</code> when <code>TimeSource = tsNone</code></li>
<li>Clarifies this enables simple initialization patterns</li>
</ul>
</li>
<li><p><strong>Added new section: &quot;Simple Initialization Pattern with HasElapsed&quot;</strong> (lines 652-697):</p>
<ul>
<li>Shows the clean new pattern: <code>if lastUpdate.HasElapsed(_TS_.Seconds(5)) then</code></li>
<li>Compares with the old verbose pattern (commented out)</li>
<li>Includes a practical class field example</li>
</ul>
</li>
<li><p><strong>Updated test coverage list</strong> (line 771):</p>
<ul>
<li>Changed test count from 22 to 23</li>
<li>Added &quot;HasElapsed with invalid timestamps (initialization patterns)&quot; to the list</li>
</ul>
</li>
</ol>
<p>The documentation now fully describes the new feature with clear examples showing how much cleaner the code becomes!</p>
</div>
    </div>
    
    
    
    
    <div class='message user'>
        <div class='header'>
            <span>ü§∑ User</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:32:32.645Z'>2025-11-27 09:32:32</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>Can you please update your memory so that in the future you will automatically check for corresponding .md file and update the documentation.</pre></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:32:41.135Z'>2025-11-27 09:32:41</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">The user is asking me to update my memory so that in future interactions, I will automatically check for corresponding .md files and update documentation when making changes to code files.

However, I...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>The user is asking me to update my memory so that in future interactions, I will automatically check for corresponding .md files and update documentation when making changes to code files.</p>
<p>However, I don't actually have a &quot;memory&quot; feature that persists across conversations. I'm Claude Code, and each conversation is independent. I don't have access to tools that would let me modify my own instructions or behavior for future sessions.</p>
<p>What I should do:</p>
<ol>
<li>Clarify that I don't have persistent memory across conversations</li>
<li>Suggest that they could add this as an instruction to their CLAUDE.md file (either the global one or the project-specific one)</li>
<li>Offer to help them write that instruction</li>
</ol>
<p>This is important because the user seems to think I have memory capabilities that I don't actually have. I should be honest and helpful about what's actually possible.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:32:46.363Z'>2025-11-27 09:32:46</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>I don't actually have persistent memory across conversations - each session with me starts fresh. However, I can help you add this to your <strong>CLAUDE.md</strong> file so that I'll automatically follow this practice in all future sessions!</p>
<p>Would you like me to add an instruction to your project's CLAUDE.md file? Here's what I suggest adding:</p>
<div class="highlight"><pre><span></span><code><span class="gu">## Documentation Updates</span>

<span class="k">-</span><span class="w"> </span>When modifying a source file (.pas, .dpr, etc.), always check for a corresponding .md documentation file in the same directory
<span class="k">-</span><span class="w"> </span>If a .md file exists with the same base name (e.g., GpTimestamp.pas ‚Üí GpTimestamp.md), update it to reflect:
<span class="w">  </span><span class="k">-</span><span class="w"> </span>Version number changes
<span class="w">  </span><span class="k">-</span><span class="w"> </span>New features or modified behavior
<span class="w">  </span><span class="k">-</span><span class="w"> </span>Updated API documentation
<span class="w">  </span><span class="k">-</span><span class="w"> </span>New usage examples where appropriate
<span class="w">  </span><span class="k">-</span><span class="w"> </span>Updated test counts and coverage descriptions
<span class="k">-</span><span class="w"> </span>Common documentation files to check: README.md, unit-specific .md files, CHANGELOG.md
</code></pre></div>
<p>Should I add this to <code>H:\RAZVOJ\GpDelphiUnits\CLAUDE.md</code> so I'll automatically follow this practice in future sessions with this codebase?</p>
</div>
    </div>
    
    
    
    
    <div class='message user'>
        <div class='header'>
            <span>ü§∑ User</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:33:35.037Z'>2025-11-27 09:33:35</span>
                </div>
                
            </div>
        </div>
        <div class='content'><pre>No, I want this in the global CLAUDE.md.</pre></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:33:40.705Z'>2025-11-27 09:33:40</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">The user wants me to add this instruction to their global CLAUDE.md file. From the system reminder earlier, I can see that the global CLAUDE.md is located at:

C:\Users\gabr\.claude\CLAUDE.md

Let me ...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>The user wants me to add this instruction to their global CLAUDE.md file. From the system reminder earlier, I can see that the global CLAUDE.md is located at:</p>
<p>C:\Users\gabr.claude\CLAUDE.md</p>
<p>Let me read it first and then add the documentation update instruction.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_013qnf4WUbmUxzAW6SWRKhBX">üìÑ Read <span class='tool-summary'>C:\Users\gabr\.claude\CLAUDE.md</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:33:41.075Z'>2025-11-27 09:33:41</span>
                </div>
                
            </div>
        </div>
        <div class='content'></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_013qnf4WUbmUxzAW6SWRKhBX"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:33:45.166Z' data-duration='took 4.1s'>2025-11-27 09:33:45</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='read-tool-result'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">*</span><span class="w"> </span>Use Delphi naming standards for newly added types.
<span class="k">*</span><span class="w"> </span>When API functions fail and the code raises exception, always include OS error code and error message in the exception text.
<span class="k">*</span><span class="w"> </span>Use inline variables when variables are used only for a short time inside if, while, repeat, and for statements.
<span class="k">*</span><span class="w"> </span>Don&#39;t capitalize &#39;assigned&#39; function call.
<span class="k">*</span><span class="w"> </span>Use \_ms suffix for variables that store time in millisecond units. Use \_us suffix for variables that store time in microsecond units.
<span class="k">*</span><span class="w"> </span>Before using GetLastError in Delphi code, first check if the codebase already implements its own GetLastError method (search for &#39;function GetLastError&#39;). If found, always qualify Windows API error checks with Winapi.Windows.GetLastError to avoid calling the wrong function.
<span class="k">-</span><span class="w"> </span>When reading existing code, check it for &#39;copy and paste&#39; errors.
</code></pre></div></td></tr></table></div>
<div class='system-reminder'>ü§ñ <em>Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.</em></div></div></div>
    </div>
    
    
    
    
    <div class='message thinking'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:33:51.643Z'>2025-11-27 09:33:51</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">I can see the global CLAUDE.md file. It&#x27;s a simple list of instructions. I should add the documentation update instruction in a consistent format with the existing items. The file uses both asterisk (...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>I can see the global CLAUDE.md file. It's a simple list of instructions. I should add the documentation update instruction in a consistent format with the existing items. The file uses both asterisk (*) and dash (-) for bullet points, so I'll use asterisk to be consistent with most of the items.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message tool_use paired-message pair_first'>
        <div class='header'>
            <span title="ID: toolu_01ScXwzFDESu6VkTWqQnBodH">üìù Edit <span class='tool-summary'>C:\Users\gabr\.claude\CLAUDE.md</span></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:33:58.777Z'>2025-11-27 09:33:58</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-content'><div class='edit-diff'><div class='diff-line diff-context'><span class='diff-marker'> </span>* Use Delphi naming standards for newly added types.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>* When API functions fail and the code raises exception, always include OS error code and error message in the exception text.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>* Use inline variables when variables are used only for a short time inside if, while, repeat, and for statements.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>* Don&#x27;t capitalize &#x27;assigned&#x27; function call.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>* Use \_ms suffix for variables that store time in millisecond units. Use \_us suffix for variables that store time in microsecond units.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>* Before using GetLastError in Delphi code, first check if the codebase already implements its own GetLastError method (search for &#x27;function GetLastError&#x27;). If found, always qualify Windows API error checks with Winapi.Windows.GetLastError to avoid calling the wrong function.</div><div class='diff-line diff-added'><span class='diff-marker'>+</span>* When modifying source files, always check for a corresponding .md documentation file in the same directory (e.g., GpTimestamp.pas ‚Üí GpTimestamp.md). If found, update it to reflect version changes, new features, modified behavior, API changes, new examples, and updated test coverage.</div><div class='diff-line diff-context'><span class='diff-marker'> </span>- When reading existing code, check it for &#x27;copy and paste&#x27; errors.</div></div></div></div>
    </div>
    
    
    
    
    <div class='message tool_result paired-message pair_last'>
        <div class='header'>
            <span title="ID: toolu_01ScXwzFDESu6VkTWqQnBodH"></span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:34:10.511Z' data-duration='took 11.7s'>2025-11-27 09:34:10</span>
                </div>
                
            </div>
        </div>
        <div class='content'><div class='edit-tool-result'><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">*</span><span class="w"> </span>Use Delphi naming standards for newly added types.
<span class="k">*</span><span class="w"> </span>When API functions fail and the code raises exception, always include OS error code and error message in the exception text.
<span class="k">*</span><span class="w"> </span>Use inline variables when variables are used only for a short time inside if, while, repeat, and for statements.
<span class="k">*</span><span class="w"> </span>Don&#39;t capitalize &#39;assigned&#39; function call.
<span class="k">*</span><span class="w"> </span>Use \_ms suffix for variables that store time in millisecond units. Use \_us suffix for variables that store time in microsecond units.
<span class="k">*</span><span class="w"> </span>Before using GetLastError in Delphi code, first check if the codebase already implements its own GetLastError method (search for &#39;function GetLastError&#39;). If found, always qualify Windows API error checks with Winapi.Windows.GetLastError to avoid calling the wrong function.
<span class="k">*</span><span class="w"> </span>When modifying source files, always check for a corresponding .md documentation file in the same directory (e.g., GpTimestamp.pas ‚Üí GpTimestamp.md). If found, update it to reflect version changes, new features, modified behavior, API changes, new examples, and updated test coverage.
<span class="k">-</span><span class="w"> </span>When reading existing code, check it for &#39;copy and paste&#39; errors.
</code></pre></div></td></tr></table></div>
</div></div>
    </div>
    
    
    
    
    <div class='message thinking paired-message pair_first'>
        <div class='header'>
            <span>üí≠ Thinking</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:34:15.192Z'>2025-11-27 09:34:15</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'>
    <details class="collapsible-details">
        <summary>
            <div class="preview-content"><div class="thinking-text">Perfect! I&#x27;ve added the instruction to the global CLAUDE.md file. Now in all future sessions, I will automatically check for corresponding .md documentation files when modifying source code and update...</div></div>
        </summary>
        <div class="details-content">
            <div class="thinking-text"><p>Perfect! I've added the instruction to the global CLAUDE.md file. Now in all future sessions, I will automatically check for corresponding .md documentation files when modifying source code and update them accordingly.</p>
</div>
        </div>
    </details>
    </div>
    </div>
    
    
    
    
    <div class='message assistant paired-message pair_last'>
        <div class='header'>
            <span>ü§ñ Assistant</span>
            <div class='header-info'>
                <div class='timestamp-row'>
                    <span class='timestamp' data-timestamp='2025-11-27T09:34:16.965Z'>2025-11-27 09:34:16</span>
                </div>
                
            </div>
        </div>
        <div class='content markdown'><p>Perfect! I've added the instruction to your global <code>CLAUDE.md</code> file at <code>C:\Users\gabr\.claude\CLAUDE.md</code>.</p>
<p>Now in all future sessions across any project, I will automatically check for corresponding .md documentation files when modifying source files and update them to reflect:</p>
<ul>
<li>Version changes</li>
<li>New features and modified behavior</li>
<li>API changes</li>
<li>New examples</li>
<li>Updated test coverage</li>
</ul>
<p>This will be applied consistently across all your Delphi projects (and any other projects where documentation files exist).</p>
</div>
    </div>
    
    

    <button class="timeline-toggle floating-btn" id="toggleTimeline" title="Show timeline">üìÜ</button>
    <button class="filter-messages floating-btn" id="filterMessages" title="Search & Filter">üîç</button>
    <button class="toggle-details floating-btn" id="toggleDetails" title="Toggle all details">üìã</button>
    <a class="scroll-top floating-btn" title="Scroll to top" href="#title">üîù</a>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.getElementById('toggleDetails');
            const timelineButton = document.getElementById('toggleTimeline');
            const filterButton = document.getElementById('filterMessages');
            const filterToolbar = document.querySelector('.filter-toolbar');
            const selectAllButton = document.getElementById('selectAll');
            const selectNoneButton = document.getElementById('selectNone');
            const closeToolbarButton = document.getElementById('closeToolbar');
            const filterToggles = document.querySelectorAll('.filter-toggle');

            // Timezone conversion (included as component)
            // Convert timestamps to user's timezone
// This function can be called directly or will auto-run on DOMContentLoaded if included standalone
(function() {
    function convertTimestampsToLocalTimezone() {
        const timestampElements = Array.from(document.querySelectorAll('.timestamp[data-timestamp]'));

        if (timestampElements.length === 0) return;

        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        const localFormatter = new Intl.DateTimeFormat(undefined, {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false,
            timeZone: userTimezone
        });

        const utcFormatter = new Intl.DateTimeFormat(undefined, {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false,
            timeZone: 'UTC'
        });

        const tzNameFormatter = new Intl.DateTimeFormat('en', {
            timeZoneName: 'short',
            timeZone: userTimezone
        });

        // Process timestamps in batches to keep page responsive
        const batchSize = 25;
        const scheduleWork = window.requestIdleCallback || function(cb) { setTimeout(cb, 16); };

        function processBatch(startIndex) {
            const endIndex = Math.min(startIndex + batchSize, timestampElements.length);

            for (let i = startIndex; i < endIndex; i++) {
                const element = timestampElements[i];
                const rawTimestamp = element.getAttribute('data-timestamp');
                const rawTimestampEnd = element.getAttribute('data-timestamp-end');
                const duration = element.getAttribute('data-duration');

                if (!rawTimestamp) continue;

                try {
                    // Parse the ISO timestamp
                    const date = new Date(rawTimestamp);
                    if (isNaN(date.getTime())) continue; // Invalid date

                    const localTime = localFormatter.format(date).replace(/, /g, ' ');
                    const utcTime = utcFormatter.format(date).replace(/, /g, ' ');

                    // Get timezone abbreviation (reuse formatter)
                    const timezoneName = tzNameFormatter.formatToParts(date).find(part => part.type === 'timeZoneName')?.value || userTimezone;

                    // Handle time ranges (earliest to latest)
                    if (rawTimestampEnd) {
                        const dateEnd = new Date(rawTimestampEnd);
                        if (!isNaN(dateEnd.getTime())) {
                            const localTimeEnd = localFormatter.format(dateEnd).replace(/, /g, ' ');
                            const utcTimeEnd = utcFormatter.format(dateEnd).replace(/, /g, ' ');

                            // Update the element with range
                            if (localTime !== utcTime || localTimeEnd !== utcTimeEnd) {
                                element.innerHTML = localTime + ' to ' + localTimeEnd + ' <span style="color: #888; font-size: 0.9em;">(' + timezoneName + ')</span>';
                                element.title = 'UTC: ' + utcTime + ' to ' + utcTimeEnd;
                            } else {
                                // If they're the same (user is in UTC), just show UTC
                                element.innerHTML = utcTime + ' to ' + utcTimeEnd + ' <span style="color: #888; font-size: 0.9em;">(UTC)</span>';
                                element.title = 'UTC: ' + utcTime + ' to ' + utcTimeEnd;
                            }
                        }
                    } else {
                        // Single timestamp
                        if (localTime !== utcTime) {
                            element.innerHTML = localTime + ' <span style="color: #888; font-size: 0.9em;">(' + timezoneName + ')</span>';
                            element.title = duration ? duration : 'UTC: ' + utcTime;
                        } else {
                            // If they're the same (user is in UTC), just show UTC
                            element.innerHTML = utcTime + ' <span style="color: #888; font-size: 0.9em;">(UTC)</span>';
                            element.title = duration ? duration : 'UTC: ' + utcTime;
                        }
                    }

                } catch (error) {
                    // If conversion fails, leave the original timestamp
                    console.warn('Failed to convert timestamp:', rawTimestamp, error);
                }
            }

            // Schedule next batch if there are more timestamps
            if (endIndex < timestampElements.length) {
                scheduleWork(function() {
                    processBatch(endIndex);
                });
            }
        }

        // Start processing the first batch
        scheduleWork(function() {
            processBatch(0);
        });
    }

    // Execute immediately - assumes this is included within a DOMContentLoaded handler
    convertTimestampsToLocalTimezone();
})();

            // Parse URL parameters
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    filter: params.get('filter')  // e.g., "user,assistant"
                };
            }

            // Apply filters from URL parameters
            function applyUrlFilters() {
                const urlParams = getUrlParams();

                // Apply message type filter
                if (urlParams.filter) {
                    const types = urlParams.filter.split(',').map(t => t.trim().toLowerCase());

                    // Deactivate all toggles first
                    filterToggles.forEach(toggle => {
                        toggle.classList.remove('active');
                    });

                    // Activate only the specified types
                    types.forEach(type => {
                        const toggle = document.querySelector(`[data-type="${type}"]`);
                        if (toggle) {
                            toggle.classList.add('active');
                        }
                    });

                    // Show filter toolbar if filters are applied
                    filterToolbar.classList.add('visible');
                    filterButton.classList.add('active');
                }
            }

            // Timeline toggle functionality
            if (timelineButton) {
                timelineButton.addEventListener('click', function () {
                    if (window.toggleTimeline) {
                        window.toggleTimeline();
                    }
                });
            }

            // Toggle details functionality
            function updateToggleButton() {
                const allDetails = document.querySelectorAll('details.collapsible-details');
                const openCount = document.querySelectorAll('details[open].collapsible-details').length;
                const totalCount = allDetails.length;

                if (totalCount === 0) {
                    toggleButton.style.display = 'none';
                    return;
                }

                // If more than half are open, show "close all" state, otherwise show "open all"
                const mostlyOpen = openCount > totalCount / 2;
                toggleButton.textContent = mostlyOpen ? 'üì¶' : 'üóÉÔ∏è';
                toggleButton.title = mostlyOpen ? 'Close all details' : 'Open all details';
            }

            function toggleAllDetails() {
                const allDetails = document.querySelectorAll('details.collapsible-details');
                const openCount = document.querySelectorAll('details[open].collapsible-details').length;
                const shouldOpen = openCount <= allDetails.length / 2;

                allDetails.forEach(details => {
                    if (shouldOpen) {
                        details.setAttribute('open', '');
                    } else {
                        details.removeAttribute('open');
                    }
                });

                updateToggleButton();
            }

            toggleButton.addEventListener('click', toggleAllDetails);

            // Filter toolbar toggle functionality
            function toggleFilterToolbar() {
                const isVisible = filterToolbar.classList.contains('visible');
                if (isVisible) {
                    filterToolbar.classList.remove('visible');
                    filterButton.classList.remove('active');
                    filterButton.title = 'Search & Filter';
                } else {
                    filterToolbar.classList.add('visible');
                    filterButton.classList.add('active');
                    filterButton.title = 'Close';
                    // Focus search input when opening
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        setTimeout(() => searchInput.focus(), 100);
                    }
                }
            }

            filterButton.addEventListener('click', toggleFilterToolbar);
            if (closeToolbarButton) {
                closeToolbarButton.addEventListener('click', toggleFilterToolbar);
            }

            // Count messages by type and update button labels
            function updateMessageCounts() {
                const messageTypes = ['user', 'assistant', 'sidechain', 'system', 'thinking', 'image'];

                messageTypes.forEach(type => {
                    const messages = document.querySelectorAll(`.message.${type}:not(.session-header)`);
                    const count = messages.length;
                    const toggle = document.querySelector(`[data-type="${type}"]`);
                    const countSpan = toggle ? toggle.querySelector('.count') : null;

                    if (countSpan) {
                        countSpan.textContent = `(${count})`;

                        // Hide toggles for message types with 0 count
                        if (count === 0) {
                            toggle.style.display = 'none';
                        } else {
                            toggle.style.display = 'flex';
                        }
                    }
                });

                // Handle combined "tool" filter (tool_use + tool_result)
                const toolMessages = document.querySelectorAll(`.message.tool_use:not(.session-header), .message.tool_result:not(.session-header)`);
                const toolCount = toolMessages.length;
                const toolToggle = document.querySelector(`[data-type="tool"]`);
                const toolCountSpan = toolToggle ? toolToggle.querySelector('.count') : null;

                if (toolCountSpan) {
                    toolCountSpan.textContent = `(${toolCount})`;
                    if (toolCount === 0) {
                        toolToggle.style.display = 'none';
                    } else {
                        toolToggle.style.display = 'flex';
                    }
                }
            }

            // Filter functionality
            function applyFilter() {
                const activeTypes = Array.from(filterToggles)
                    .filter(toggle => toggle.classList.contains('active'))
                    .map(toggle => toggle.dataset.type);

                // Expand "tool" to include both tool_use and tool_result
                const expandedTypes = [];
                activeTypes.forEach(type => {
                    if (type === 'tool') {
                        expandedTypes.push('tool_use', 'tool_result');
                    } else {
                        expandedTypes.push(type);
                    }
                });

                // Show/hide messages based on active toggle buttons
                const allMessages = document.querySelectorAll('.message:not(.session-header)');
                allMessages.forEach(message => {
                    let shouldShow = false;

                    // Special handling for sidechain messages
                    if (message.classList.contains('sidechain')) {
                        // For sidechain messages, show if both sidechain filter is active AND their message type filter is active
                        const sidechainActive = expandedTypes.includes('sidechain');
                        const messageTypeActive = expandedTypes.some(type =>
                            type !== 'sidechain' && message.classList.contains(type)
                        );
                        shouldShow = sidechainActive && messageTypeActive;
                    } else {
                        // For non-sidechain messages, show if any of their types are active
                        shouldShow = expandedTypes.some(type => message.classList.contains(type));
                    }

                    if (shouldShow) {
                        message.classList.remove('filtered-hidden');
                    } else {
                        message.classList.add('filtered-hidden');
                    }
                });

                // Update visible counts in real-time
                updateVisibleCounts();

                // Update filter button appearance based on whether all types are selected
                const allTypesSelected = activeTypes.length === filterToggles.length;
                if (!allTypesSelected && filterToolbar.classList.contains('visible')) {
                    filterButton.classList.add('active');
                } else if (allTypesSelected && filterToolbar.classList.contains('visible')) {
                    filterButton.classList.add('active');
                }
            }

            function updateVisibleCounts() {
                const messageTypes = ['user', 'assistant', 'sidechain', 'system', 'thinking', 'image'];

                messageTypes.forEach(type => {
                    const visibleMessages = document.querySelectorAll(`.message.${type}:not(.session-header):not(.filtered-hidden)`);
                    const totalMessages = document.querySelectorAll(`.message.${type}:not(.session-header)`);
                    const visibleCount = visibleMessages.length;
                    const totalCount = totalMessages.length;

                    const toggle = document.querySelector(`[data-type="${type}"]`);
                    const countSpan = toggle ? toggle.querySelector('.count') : null;

                    if (countSpan && totalCount > 0) {
                        // Show "visible/total" format when filtering is active
                        const activeTypes = Array.from(filterToggles)
                            .filter(toggle => toggle.classList.contains('active'))
                            .map(toggle => toggle.dataset.type);

                        const isFiltering = activeTypes.length < filterToggles.length;

                        if (isFiltering && visibleCount !== totalCount) {
                            countSpan.textContent = `(${visibleCount}/${totalCount})`;
                        } else {
                            countSpan.textContent = `(${totalCount})`;
                        }
                    }
                });

                // Handle combined "tool" filter separately
                const visibleToolMessages = document.querySelectorAll(`.message.tool_use:not(.session-header):not(.filtered-hidden), .message.tool_result:not(.session-header):not(.filtered-hidden)`);
                const totalToolMessages = document.querySelectorAll(`.message.tool_use:not(.session-header), .message.tool_result:not(.session-header)`);
                const visibleToolCount = visibleToolMessages.length;
                const totalToolCount = totalToolMessages.length;

                const toolToggle = document.querySelector(`[data-type="tool"]`);
                const toolCountSpan = toolToggle ? toolToggle.querySelector('.count') : null;

                if (toolCountSpan && totalToolCount > 0) {
                    const activeTypes = Array.from(filterToggles)
                        .filter(toggle => toggle.classList.contains('active'))
                        .map(toggle => toggle.dataset.type);

                    const isFiltering = activeTypes.length < filterToggles.length;

                    if (isFiltering && visibleToolCount !== totalToolCount) {
                        toolCountSpan.textContent = `(${visibleToolCount}/${totalToolCount})`;
                    } else {
                        toolCountSpan.textContent = `(${totalToolCount})`;
                    }
                }
            }

            function toggleFilter(button) {
                button.classList.toggle('active');
                applyFilter();
            }

            function selectAllTypes() {
                filterToggles.forEach(toggle => {
                    toggle.classList.add('active');
                });
                applyFilter();
            }

            function selectNoTypes() {
                filterToggles.forEach(toggle => {
                    toggle.classList.remove('active');
                });
                applyFilter();
            }

            // Event listeners for filter toggles
            filterToggles.forEach(toggle => {
                toggle.addEventListener('click', () => toggleFilter(toggle));
            });

            selectAllButton.addEventListener('click', selectAllTypes);
            selectNoneButton.addEventListener('click', selectNoTypes);

            // Initialize button state and message counts
            updateToggleButton();
            updateMessageCounts();

            // Apply URL filters first (if any)
            applyUrlFilters();

            // Apply all filters on page load
            applyFilter();
        });
    </script>
    <!-- Search functionality script -->
    
    <!-- Search Component -->


<script>
(function() {
    // Search state
    let searchState = {
        query: '',
        useRegex: false,
        searchInFiltered: true,
        currentMatchIndex: 0,
        matches: [],
        searchIndex: null,
        isIndexPage: window.location.pathname.includes('index.html') ||
                      window.location.pathname.endsWith('projects/') ||
                      (!window.location.pathname.includes('.html') && window.location.pathname.endsWith('/'))
    };

    // DOM elements
    const searchContainer = document.getElementById('searchContainer');
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');
    const searchHint = document.querySelector('.search-hint');
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    const searchResultCount = document.getElementById('searchResultCount');
    const searchPrev = document.getElementById('searchPrev');
    const searchNext = document.getElementById('searchNext');
    const searchRegex = document.getElementById('searchRegex');
    const searchInFiltered = document.getElementById('searchInFiltered');
    const searchResultsPanel = document.getElementById('searchResultsPanel');
    const searchResultsContent = document.getElementById('searchResultsContent');
    const searchResultsClose = document.getElementById('searchResultsClose');

    // Initialize search
    function initSearch() {
        // Build search index from page content
        buildSearchIndex();

        // Restore previous search state from localStorage
        restoreSearchState();

        // Set up event listeners
        setupEventListeners();

        // Initialize UI state
        updateSearchInputState();
    }

    // Build search index from current page
    function buildSearchIndex() {
        searchState.searchIndex = [];
        
        if (searchState.isIndexPage) {
            // Index page: index projects with individual sessions
            document.querySelectorAll('.project-card').forEach(card => {
                const projectName = card.querySelector('.project-name a')?.textContent || '';
                const projectStats = card.querySelector('.project-stats')?.textContent || '';
                const projectLink = card.querySelector('.project-name a')?.getAttribute('href') || '';
                
                // Index the project itself
                searchState.searchIndex.push({
                    type: 'project',
                    name: projectName,
                    stats: projectStats,
                    element: card,
                    link: projectLink,
                    searchText: `${projectName} ${projectStats}`,
                    originalText: `${projectName} ${projectStats}`
                });
                
                // Index individual sessions within the project
                card.querySelectorAll('.session-link').forEach(link => {
                    const sessionText = link.textContent || '';
                    const sessionHref = link.getAttribute('href') || '';
                    const sessionPreview = link.querySelector('.session-preview')?.textContent?.trim() || '';
                    const sessionMeta = link.querySelector('.session-link-meta')?.textContent || '';
                    
                    searchState.searchIndex.push({
                        type: 'session',
                        projectName: projectName,
                        sessionText: sessionText,
                        sessionPreview: sessionPreview,
                        sessionMeta: sessionMeta,
                        element: card,
                        link: sessionHref,
                        searchText: `${projectName} ${sessionText} ${sessionPreview} ${sessionMeta}`,
                        originalText: `${sessionText} ${sessionPreview}`
                    });
                });
            });
        } else {
            // Transcript page: index messages
            document.querySelectorAll('.message:not(.session-header)').forEach(message => {
                const header = message.querySelector('.header span')?.textContent || '';
                const content = message.querySelector('.content')?.textContent || '';
                const timestamp = message.querySelector('.timestamp')?.textContent || '';
                const sessionId = findSessionForMessage(message);
                
                searchState.searchIndex.push({
                    type: 'message',
                    header: header,
                    content: content,
                    timestamp: timestamp,
                    sessionId: sessionId,
                    element: message,
                    searchText: `${header} ${content}`.toLowerCase(),
                    originalText: `${header} ${content}`
                });
            });
        }
    }

    // Find session ID for a message
    function findSessionForMessage(messageElement) {
        let prev = messageElement.previousElementSibling;
        while (prev) {
            if (prev.classList.contains('session-header')) {
                return prev.id.replace('session-', '');
            }
            prev = prev.previousElementSibling;
        }
        return null;
    }

    // Create excerpt with context around matches
    function createExcerpt(text, query, contextLength = 50) {
        if (!text || !query) return '';
        
        // Create search pattern (always case-insensitive)
        let pattern;
        try {
            if (searchState.useRegex) {
                pattern = new RegExp(query, 'gi');
            } else {
                const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                pattern = new RegExp(escapedQuery, 'gi');
            }
        } catch (e) {
            return text.substring(0, 100) + (text.length > 100 ? '...' : '');
        }

        const matches = [...text.matchAll(pattern)];
        if (matches.length === 0) {
            return text.substring(0, 100) + (text.length > 100 ? '...' : '');
        }

        // Collect all excerpts with context
        const excerpts = [];
        const processedRanges = [];

        matches.forEach(match => {
            const start = Math.max(0, match.index - contextLength);
            const end = Math.min(text.length, match.index + match[0].length + contextLength);
            
            // Check for overlap with existing ranges
            const overlaps = processedRanges.find(range => 
                (start >= range.start && start <= range.end) ||
                (end >= range.start && end <= range.end) ||
                (start <= range.start && end >= range.end)
            );

            if (overlaps) {
                // Extend the existing range
                overlaps.start = Math.min(overlaps.start, start);
                overlaps.end = Math.max(overlaps.end, end);
            } else {
                processedRanges.push({ start, end });
            }
        });

        // Sort by start position and create excerpts
        processedRanges.sort((a, b) => a.start - b.start);
        
        processedRanges.forEach(range => {
            let excerpt = text.substring(range.start, range.end);
            
            // Add ellipsis if needed
            if (range.start > 0) excerpt = '...' + excerpt;
            if (range.end < text.length) excerpt = excerpt + '...';
            
            excerpts.push(excerpt);
        });

        return excerpts.join(' ');
    }

    // Count actual matches in text (always case-insensitive)
    function countMatches(text, query) {
        if (!text || !query) return 0;

        try {
            let pattern;
            if (searchState.useRegex) {
                pattern = new RegExp(query, 'gi');
            } else {
                const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                pattern = new RegExp(escapedQuery, 'gi');
            }

            const matches = text.match(pattern);
            return matches ? matches.length : 0;
        } catch (e) {
            return 0;
        }
    }

    // Toggle search hint and clear button visibility based on input content
    function updateSearchInputState() {
        const hasContent = searchInput && searchInput.value.length > 0;

        // Toggle hint visibility
        if (searchHint) {
            if (hasContent) {
                searchHint.classList.add('hidden');
            } else {
                searchHint.classList.remove('hidden');
            }
        }

        // Toggle clear button visibility
        if (searchClear) {
            if (hasContent) {
                searchClear.classList.add('visible');
            } else {
                searchClear.classList.remove('visible');
            }
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        // Search input
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            updateSearchInputState();
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(e.target.value), 300);
        });

        // Clear button
        searchClear.addEventListener('click', clearSearch);

        // Search options
        searchRegex.addEventListener('change', () => {
            searchState.useRegex = searchRegex.checked;
            if (searchState.query) performSearch(searchState.query);
        });

        searchInFiltered.addEventListener('change', () => {
            searchState.searchInFiltered = searchInFiltered.checked;
            if (searchState.query) performSearch(searchState.query);
        });

        // Navigation buttons
        searchPrev.addEventListener('click', () => navigateMatch(-1));
        searchNext.addEventListener('click', () => navigateMatch(1));

        // Close results panel
        if (searchResultsClose) {
            searchResultsClose.addEventListener('click', () => {
                searchResultsPanel.classList.remove('visible');
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    // Perform search
    let isSearching = false;
    function performSearch(query) {
        // Prevent concurrent searches
        if (isSearching) return;
        isSearching = true;

        searchState.query = query;
        searchClear.classList.toggle('visible', query.length > 0);
        
        // Clear previous highlights
        clearHighlights();
        
        if (!query) {
            searchState.matches = [];
            updateSearchUI();
            if (searchState.isIndexPage && searchResultsPanel) {
                searchResultsPanel.classList.remove('visible');
            }
            isSearching = false;
            return;
        }

        // Save search state
        saveSearchState();
        
        // Create search pattern (always case-insensitive)
        let searchPattern;
        try {
            if (searchState.useRegex) {
                searchPattern = new RegExp(query, 'gi');
            } else {
                const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                searchPattern = new RegExp(escapedQuery, 'gi');
            }
        } catch (e) {
            // Invalid regex
            searchState.matches = [];
            updateSearchUI();
            isSearching = false;
            return;
        }

        // Search through index
        searchState.matches = [];
        let totalMatchCount = 0;
        
        searchState.searchIndex.forEach(item => {
            // Check if element is visible (for transcript pages with filters)
            if (!searchState.isIndexPage && searchState.searchInFiltered) {
                if (item.element.classList.contains('filtered-hidden')) {
                    return;
                }
            }

            // Always use case-insensitive search
            const searchText = item.searchText.toLowerCase();
            const searchQuery = query.toLowerCase();

            // Check if item matches the search
            let matchesItem = false;
            if (searchState.useRegex) {
                searchPattern.lastIndex = 0;  // Reset lastIndex before each test to avoid skipping matches
                matchesItem = searchPattern.test(searchText);
            } else {
                matchesItem = searchText.includes(searchQuery);
            }

            if (matchesItem) {
                // Count actual matches in this item
                const matchCount = countMatches(item.originalText || item.searchText, query);
                totalMatchCount += matchCount;
                
                // Add match count and excerpt to the item
                const matchItem = {
                    ...item,
                    matchCount: matchCount,
                    excerpt: createExcerpt(item.originalText || item.searchText, query)
                };
                
                searchState.matches.push(matchItem);
                
                // Highlight matches in the element
                if (!searchState.isIndexPage) {
                    highlightInElement(item.element, searchPattern);
                }
            }
        });
        
        searchState.totalMatchCount = totalMatchCount;

        searchState.currentMatchIndex = searchState.matches.length > 0 ? 0 : -1;
        updateSearchUI();
        
        // Show results panel for index page
        if (searchState.isIndexPage && searchResultsPanel) {
            displayIndexSearchResults();
        }
        
        // Navigate to first match
        if (searchState.matches.length > 0 && !searchState.isIndexPage) {
            navigateToMatch(0);
        }

        // Reset searching flag
        isSearching = false;
    }

    // Highlight text in element
    function highlightInElement(element, pattern) {
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );

        const textNodes = [];
        let node;
        while (node = walker.nextNode()) {
            if (node.nodeValue.trim()) {
                textNodes.push(node);
            }
        }

        textNodes.forEach(textNode => {
            const text = textNode.nodeValue;
            const matches = [...text.matchAll(pattern)];
            
            if (matches.length > 0) {
                const fragment = document.createDocumentFragment();
                let lastIndex = 0;
                
                matches.forEach(match => {
                    // Add text before match
                    if (match.index > lastIndex) {
                        fragment.appendChild(
                            document.createTextNode(text.substring(lastIndex, match.index))
                        );
                    }
                    
                    // Add highlighted match
                    const span = document.createElement('span');
                    span.className = 'search-highlight';
                    span.textContent = match[0];
                    fragment.appendChild(span);
                    
                    lastIndex = match.index + match[0].length;
                });
                
                // Add remaining text
                if (lastIndex < text.length) {
                    fragment.appendChild(
                        document.createTextNode(text.substring(lastIndex))
                    );
                }
                
                textNode.parentNode.replaceChild(fragment, textNode);
            }
        });
    }

    // Clear all highlights
    function clearHighlights() {
        document.querySelectorAll('.search-highlight').forEach(highlight => {
            const parent = highlight.parentNode;
            parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
            parent.normalize();
        });
    }

    // Navigate between matches
    function navigateMatch(direction) {
        if (searchState.matches.length === 0) return;
        
        searchState.currentMatchIndex += direction;
        
        if (searchState.currentMatchIndex < 0) {
            searchState.currentMatchIndex = searchState.matches.length - 1;
        } else if (searchState.currentMatchIndex >= searchState.matches.length) {
            searchState.currentMatchIndex = 0;
        }
        
        navigateToMatch(searchState.currentMatchIndex);
    }

    // Navigate to specific match
    function navigateToMatch(index) {
        if (index < 0 || index >= searchState.matches.length) return;
        
        // Update current highlight
        document.querySelectorAll('.search-highlight.current').forEach(el => {
            el.classList.remove('current');
        });
        
        const match = searchState.matches[index];
        const highlights = match.element.querySelectorAll('.search-highlight');
        if (highlights.length > 0) {
            highlights[0].classList.add('current');
            highlights[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            match.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        updateSearchUI();
    }

    // Display search results for index page
    function displayIndexSearchResults() {
        if (!searchResultsPanel || !searchResultsContent) return;
        
        searchResultsPanel.classList.add('visible');
        
        if (searchState.matches.length === 0) {
            searchResultsContent.innerHTML = '<div class="search-no-results">No results found</div>';
            return;
        }
        
        // Group results by project and type
        const groupedResults = {};
        searchState.matches.forEach(match => {
            const key = match.projectName || match.name || 'Unknown';
            if (!groupedResults[key]) {
                groupedResults[key] = { projects: [], sessions: [] };
            }
            
            if (match.type === 'project') {
                groupedResults[key].projects.push(match);
            } else if (match.type === 'session') {
                groupedResults[key].sessions.push(match);
            }
        });
        
        let html = '';
        Object.entries(groupedResults).forEach(([projectName, groups]) => {
            const totalMatches = [...groups.projects, ...groups.sessions];
            const totalMatchCount = totalMatches.reduce((sum, match) => sum + match.matchCount, 0);
            
            html += `
                <div class="search-result-group">
                    <div class="search-result-group-title">
                        ${projectName}
                        <span class="search-result-count">${totalMatchCount} matches in ${totalMatches.length} items</span>
                    </div>
            `;
            
            // Show project matches first
            groups.projects.forEach(match => {
                html += `
                    <div class="search-result-item">
                        <a href="${match.link}">
                            <div class="search-result-session">üìÅ Project Overview</div>
                            <div class="search-result-excerpt">
                                ${highlightText(match.excerpt, searchState.query)}
                            </div>
                            <div class="search-result-meta">
                                <span>${match.matchCount} matches</span>
                                <span>${match.stats}</span>
                            </div>
                        </a>
                    </div>
                `;
            });
            
            // Show session matches
            groups.sessions.forEach(match => {
                const sessionId = match.link.split('/').pop().replace('session-', '').replace('.html', '').substring(0, 8);
                html += `
                    <div class="search-result-item">
                        <a href="${match.link}">
                            <div class="search-result-session">üí¨ Session ${sessionId}</div>
                            <div class="search-result-excerpt">
                                ${highlightText(match.excerpt, searchState.query)}
                            </div>
                            <div class="search-result-meta">
                                <span>${match.matchCount} matches</span>
                                <span>${match.sessionMeta}</span>
                            </div>
                        </a>
                    </div>
                `;
            });
            
            html += '</div>';
        });
        
        searchResultsContent.innerHTML = html;
    }

    // Highlight text in search results (always case-insensitive)
    function highlightText(text, query) {
        if (!query) return text;

        const pattern = searchState.useRegex ?
            new RegExp(query, 'gi') :
            new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

        return text.replace(pattern, match => `<span class="search-highlight">${match}</span>`);
    }

    // Update search UI
    function updateSearchUI() {
        const hasMatches = searchState.matches.length > 0;
        
        searchResultsInfo.classList.toggle('visible', hasMatches);
        searchPrev.disabled = !hasMatches;
        searchNext.disabled = !hasMatches;
        
        if (hasMatches) {
            if (searchState.isIndexPage) {
                const totalMatches = searchState.totalMatchCount || searchState.matches.length;
                const conversationCount = searchState.matches.length;
                if (totalMatches > conversationCount) {
                    searchResultCount.textContent = `${totalMatches} matches in ${conversationCount} conversations`;
                } else {
                    searchResultCount.textContent = `${conversationCount} matches`;
                }
            } else {
                searchResultCount.textContent = `${searchState.currentMatchIndex + 1} of ${searchState.matches.length} matches`;
            }
        } else if (searchState.query) {
            searchResultCount.textContent = 'No matches';
        } else {
            searchResultCount.textContent = 'No results';
        }
    }

    // Clear search
    function clearSearch() {
        searchInput.value = '';
        searchState.query = '';
        searchState.matches = [];
        searchState.currentMatchIndex = 0;
        updateSearchInputState();
        clearHighlights();
        updateSearchUI();

        if (searchState.isIndexPage && searchResultsPanel) {
            searchResultsPanel.classList.remove('visible');
        }

        saveSearchState();
    }


    // Handle keyboard shortcuts
    function handleKeyboardShortcuts(e) {
        // Ctrl+F or Cmd+F
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();

            // On transcript pages, open filter toolbar if not visible
            const filterToolbar = document.querySelector('.filter-toolbar');
            if (filterToolbar && !filterToolbar.classList.contains('visible')) {
                // Trigger filter button click to show toolbar
                const filterButton = document.getElementById('filterMessages');
                if (filterButton) filterButton.click();
            }

            // Focus and select search input
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }

        // F3 - Next match
        if (e.key === 'F3') {
            e.preventDefault();
            if (e.shiftKey) {
                navigateMatch(-1);
            } else {
                navigateMatch(1);
            }
        }

        // Escape - Close search results panel on index page
        if (e.key === 'Escape') {
            if (searchState.isIndexPage && searchResultsPanel && searchResultsPanel.classList.contains('visible')) {
                searchResultsPanel.classList.remove('visible');
            }
        }
        
        // Enter - Next match when search input is focused
        if (e.key === 'Enter' && document.activeElement === searchInput) {
            e.preventDefault();
            if (e.shiftKey) {
                navigateMatch(-1);
            } else {
                navigateMatch(1);
            }
        }
    }

    // Save search state to localStorage
    function saveSearchState() {
        const state = {
            query: searchState.query,
            useRegex: searchState.useRegex,
            searchInFiltered: searchState.searchInFiltered
        };
        localStorage.setItem('claudeLogSearchState', JSON.stringify(state));
    }

    // Restore search state from localStorage
    function restoreSearchState() {
        const saved = localStorage.getItem('claudeLogSearchState');
        if (saved) {
            try {
                const state = JSON.parse(saved);
                searchState.useRegex = state.useRegex || false;
                searchState.searchInFiltered = state.searchInFiltered !== false;

                // Update UI
                searchRegex.checked = searchState.useRegex;
                searchInFiltered.checked = searchState.searchInFiltered;
            } catch (e) {
                console.error('Failed to restore search state:', e);
            }
        }
    }

    // Re-index when filters change (for transcript pages)
    if (!searchState.isIndexPage) {
        // Listen for filter changes
        let isUpdatingFilters = false;
        const observer = new MutationObserver((mutations) => {
            // Only react to filtered-hidden class changes, not search highlights
            const hasFilterChange = mutations.some(mutation => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const target = mutation.target;
                    // Check if this is a message element getting filtered
                    return target.classList && target.classList.contains('message');
                }
                return false;
            });

            if (hasFilterChange && !isUpdatingFilters && searchState.query && searchState.searchInFiltered) {
                isUpdatingFilters = true;
                setTimeout(() => {
                    buildSearchIndex();
                    performSearch(searchState.query);
                    isUpdatingFilters = false;
                }, 100);
            }
        });

        // Observe changes to filtered-hidden class
        observer.observe(document.body, {
            attributes: true,
            attributeFilter: ['class'],
            subtree: true
        });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSearch);
    } else {
        initSearch();
    }
})();
</script>
</body>

</html>